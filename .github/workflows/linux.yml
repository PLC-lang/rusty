name: Build Linux

on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
  pull_request:
    branches: [master]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  IMAGE_NAME: rusty

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    container: ghcr.io/plc-lang/rust-llvm:latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Check
        run: |
          ./scripts/build.sh --check

  test-linux:
    name: Test Linux
    runs-on: ${{ matrix.config.os }}
    strategy:
      matrix:
        config:
          - { os: "ubuntu-latest" }
          - { os: "ubuntu-24.04-arm" }
    steps:
      - name: Free up disk space on runner
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - name: Show disk space after cleanup
        run: df -h

      - uses: actions/checkout@v4

      - name: Cargo test
        run: |
          docker run --rm \
            --entrypoint /bin/bash \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/plc-lang/rust-llvm:latest \
            -c "df -h && ./scripts/build.sh --build --test"

  package-linux:
    name: Package Linux (${{ matrix.config.arch }})
    runs-on: ${{ matrix.config.os }}
    strategy:
      matrix:
        config:
          - { os: "ubuntu-latest", arch: "x86_64" }
          - { os: "ubuntu-24.04-arm", arch: "aarch64" }
    container: ghcr.io/plc-lang/rust-llvm:latest
    steps:
      - uses: actions/checkout@v4

      - name: Release Build (native ${{ matrix.config.arch }})
        shell: bash
        run: |
          echo "Building native binary for ${{ matrix.config.arch }}"
          ./scripts/build.sh --build --release --package --deb

      - name: Build and package the std lib
        if: matrix.config.arch == 'x86_64'
        shell: bash
        run: |
          # required by aarch64 build
          apt update && apt install -y gcc-aarch64-linux-gnu

          # Clean up apt cache to free disk space
          apt-get clean
          rm -rf /var/lib/apt/lists/*

          echo "Build command : ./scripts/build.sh --build --release"
          ./scripts/build.sh --build --release --package --deb \
            --target x86_64-linux-gnu,aarch64-linux-gnu,x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu

      - uses: actions/upload-artifact@v4
        with:
          name: plc-${{ matrix.config.arch }}
          path: target/release/plc
          if-no-files-found: error

      - uses: actions/upload-artifact@v4
        if: matrix.config.arch == 'x86_64'
        with:
          name: stdlib
          path: output/

      - uses: actions/upload-artifact@v4
        if: matrix.config.arch == 'x86_64'
        with:
          name: schema
          path: compiler/plc_project/schema/

      - uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.config.arch }}
          path: target/debian/*.deb
          if-no-files-found: warn

  build-and-push-image:
    name: Build Image (${{ matrix.config.arch }})
    runs-on: ${{ matrix.config.os }}
    needs: package-linux
    strategy:
      matrix:
        config:
          - { os: "ubuntu-latest", arch: "x86_64", docker_arch: "amd64" }
          - { os: "ubuntu-24.04-arm", arch: "aarch64", docker_arch: "arm64" }
    permissions:
      actions: read
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Download deb artifacts (x86_64)
        uses: actions/download-artifact@v4
        with:
          name: deb-x86_64
          path: artifacts/deb-x86_64/

      - name: Download deb artifacts (aarch64)
        uses: actions/download-artifact@v4
        with:
          name: deb-aarch64
          path: artifacts/deb-aarch64/

      - name: Prepare deb artifacts
        run: |
          mkdir -p artifacts/deb
          # Debug: show artifact structure
          echo "Artifact structure:"
          find artifacts/ -name "*.deb" -type f
          # Copy the plc binary deb for this image's architecture only
          find artifacts/deb-${{ matrix.config.arch }}/ -name "plc_*_${{ matrix.config.docker_arch }}.deb" -exec cp {} artifacts/deb/ \;
          # Copy libiec61131std debs for BOTH architectures (cross-compilation support)
          find artifacts/deb-x86_64/ -name "libiec61131std_*_amd64.deb" -exec cp {} artifacts/deb/ \;
          find artifacts/deb-aarch64/ -name "libiec61131std_*_arm64.deb" -exec cp {} artifacts/deb/ \;
          
          # Validate that expected files were copied
          echo "Deb packages for Docker image (${{ matrix.config.docker_arch }}):"
          ls -la artifacts/deb/
          if [ -z "$(ls -A artifacts/deb/*.deb 2>/dev/null)" ]; then
            echo "ERROR: No deb files were copied to artifacts/deb/"
            exit 1
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker buildx build . \
            --platform linux/${{ matrix.config.docker_arch }} \
            --file Dockerfile \
            --tag ${{ env.IMAGE_NAME }}:local \
            --load

      - name: Log in to registry
        if: |
          github.event_name == 'workflow_dispatch' ||
          (github.event_name != 'pull_request' && github.ref == 'refs/heads/master')
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push image with temp tag
        if: |
          github.event_name == 'workflow_dispatch' ||
          (github.event_name != 'pull_request' && github.ref == 'refs/heads/master')
        run: |
          IMAGE_ID=ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
          TEMP_TAG="build-${{ github.run_id }}-${{ matrix.config.arch }}"

          docker tag ${{ env.IMAGE_NAME }}:local $IMAGE_ID:$TEMP_TAG
          docker push $IMAGE_ID:$TEMP_TAG
          echo "Pushed: $IMAGE_ID:$TEMP_TAG"

      - name: Simulate push (PR only)
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          echo "=========================================="
          echo "SIMULATION MODE (Pull Request)"
          echo "Would push: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:build-${{ github.run_id }}-${{ matrix.config.arch }}"
          echo "Platform: linux/${{ matrix.config.docker_arch }}"
          echo "=========================================="

  push-multiplatform:
    name: Push Multiplatform Manifest
    needs: build-and-push-image
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name != 'pull_request' && github.ref == 'refs/heads/master')
    permissions:
      packages: write
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest
        run: |
          IMAGE_ID=ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')

          echo "Creating multiplatform manifest..."
          docker buildx imagetools create \
            -t $IMAGE_ID:latest \
            $IMAGE_ID:build-${{ github.run_id }}-x86_64 \
            $IMAGE_ID:build-${{ github.run_id }}-aarch64

          echo "Pushed: $IMAGE_ID:latest"

      - name: Cleanup temp tags
        if: always()
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IMAGE_ID=ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')

          # Delete temp images by tag
          for ARCH in x86_64 aarch64; do
            TEMP_TAG="build-${{ github.run_id }}-$ARCH"
            echo "Deleting $TEMP_TAG..."

            # Get version ID for this tag
            VERSION_ID=$(gh api \
              -H "Accept: application/vnd.github+json" \
              "/orgs/${{ github.repository_owner }}/packages/container/${{ env.IMAGE_NAME }}/versions" \
              --jq ".[] | select(.metadata.container.tags[] == \"$TEMP_TAG\") | .id")

            if [ -n "$VERSION_ID" ]; then
              gh api --method DELETE \
                -H "Accept: application/vnd.github+json" \
                "/orgs/${{ github.repository_owner }}/packages/container/${{ env.IMAGE_NAME }}/versions/$VERSION_ID" || true
              echo "Deleted version $VERSION_ID"
            fi
          done

          echo "Cleanup complete"

  style:
    name: Check Style
    runs-on: ubuntu-latest
    container: ghcr.io/plc-lang/rust-llvm:latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Checks
        run: |
          ./scripts/build.sh --check-style

  coverage:
    name: Run Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space on runner
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - name: Show disk space after cleanup
        run: df -h

      - uses: actions/checkout@v4

      - name: Run coverage in container
        run: |
          docker run --rm \
            --entrypoint /bin/bash \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/plc-lang/rust-llvm:latest \
            -c "df -h && apt-get clean && rm -rf /var/lib/apt/lists/* && ./scripts/build.sh --coverage"

      - name: Upload to codecov.io
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info

      - name: Archive code coverage results
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-report
          path: lcov.info

  update-latest:
    name: Update Latest Pre-release
    needs: [package-linux]
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.ref == 'refs/heads/master' && github.event_name != 'pull_request')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare assets
        run: |
          # Debug: show artifact structure
          echo "Artifact structure:"
          find artifacts/ -type f
          # Copy plc binaries - find them regardless of subdirectory structure
          find artifacts/plc-x86_64/ -name "plc" -type f -exec cp {} plc-x86_64 \;
          chmod +x plc-x86_64
          find artifacts/plc-aarch64/ -name "plc" -type f -exec cp {} plc-aarch64 \;
          chmod +x plc-aarch64
          
          # Validate binaries were copied
          if [ ! -f plc-x86_64 ] || [ ! -f plc-aarch64 ]; then
            echo "ERROR: Missing plc binaries"
            ls -la plc-* 2>/dev/null || echo "No plc-* files found"
            exit 1
          fi

      - name: Update latest pre-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete existing latest release if present
          gh release delete latest --yes --repo ${{ github.repository }} 2>/dev/null || true
          git tag -f latest
          git push -f origin latest

          # Collect all deb files
          mkdir -p debs
          find artifacts/deb-x86_64/ -name "*.deb" -type f -exec cp {} debs/ \;
          find artifacts/deb-aarch64/ -name "*.deb" -type f -exec cp {} debs/ \;
          
          # Validate deb files were copied
          if [ -z "$(ls -A debs/*.deb 2>/dev/null)" ]; then
            echo "ERROR: No deb files found in debs/"
            exit 1
          fi
          
          # Verify we have the expected files
          echo "Release assets:"
          ls -la plc-x86_64 plc-aarch64 debs/

          gh release create latest \
            --repo ${{ github.repository }} \
            --title "Latest Build" \
            --notes "Rolling build from master (${{ github.sha }})" \
            --prerelease \
            plc-x86_64 \
            plc-aarch64 \
            debs/*.deb
