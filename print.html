<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>RuSTy User Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">RuSTy User Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rusty"><a class="header" href="#rusty">RuSTy</a></h1>
<p>RuSTy is a <a href="https://en.wikipedia.org/wiki/Structured_text">structured text (ST)</a> compiler written in Rust and based on the LLVM compiler backend.
We use the <a href="https://crates.io/crates/logos/0.8.0"><em>logos</em></a> crate library to perform lexical analysis before the custom parser runs.
RuSTy puts out static or shared objects as well as LLVM IR or bitcode by the flip of a command line flag.
We are aiming towards an open-source industry-grade ST compiler supporting at least the features in 2nd edition IEC 61131 standard.</p>
<p>You might also want to refer to the <a href="api/rusty/">API documentation</a>.</p>
<h2 id="supported-language-concepts"><a class="header" href="#supported-language-concepts">Supported Language Concepts</a></h2>
<h3 id="pous"><a class="header" href="#pous">POUs</a></h3>
<ul>
<li>✔ Program</li>
<li>✔ Function</li>
<li>✔ FunctionBlock</li>
<li>✔ Action</li>
</ul>
<h3 id="datatypes"><a class="header" href="#datatypes">Datatypes</a></h3>
<ul>
<li>✔ IEC 61131-3 numeric types</li>
<li>✔ Strings</li>
<li>✔ Wide Strings</li>
<li>✔ Struct types</li>
<li>✔ Enum types</li>
<li>✔ Array data types</li>
<li>✔ Alias types</li>
<li>✔ Sub-ranges types</li>
<li>✔ Date and Time types</li>
<li>✔ Sized String types</li>
<li>✔ Sized Wide String types</li>
<li>✔ Initial values</li>
</ul>
<h3 id="declarations"><a class="header" href="#declarations">Declarations</a></h3>
<ul>
<li>✔ VAR</li>
<li>✔ VAR_INPUT</li>
<li>✔ VAR_INPUT {ref}</li>
<li>✔ VAR_OUTPUT</li>
<li>✔ VAR_IN_OUT</li>
</ul>
<h3 id="statements"><a class="header" href="#statements">Statements</a></h3>
<ul>
<li>✔ Assignments</li>
<li>✔ Call statements</li>
<li>✔ Implicit call arguments</li>
<li>✔ Explicit call arguments</li>
<li>✔ EXIT, CONTINUE statements</li>
</ul>
<h3 id="control-structures"><a class="header" href="#control-structures">Control Structures</a></h3>
<ul>
<li>✔ IF Statement</li>
<li>✔ CASE Statement</li>
<li>✔ FOR Loops</li>
<li>✔ WHILE Loops</li>
<li>✔ REPEAT Loops</li>
<li>✔ RETURN statement</li>
</ul>
<h3 id="expressions"><a class="header" href="#expressions">Expressions</a></h3>
<ul>
<li>✔ Arithmetic Operators</li>
<li>✔ Relational Operators</li>
<li>✔ Logical Operators</li>
<li>✔ Bitwise Operators</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build--install"><a class="header" href="#build--install">Build &amp; Install</a></h1>
<p>RuSTys code can be found on <a href="https://github.com/PLC-lang/rusty">GitHub</a>.
By default a <code>Dockerfile</code> and a <code>devcontainer.json</code> file are provided. If you wish to develop natively
however, you will need some additional dependencies namely:</p>
<ul>
<li><a href="https://www.rust-lang.org/tools/install">Rust</a></li>
<li>LLVM 14</li>
<li>LLVM Polly</li>
<li>Build Tools (e.g. <code>build-essential</code> on Ubuntu)</li>
<li>zlib</li>
</ul>
<p>The next sections cover how to install these dependencies on different platforms, if you already have them
however, RuSTy can be build using the <code>cargo</code> command. For debug builds this can be accomplished by executing
<code>cargo build</code> and for release builds (smaller &amp; faster) you would execute <code>cargo build --release</code>. The
resulting binaries can be found at <code>target/debug/plc</code> and <code>target/release/plc</code> respectively.</p>
<h2 id="ubuntu-2404"><a class="header" href="#ubuntu-2404">Ubuntu (24.04)</a></h2>
<p>The specified dependencies can be installed with the following command on Ubuntu:</p>
<pre><code class="language-bash">sudo apt install                \
    build-essential             \
    llvm-14-dev liblld-14-dev   \
    libz-dev                    \
    lld                         \
    libclang-common-14-dev      \
    libpolly-14-dev
</code></pre>
<p>Additionally you <em>might</em> need <code>libffi7</code>, which can be installed with <code>sudo apt install libffi7</code>.
<strong>Note</strong>: On other Ubuntu versions, the required packages <em>may</em> differ.</p>
<h2 id="debian"><a class="header" href="#debian">Debian</a></h2>
<p>Same as Ubuntu with the exception of adding additional repository sources since Debian 11 only includes LLVM packages up to version 11.
To do so follow the <a href="https://apt.llvm.org/">official documentation</a>.</p>
<h2 id="macos"><a class="header" href="#macos">MacOS</a></h2>
<p>On MacOS you need to install the <a href="https://developer.apple.com/downloads/"><code>Xcode Command Line Tools</code></a> and the LLVM toolchain using <a href="https://brew.sh">Homebrew</a>:</p>
<pre><code class="language-bash">brew install llvm@14
</code></pre>
<p>While optional, it is strongly recommended to also install <code>gnu-getopt</code> and <code>lit</code> so the helper scripts and integration tests work without extra steps:</p>
<pre><code class="language-bash">brew install gnu-getopt lit
</code></pre>
<p><code>gnu-getopt</code> is required by the build scripts, and <code>lit</code> is needed for running integration tests via <code>./scripts/build.sh --lit</code>.</p>
<p>After the installation, make sure the Homebrew binaries are discoverable for both LLVM and GNU getopt:</p>
<pre><code class="language-bash">echo 'export PATH="/opt/homebrew/opt/llvm@14/bin:$PATH"' &gt;&gt; ~/.zshrc
echo 'export PATH="/opt/homebrew/opt/gnu-getopt/bin:$PATH"' &gt;&gt; ~/.zshrc
</code></pre>
<p>The <code>lit</code> test suite expects <code>FileCheck-14</code> to be available. If <code>FileCheck-14</code> is not already present, create a symlink to the <code>FileCheck</code> binary:</p>
<pre><code class="language-bash">ln -svf /opt/homebrew/opt/llvm@14/bin/FileCheck /opt/homebrew/opt/llvm@14/bin/FileCheck-14
</code></pre>
<h2 id="windows"><a class="header" href="#windows">Windows</a></h2>
<p>Compiling RuSTy on Windows requires three dependencies:</p>
<ol>
<li>Windows 10 SDK</li>
<li>MSVC (at the point of writing this we tested it on v142 - VS 2019 C++ x64/x86 build tools)</li>
<li><a href="https://github.com/PLC-lang/llvm-package-windows/releases/tag/v14.0.6">LLVM 14.0.6</a></li>
</ol>
<p>The first two dependencies are typically installed during the Rust installation itself. More specifically during the
installation you should have been prompted to install them. If not, you'll be able to install them via Visual Studio at any point.
The third dependency is based on a custom build which is hosted on <a href="https://github.com/PLC-lang/llvm-package-windows/releases/tag/v14.0.6">GitHub</a>.
Download it, extract it and add the <code>bin/</code> directory to your <a href="https://docs.oracle.com/en/database/oracle/machine-learning/oml4r/1.5.1/oread/creating-and-modifying-environment-variables-on-windows.html">environment variables</a>.
In theory this should cover everything to be able to compile RuSTy (with some reboots here and there).</p>
<h2 id="installing"><a class="header" href="#installing">Installing</a></h2>
<p><em>TODO</em></p>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<ul>
<li>Because of weak compatibility guarantees of the LLVM API, the LLVM installation must exactly match the
major version of the <code>llvm-sys</code> crate.Currently you will need to install LLVM 14 to satisfy this constraint.
<a href="https://crates.io/crates/llvm-sys">Read more</a></li>
<li>To avoid installation conflicts on Linux/Ubuntu, make sure you don't have a default installation available
(like you get by just installing <code>llvm-dev</code>), which may break things. If you do, make sure you have set
the appropriate environment variable (<code>LLVM_SYS_140_PREFIX=/usr/lib/llvm-14</code> for LLVM 14), so
the build of the <code>llvm-sys</code> crate knows what files to grab.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-rusty"><a class="header" href="#using-rusty">Using RuSTy</a></h1>
<blockquote>
<p>The RuSTy compiler binary is called <code>plc</code></p>
</blockquote>
<p><code>plc</code> offers a comprehensive help via the <code>-h</code> (<code>--help</code>) option.
<code>plc</code> takes one output-format parameter and any number of input-files.
The input files can also be written as <a href="https://en.wikipedia.org/wiki/Glob_(programming)">glob patterns</a>.</p>
<p><code>plc [OPTIONS] &lt;input-files&gt;... &lt;--ir|--shared|--pic|--static|--bc&gt;</code></p>
<p>Note that you can only specify at most one output format.
In the case that no output format switch has been specified, the compiler will select <code>--static</code> by default.</p>
<p>Similarly, if you do not specify an output filename via the <code>-o</code> or <code>--output</code> options,
the output filename will consist of the first input filename, but with an appropriate
file extension depending on the output file format.</p>
<p>A minimal invocation looks like this:
<code>plc input.st</code> this will take in the file <code>input.st</code> and compile it into a static object that will be written to a file named <code>input.o</code>.</p>
<p>More examples:</p>
<ul>
<li><code>plc --ir file1.st file2.st</code> will compile file1.st and file2.st.</li>
<li><code>plc --ir file1.cfc file2.st</code> will compile file1.cfc and file2.st.</li>
<li><code>plc --ir src/*.st</code> will compile all ST files in the src-folder.</li>
<li><code>plc --ir "**/*.st"</code> will compile all ST-files in the current folder and its subfolders recursively.</li>
</ul>
<h2 id="example-building-a-hello-world-program"><a class="header" href="#example-building-a-hello-world-program">Example: Building a hello world program</a></h2>
<h3 id="writing-the-code"><a class="header" href="#writing-the-code">Writing the code</a></h3>
<p>We want to print something to the terminal, so we're going to declare external functions for that.
This example is available under <code>examples/hello_world.st</code> in the main RuSTy repository.</p>
<ul>
<li><code>main</code> is our entry point to the program.</li>
<li>To link the program, we are going to use the system's linker using the <code>--linker=cc</code> argument.</li>
<li>On Windows and MacOS, replace this with <code>--linker=clang</code> as cc is usually not available.</li>
</ul>
<pre><code class="language-iecst">{external}
FUNCTION puts : DINT
VAR_INPUT {ref}
    text : STRING;
END_VAR
END_FUNCTION

FUNCTION main : DINT
    puts('hello, world!$N');
END_FUNCTION
</code></pre>
<h3 id="compiling-with-rusty"><a class="header" href="#compiling-with-rusty">Compiling with RuSTy</a></h3>
<p>The RuSTy command line interface is similar to that of other compilers.</p>
<p>If you just want to build an object file, then do this:</p>
<pre><code class="language-bash">plc -c hello_world.st -o hello_world.o
</code></pre>
<h3 id="optimization"><a class="header" href="#optimization">Optimization</a></h3>
<p><code>plc</code> offers 4 levels of optimization which correspond to the levels established by llvm respectively <a href="https://clang.llvm.org/docs/CommandGuide/clang.html#code-generation-options">clang</a> (<code>none</code> to <code>aggressive</code>, respectively <code>-O0</code> to <code>-O3</code>).</p>
<p>To use an optimization, the flag <code>-O</code> or <code>--optimization</code> is required:</p>
<ul>
<li><code>plc -c "**/*.st" -O none</code></li>
<li><code>plc -c "**/*.st" -O less</code></li>
<li><code>plc -c "**/*.st" -O default</code></li>
<li><code>plc -c "**/*.st" -O aggressive</code></li>
</ul>
<p>By default <code>plc</code> will use <code>default</code> which corresponds to clang's <code>-O2</code>.</p>
<h3 id="linking-an-executable"><a class="header" href="#linking-an-executable">Linking an executable</a></h3>
<p>Instead, you can also compile this into an executable and run it:</p>
<pre><code class="language-bash">plc hello_world.st -o hello_world --linker=cc
./hello_world
</code></pre>
<p>Please note that RuSTy will attempt to link the generated object file by default to generate an executable if you didn't specify something else (option <code>-c</code>).</p>
<ul>
<li>The <code>--linker=cc</code> flag tells RuSTy that it should link with the system's compiler driver  instead of the built in linker. This provides support to create executables.</li>
<li>Additional libraries can be linked using the <code>-l</code> flag, additional library paths can be added with <code>-L</code></li>
<li>You add library search paths by providing additional <code>-L /path/...</code> options. By default, this will be the current directory.</li>
<li>The linker will prefer a dynamically linked library if available, and revert to a static one otherwise.</li>
</ul>
<h3 id="building-for-separate-targets"><a class="header" href="#building-for-separate-targets">Building for separate targets</a></h3>
<p>RuSTy supports building for multiple targets by specifing the <code>--target</code> and optionally the <code>--sysroot</code> command.</p>
<ul>
<li>Multiple targets and sysroot can be specified for the compilation simply by adding additional <code>--target</code> and <code>--sysroot</code> entries.</li>
</ul>
<h3 id="--target"><a class="header" href="#--target">--target</a></h3>
<p>To build and compile <a href="https://en.wikipedia.org/wiki/Structured_text">structured text</a> for the rigth platform we need to specify the <code>target</code>.
As RuSTy is using <a href="https://en.wikipedia.org/wiki/LLVM">LLVM</a> a target-tripple supported by LLVM needs to be selected.
The default <code>target</code> is the host machine's target.
So if a dev container on an <code>x86_64-docker</code> is used the target is <code>x86_64-linux-gnu</code>.</p>
<h3 id="--sysroot"><a class="header" href="#--sysroot">--sysroot</a></h3>
<p><code>plc</code> use the <code>sysroot</code> option for linking purposes.
It is considered to be the root directory for the purpose of locating headers and libraries.</p>
<ul>
<li>If a target and sysroot are provided, the output will always be stored in a folder with the target name (e.g. an <code>x86_64-linux-gnu</code> target will have the output strored in a folder called <code>x86_64-linux-gnu</code>)</li>
<li><code>--sysroot</code> parameters have to always match target parameters, there can be no <code>sysroot</code> without a target.</li>
</ul>
<h2 id="parallel-compilation"><a class="header" href="#parallel-compilation">Parallel Compilation</a></h2>
<p>By default, <code>plc</code> uses parallel compilation.</p>
<p>This option can be controlled with the <code>-j</code> or <code>--threads</code> flag. A value above <code>0</code> will indicate the number of threads to use for the compilation
Leaving the value unset, setting it to <code>0</code> or simply specifying <code>-j</code> sets the value to the maximum threads that can run for the current machine.
This is determined by the underlying parallelisation library <a href="https://crates.io/crates/rayon">Rayon</a></p>
<h3 id="single-module-compilation"><a class="header" href="#single-module-compilation">Single module Compilation</a></h3>
<p>With the introducton of parallel compilation, every unit is compiled into an object file independently and then linked together in a single module.
This behaviour might not always be desired and can be disabled using the <code>--single-module</code> flag.</p>
<blockquote>
<p>Note that the single module flag is currently much slower to produce as it requires first generating all modules and then merging them together.</p>
</blockquote>
<h2 id="configuration-options"><a class="header" href="#configuration-options">Configuration Options</a></h2>
<p><code>plc</code> supports different configuration options, these can be printed using the <code>config</code> subcommand</p>
<h3 id="config-schema"><a class="header" href="#config-schema"><code>config schema</code></a></h3>
<p>Outputs the json schema used for the validation of the <code>plc.json</code> file</p>
<h3 id="config-diagnostics"><a class="header" href="#config-diagnostics"><code>config diagnostics</code></a></h3>
<p>Ouputs a json file with the default error severity configuration for the project.
See <a href="./error_configuration.html">Error Configuration</a> for more information.</p>
<h2 id="project-wide-initialization"><a class="header" href="#project-wide-initialization">Project-wide initialization</a></h2>
<p>When your code is compiled, the compiler creates a special initialization function with the naming pattern <code>__init___&lt;projectname&gt;</code>. This function is responsible for calling all implicit and user-defined initialization code, including all <a href="../pous.html#function_block-initialization"><code>FB_INIT</code></a> methods.</p>
<p><code>&lt;projectname&gt;</code> is either taken directly from the <code>plc.json</code>'s <code>name</code> field or derived from the first input file (replacing <code>.</code>/<code>-</code> with <code>_</code>) when compiling without a <code>plc.json</code> (e.g. <code>plc prog.st ...</code> would yield <code>__init___prog_st</code>).</p>
<p>This function is added to the global constructor list, therefore loading the binary will automatically call the <code>__init___&lt;projectname&gt;</code> function (and therefore your <code>&lt;FunctionBlockName&gt;__FB_INIT</code> function) when an instance of your function block is created, before any other methods are called. This allows you to set default values or perform required setup for your function block.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> The global constructor initialization is currently only supported for <code>x86</code> ISAs. To make sure initialization code runs reliably regardless of target-architecture, ensure your runtime calls this function before starting main task execution.
If you're using the executable without a runtime, you <strong>must</strong> ensure that <code>__init___&lt;projectname&gt;</code> is called before any other code runs. Failure to do so will result in uninitialized function blocks and pointers, which can lead to undefined behavior and/or crashes.</p>
</blockquote>
<p>Example of ensuring initialization when using C (crt0):</p>
<pre><code class="language-c">int main() {
    // Call the project initialization function first
    __init___myproject();
    
    // Now it's safe to start cyclic execution
    for (;;) {
        mainProg();
    }
    
    return 0;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-configuration"><a class="header" href="#build-configuration">Build Configuration</a></h1>
<p>In addition to the comprehensive help, <code>plc</code> offers a build subcommand that simplifies the build process. </br>
Instead of having numerous inline arguments, using the build subcommand along with a build description file makes passing the arguments easier. </br>
The build description file needs to be saved in the <a href="https://en.wikipedia.org/wiki/JSON">json</a> format.</p>
<p>Usage:
<code>plc build</code></p>
<p>Note that if <code>plc</code> cannot find the <code>plc.json</code> file, it will throw an error and request the path.
The default location for the build file is the current directory.</p>
<p>The command for building with an additional path looks like this:
<code>plc build src/plc.json</code></p>
<h2 id="build-description-file-plcjson"><a class="header" href="#build-description-file-plcjson">Build description file (plc.json)</a></h2>
<p>For the build description file to work, it must be written in the <a href="https://en.wikipedia.org/wiki/JavaScript_Object_Notation">json</a> format.
All the keys used in the build description file are described in the following sections.</p>
<h3 id="files"><a class="header" href="#files">files</a></h3>
<p>The keyword <code>files</code> is the equivalent to the <code>input</code> parameter, which adds all the <code>ST</code> files that need to be compiled.</p>
<p>The value of <code>files</code> is an array of strings, definied as follows:</p>
<pre><code class="language-json">"files" : [
    "examples/hello_world.st",
    "examples/hw.st"
    "examples/*.gvl"
]
</code></pre>
<h3 id="libraries"><a class="header" href="#libraries">libraries</a></h3>
<p>To link several objects into one executable <code>plc</code> has the option to add libraries and automatically build and link them together.</br>
The <code>libraries</code> keyword is optional.</p>
<pre><code class="language-json">"libraries" : [
    {
        "name" : "iec61131std",
        "path" : "path/to/lib/",
        "package" : "Copy",
        "include_path" : [
            "examples/hw.st",
            "examples/hello_world.st"
        ]
    }
]
</code></pre>
<h3 id="output"><a class="header" href="#output">output</a></h3>
<p>Similarly to specifying an output file via the <code>-o</code> or <code>--output</code> option using the command line, in the build file we use <code>"output" : "output.so"</code> to define the output file. The default location is the current build directory. (see <a href="using_rusty/build_configuration.html#build-location">Build Location</a>).</p>
<h3 id="compile_type"><a class="header" href="#compile_type">compile_type</a></h3>
<p>The following options can be used for the <code>compile_type</code> :</p>
<ul>
<li><code>Static</code> specifies that linking/binding must be done at compile time.</li>
<li><code>Shared</code> (dynamic) specifies that linking/bingind must be done dynamically (at runtime).</li>
<li><code>PIC</code> Position Independent Code (Choosing this option implies that the linking will be done dynamically).</li>
<li><code>Relocatable</code> generates relocatable object code (for combining with other object code).</li>
<li><code>Bitcode</code> adds bitcode alongside machine code in executable file.</li>
<li><code>IR</code> intermediate <code>llvm</code> representation.</li>
</ul>
<p>The compile format is specified in the build description file as follows:  <code>"compile_type" : "Shared"</code>.
The <code>compile_type</code> keyword is optional.</p>
<h3 id="package_commands"><a class="header" href="#package_commands">package_commands</a></h3>
<p>The <code>package_commands</code> keyword is optional.</p>
<blockquote>
<p>TODO</p>
</blockquote>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<pre><code class="language-json">{
    "files" : [
        "examples/hw.st",
        "examples/hello_world.st",
        "examples/ExternalFunctions.st",
        "examples/*.dt"
    ],
    "compile_type" : "Shared",
    "output" : "proj.so",
    "libraries" : [
        {
            "name" : "iec61131std",
            "path" : "path/to/lib",
            "package" : "Copy",
            "include_path" : [
                "examples/lib.st"
            ]
        },
        {
            "name" : "other_lib",
            "path" : "path/to/lib",
            "package" : "System",
            "include_path" : [
                "examples/hello_world.st"
            ]
        }
    ]
}
</code></pre>
<h2 id="build-parameters"><a class="header" href="#build-parameters">Build Parameters</a></h2>
<p>The <code>build</code> subcommand exposes the following optional parameters:</p>
<h3 id="--build-location"><a class="header" href="#--build-location"><code>--build-location</code></a></h3>
<p>The build location is the location all build files will be copied to. </br>
By default the build location is the <code>build</code> folder in the root of the project (the location of the <code>plc.json</code>).</br>
This can be overriden with the <code>--build-location</code> command line parameter.</p>
<h3 id="--lib-location"><a class="header" href="#--lib-location"><code>--lib-location</code></a></h3>
<p>The lib location is where all libraries marked with <code>Copy</code> will be copied. </br>
By default it is the same as the <code>build-location</code>.</br>
This can be overriden with the <code>--lib-location</code> command line parameter.</p>
<h2 id="environment-variables"><a class="header" href="#environment-variables">Environment Variables</a></h2>
<p>Environment variables can be used inside the build description file, the variables are evaluated before an entry is evaluated.</p>
<p>In addition to externally defined variables, the build exports variables that can be referenced in the description file:</p>
<h3 id="project_root"><a class="header" href="#project_root"><code>PROJECT_ROOT</code></a></h3>
<p>The folder containing the <code>plc.json</code> file, i.e. the root of the project.</p>
<h3 id="arch"><a class="header" href="#arch"><code>ARCH</code></a></h3>
<p>The target architecture currently being built, for a multi architecture build.
The value for <code>ARCH</code> will be updated for every target.</p>
<p>Example targets are:
<code>x86_64-pc-linux-gnu</code>, <code>x86_64-pc-windows-msvc</code>, <code>aarch64-pc-linux-musl</code></p>
<h3 id="build_location"><a class="header" href="#build_location"><code>BUILD_LOCATION</code></a></h3>
<p><code>BUILD_LOCATION</code> is the folder where the build will be saved.
This is the value of either the <a href="using_rusty/build_configuration.html#build-location"><code>--build-location</code></a> parameter or the default build location.</p>
<h3 id="lib_location"><a class="header" href="#lib_location"><code>LIB_LOCATION</code></a></h3>
<p><code>LIB_LOCATION</code> is the folder where the lib will be saved.
This is the value of either the <a href="using_rusty/build_configuration.html#lib-location"><code>--lib-location</code></a> parameter or the <a href="using_rusty/build_configuration.html#build-location">build location</a>.</p>
<h3 id="usage"><a class="header" href="#usage">Usage</a></h3>
<p>To reference an environment variable in the description file, reference the variables with a preceding <code>$</code>.</p>
<p><strong>Example:</strong></p>
<pre><code class="language-json">{
 "name" : "mylib",
 "path" : "$ARCH/lib",
 "package" : "System",
 "include_path" : [
  "examples/hello_world.st"
 ]
}
</code></pre>
<h2 id="validation"><a class="header" href="#validation">Validation</a></h2>
<p>The build description file uses a <a href="https://json-schema.org/">Json Schema</a> file located at <code>compiler/plc_project/schema/plc-json.schema</code> to validate the build description before build.
In order for the schema to be used, it has to be either in that location for source builds or copied next to the build binaries.
If the schema is not found, the schema based validation will be skipped.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="error-configuration"><a class="header" href="#error-configuration">Error Configuration</a></h1>
<p>Errors in a <code>plc</code> project can be configured by providing a json configuration file.
A diagnostics severity can be changed for example from <code>warning</code> to <code>error</code> or <code>info</code> and vice-versa or <code>ignore</code>d completely.
To see a default error configuration use <code>plc config diagnostics</code>.
To provide a custom error configuration use <code>plc --error-config &lt;custom.json&gt;</code>.
Note that the <code>--error-config</code> command can be used with all subcommands such as <code>build</code> and <code>check</code>.
Running <code>plc config diagnostics --error-config &lt;custom.json&gt;</code> will print out the full diagnostics configuration taking the provided overrides into account.</p>
<h2 id="error-description"><a class="header" href="#error-description">Error Description</a></h2>
<p>Errors produced by <code>plc</code> can be explained using the <code>plc explain &lt;ErrorCode&gt;</code> command.
Error codes are usually provided in the diagnostic report.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="general-error"><a class="header" href="#general-error">General Error</a></h1>
<p>This error is a catch all error. It is usually thrown when no other error better matches the case.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="general-io-error"><a class="header" href="#general-io-error">General IO Error</a></h1>
<p>This error describes a problem during an IO operation such as reading or writing a file.
It is usually accompanied by an internal error with further details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="parameter-error"><a class="header" href="#parameter-error">Parameter Error</a></h1>
<p>This error describes a problem with the command parameters, such as a file required for the compilation not being found.:</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="duplicate-symbol"><a class="header" href="#duplicate-symbol">Duplicate Symbol</a></h1>
<p>The marked symbol has been defined multiple times.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="generic-llvm-error"><a class="header" href="#generic-llvm-error">Generic LLVM Error</a></h1>
<p>An unexpected error occurred during the LLVM generation phase.
This is usually a follow up problem from a different diagnostics.
If it occurrs without a previous diagnostics please file a bug report.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="missing-token"><a class="header" href="#missing-token">Missing Token</a></h1>
<p>During the parsing phase, an additional <em>Token</em> (Element) was required to correctly interpret the code.
The error message usually indicates what Token was missing.</p>
<h2 id="example-1"><a class="header" href="#example-1">Example</a></h2>
<p>In the following example the name (Identifier) of the program is missing.</p>
<pre><code class="language-iecst">PROGRAM (*name*)
END_PROGRAM
</code></pre>
<pre><code>error: Unexpected token: expected Identifier but found END_PROGRAM
  ┌─ example.st:2:1
  │
2 │ END_PROGRAM
  │ ^^^^^^^^^^^ Unexpected token: expected Identifier but found END_PROGRAM
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unexpected-token"><a class="header" href="#unexpected-token">Unexpected Token</a></h1>
<p>During parsing, a <em>Token</em> (Element) was encountered in the wrong location. This could be an indication of a missused or misspelled keyword</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-range"><a class="header" href="#invalid-range">Invalid Range</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mismatched-parantheses"><a class="header" href="#mismatched-parantheses">Mismatched Parantheses</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-time-literal"><a class="header" href="#invalid-time-literal">Invalid time literal</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-number"><a class="header" href="#invalid-number">Invalid Number</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="missing-case-contition"><a class="header" href="#missing-case-contition">Missing Case Contition</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="keywords-should-contain-underscores"><a class="header" href="#keywords-should-contain-underscores">Keywords should contain Underscores</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="wrong-paranthese-for-string-delimiter"><a class="header" href="#wrong-paranthese-for-string-delimiter">Wrong paranthese for String delimiter</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pointer-to-is-type-unsafe"><a class="header" href="#pointer-to-is-type-unsafe">POINTER TO is type-unsafe</a></h1>
<p>Variables defined as a <code>POINTER TO</code> data-type are considered type-unsafe in the sense that no validation will
trigger when assigning incorrect types. For example the following code, while incorrect, will not return any
diagnostics when compiling:</p>
<pre><code>VAR
    stringVar : STRING;
    unsafePtrA : POINTER TO DINT := ADR(stringVar);
    unsafePtrB : POINTER TO DINT := REF(stringVar);
END_VAR
</code></pre>
<p><strong>For best practices, consider using <code>REF_TO</code> instead of <code>POINTER TO</code>, which is a type-safe alternative and <em>should</em> catch
type-mismatches early on</strong></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="return-types-cannot-have-a-default-value"><a class="header" href="#return-types-cannot-have-a-default-value">Return types cannot have a default value</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="classes-cannot-contain-implementation"><a class="header" href="#classes-cannot-contain-implementation">Classes cannot contain implementation</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="duplicate-label"><a class="header" href="#duplicate-label">Duplicate Label</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="classes-cannot-contain-in_out-variables"><a class="header" href="#classes-cannot-contain-in_out-variables">Classes cannot contain IN_OUT variables</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="classes-cannot-contain-a-return-type"><a class="header" href="#classes-cannot-contain-a-return-type">Classes cannot contain a return type</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="variable-re-declatation-in-subclasses-is-not-allowed"><a class="header" href="#variable-re-declatation-in-subclasses-is-not-allowed">Variable re-declatation in Subclasses is not allowed</a></h1>
<p>A variable already declared in a parent class cannot be re-declared in a subclass.</p>
<p>Example:</p>
<pre><code class="language-iecst">FUNCTION_BLOCK FB
VAR
    a : INT;
END_VAR
END_FUNCTION_BLOCK

FUNCTION_BLOCK FB2 EXTENDS FB
VAR
    a : INT; // Error: Variable 'a' is already declared in the parent class
END_VAR
END_FUNCTION_BLOCK
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="missing-container-name-for-action"><a class="header" href="#missing-container-name-for-action">Missing container name for action</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="statement-has-no-effect"><a class="header" href="#statement-has-no-effect">Statement has no effect</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-pragma-location"><a class="header" href="#invalid-pragma-location">Invalid Pragma Location</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="missing-return-type"><a class="header" href="#missing-return-type">Missing return type</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unexpected-return-type"><a class="header" href="#unexpected-return-type">Unexpected return type</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unsupported-return-type"><a class="header" href="#unsupported-return-type">Unsupported return type</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="empty-variable-block"><a class="header" href="#empty-variable-block">Empty variable block</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="e029-recursive-data-structure"><a class="header" href="#e029-recursive-data-structure">E029: Recursive data structure</a></h1>
<p>This error occurs when data structures contain themselves directly or indirectly, creating infinite recursion during type resolution.</p>
<h2 id="example-2"><a class="header" href="#example-2">Example</a></h2>
<pre><code class="language-st">TYPE MyStruct : STRUCT
    value : INT;
    nested : MyStruct;  (* This creates infinite recursion *)
END_STRUCT; END_TYPE
</code></pre>
<p>In this example, <code>MyStruct</code> contains a field of type <code>MyStruct</code>, which would require infinite memory to represent.</p>
<h2 id="another-example---indirect-recursion"><a class="header" href="#another-example---indirect-recursion">Another example - indirect recursion</a></h2>
<pre><code class="language-st">TYPE StructA : STRUCT
    data : INT;
    ref_b : StructB;
END_STRUCT; END_TYPE

TYPE StructB : STRUCT
    info : STRING;
    ref_a : StructA;  (* Creates a cycle: StructA -&gt; StructB -&gt; StructA *)
END_STRUCT; END_TYPE
</code></pre>
<p>This shows two structures that reference each other, creating a circular dependency.</p>
<h2 id="valid-self-referential-structures-with-pointers"><a class="header" href="#valid-self-referential-structures-with-pointers">Valid self-referential structures with pointers</a></h2>
<p>Self-referential data structures are allowed when using references or pointers, as these have fixed size:</p>
<pre><code class="language-st">(* Tree node structure *)
TYPE TreeNode : STRUCT
    value : INT;
    left : REF_TO TreeNode;   (* Pointer to left child *)
    right : REF_TO TreeNode;  (* Pointer to right child *)
END_STRUCT; END_TYPE

(* Linked list node *)
TYPE ListNode : STRUCT
    data : STRING;
    next : REF_TO ListNode;   (* Pointer to next node *)
END_STRUCT; END_TYPE
</code></pre>
<h2 id="how-to-fix"><a class="header" href="#how-to-fix">How to fix</a></h2>
<p><strong>Use references or pointers for self-referential structures</strong></p>
<p>Break the infinite recursion by using <code>REF_TO</code> for recursive references:</p>
<pre><code class="language-st">TYPE Node : STRUCT
    value : INT;
    child : REF_TO Node;  (* Use REF_TO instead of direct inclusion *)
END_STRUCT; END_TYPE
</code></pre>
<p><strong>Restructure circular dependencies</strong></p>
<p>For mutually recursive structures, consider using references or redesigning the data structure:</p>
<pre><code class="language-st">TYPE PersonID : DINT; END_TYPE

TYPE Person : STRUCT
    name : STRING;
    manager_id : PersonID;    (* Reference by ID instead of direct inclusion *)
    reports : ARRAY[0..9] OF PersonID;
END_STRUCT; END_TYPE
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="missing-in_out-parameters"><a class="header" href="#missing-in_out-parameters">Missing IN_OUT parameters</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-parameter-type"><a class="header" href="#invalid-parameter-type">Invalid parameter type</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-number-of-arguments"><a class="header" href="#invalid-number-of-arguments">Invalid number of arguments</a></h1>
<p>An invalid number of arguments was passed to a POU. For example</p>
<pre><code class="language-iecst">FUNCTION foo
    (* ... *)
END_FUNCTION

FUNCTION main : DINT
    foo('bar'); // Error, foo isn't expecting any arguments
END_FUNCTION
</code></pre>
<p>Note that for <code>FUNCTION</code>s the argument count must match with the parameter list and can be bigger if a variadic
parameter is present. For stateful POUs variadic parameters are not supported, thus the argument count must be equal
or less than the parameter list depending on whether optional arguments such as <code>VAR_INPUT</code> or <code>VAR_OUTPUT</code> were
passed or not.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unresolved-constant"><a class="header" href="#unresolved-constant">Unresolved Constant</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-constant-block"><a class="header" href="#invalid-constant-block">Invalid constant block</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-constant"><a class="header" href="#invalid-constant">Invalid Constant</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cannot-assign-to-constant"><a class="header" href="#cannot-assign-to-constant">Cannot assign to constant</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-assignment"><a class="header" href="#invalid-assignment">Invalid assignment</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="missing-type"><a class="header" href="#missing-type">Missing type</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="variable-overflow"><a class="header" href="#variable-overflow">Variable Overflow</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-enum-variant"><a class="header" href="#invalid-enum-variant">Invalid Enum Variant</a></h1>
<p>This error indicates the right-hand side in an enum assignment is invalid.
For example an enum such as <code>TYPE Color : (red := 0, green := 1, blue := 2); END_TYPE</code> can only take values
which (internally) yield a literal integer 0, 1 or 2.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-variable-initializer"><a class="header" href="#invalid-variable-initializer">Invalid variable initializer</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="assignment-to-reference"><a class="header" href="#assignment-to-reference">Assignment to Reference</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-array-assignment"><a class="header" href="#invalid-array-assignment">Invalid array assignment</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-pou-for-vla"><a class="header" href="#invalid-pou-for-vla">Invalid POU for VLA</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-vla-array-access"><a class="header" href="#invalid-vla-array-access">Invalid VLA array access</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vla-dimension-out-of-bounds"><a class="header" href="#vla-dimension-out-of-bounds">VLA Dimension out of bounds</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vlas-are-always-by-reference"><a class="header" href="#vlas-are-always-by-reference">VLAs are always By Reference</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unresolved-reference"><a class="header" href="#unresolved-reference">Unresolved Reference</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="illegal-reference-access"><a class="header" href="#illegal-reference-access">Illegal reference access</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="expression-is-not-assignable"><a class="header" href="#expression-is-not-assignable">Expression is not assignable</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="typecast-error"><a class="header" href="#typecast-error">Typecast error</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unknown-type"><a class="header" href="#unknown-type">Unknown type</a></h1>
<p>Use of undeclared type-identifier.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="literal-out-of-range"><a class="header" href="#literal-out-of-range">Literal out of range</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="literal-not-compatible-with-type"><a class="header" href="#literal-not-compatible-with-type">Literal not compatible with type</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="incompatible-direct-access"><a class="header" href="#incompatible-direct-access">Incompatible direct access</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="incompatible-variable-for-direct-access"><a class="header" href="#incompatible-variable-for-direct-access">Incompatible variable for direct access</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-range-for-direct-access"><a class="header" href="#invalid-range-for-direct-access">Invalid range for direct access</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-range-for-array-access"><a class="header" href="#invalid-range-for-array-access">Invalid range for array access</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-variable-for-array-access"><a class="header" href="#invalid-variable-for-array-access">Invalid variable for array access</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="direct-access-to-variable-with-"><a class="header" href="#direct-access-to-variable-with-">Direct access to variable with %</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="expected-literal"><a class="header" href="#expected-literal">Expected literal</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-nature"><a class="header" href="#invalid-nature">Invalid Nature</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unknown-nature"><a class="header" href="#unknown-nature">Unknown Nature</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unresolved-generic"><a class="header" href="#unresolved-generic">Unresolved Generic</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="incompatible-size"><a class="header" href="#incompatible-size">Incompatible size</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-operation"><a class="header" href="#invalid-operation">Invalid operation</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="implicit-typecast"><a class="header" href="#implicit-typecast">Implicit typecast</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pointer-derefernce-to-non-pointer"><a class="header" href="#pointer-derefernce-to-non-pointer">Pointer derefernce to non pointer</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="array-access-to-non-array-value"><a class="header" href="#array-access-to-non-array-value">Array access to non array value</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="address-of-requires-a-value"><a class="header" href="#address-of-requires-a-value">Address-of requires a value</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="general-codegen-error"><a class="header" href="#general-codegen-error">General codegen error</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="missing-function"><a class="header" href="#missing-function">Missing function</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="missing-compare-function"><a class="header" href="#missing-compare-function">Missing compare function</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cannot-generate-string-literal"><a class="header" href="#cannot-generate-string-literal">Cannot generate string literal</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="initial-values-were-not-generated"><a class="header" href="#initial-values-were-not-generated">Initial values were not generated</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="general-debug-error"><a class="header" href="#general-debug-error">General debug error</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="generic-linker-error"><a class="header" href="#generic-linker-error">Generic linker error</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="duplicate-case-condition"><a class="header" href="#duplicate-case-condition">Duplicate case condition</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="case-condition-outside-of-a-case-statement"><a class="header" href="#case-condition-outside-of-a-case-statement">Case condition outside of a case statement</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-case-condition"><a class="header" href="#invalid-case-condition">Invalid case condition</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="empty-control-statement"><a class="header" href="#empty-control-statement">Empty control statement</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="undefined-node"><a class="header" href="#undefined-node">Undefined node</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unexpected-node"><a class="header" href="#unexpected-node">Unexpected node</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unconnected-source"><a class="header" href="#unconnected-source">Unconnected source</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cyclic-connection"><a class="header" href="#cyclic-connection">Cyclic connection</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="no-associated-connector"><a class="header" href="#no-associated-connector">No associated connector</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unnamed-control"><a class="header" href="#unnamed-control">Unnamed control</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-plc-json-file"><a class="header" href="#invalid-plc-json-file">Invalid PLC Json file</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-call-parameters"><a class="header" href="#invalid-call-parameters">Invalid Call parameters</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="incompatible-reference-assingment"><a class="header" href="#incompatible-reference-assingment">Incompatible reference assingment</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unsafe-enum-assignment"><a class="header" href="#unsafe-enum-assignment">Unsafe Enum Assignment</a></h1>
<p>At runtime there is no way to guarantee that a non-const reference will not change its value to something out-of-bounds for enums. For example consider the following</p>
<pre><code class="language-iecst">PROGRAM main
    VAR
        zero  : DINT := 0;
        color : (red := 0, green := 1, blue := 2);
    END_VAR

    zero := 10;
    color := zero; // Invalid because `color` accepts values from 0 to 2, but we assigned 10 to it
END_PROGRAM
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="equivalent-enum-value-used"><a class="header" href="#equivalent-enum-value-used">Equivalent enum value used</a></h1>
<p>This message indicates that the assigned enum value is not part of the enum,
but is equivalent to one of the internal values of the enum.</p>
<p>Example:</p>
<pre><code class="language-iecst">TYPE Colors : (Red, Green, Blue, Yellow) END_TYPE
TYPE Directions : (N, S, W, E) END_TYPE

VAR_GLOBAL
    col : Colors := N; //N is equivalent to Red but is not part of the enum
    dir : Directions := Red; //Red is equivalent to N but is not part of the enum
END_VAR
</code></pre>
<p>To solve the issue, use the equivalent value indicated by the enum</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="return-value-of-void-functions"><a class="header" href="#return-value-of-void-functions">Return Value Of Void Functions</a></h1>
<p>Functions of type VOID can not have an explicit return value, e.g. <code>foo := 1</code> in the following example is invalid.</p>
<pre><code class="language-iecstd">FUNCTION foo
    foo := 1;
END_FUNCTION
</code></pre>
<p>Choose a type for your function, if a value must be returned.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-conditional-value"><a class="header" href="#invalid-conditional-value">Invalid Conditional Value</a></h1>
<p>Control statements such as <code>IF</code>, <code>FOR</code> and <code>WHILE</code> require specific types for their condition.</p>
<h2 id="if-while"><a class="header" href="#if-while">If, While</a></h2>
<p><code>IF</code> and <code>WHILE</code> statements require an expression which yields a boolean, any other type is invalid and will trigger an
error.</p>
<h1 id="for"><a class="header" href="#for">For</a></h1>
<p><code>FOR</code> statements require four conditional values: a <code>counter</code>, a <code>start</code> value, an <code>end</code> value and a <code>step</code> value. All
of these need to be integers and share the same type.</p>
<pre><code class="language-iecst">FOR start := counter TO end BY step DO
// ...
END_FOR
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="action-call-without-parentheses"><a class="header" href="#action-call-without-parentheses">Action call without parentheses</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="integer-condition"><a class="header" href="#integer-condition">Integer Condition</a></h1>
<p>This error is generated because an integer was used in a <code>IF</code> or <code>WHILE</code> statement, when a boolean was expected.</p>
<p>See also <code>plc explain E094</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-array-range"><a class="header" href="#invalid-array-range">Invalid Array Range</a></h1>
<p>Ranges such as <code>ARRAY [0..-1]</code> are invalid in ST because end values of ranges must be greater than their start values.
A valid range for the given statement would have been <code>ARRAY[-1..0]</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-ref-assignment"><a class="header" href="#invalid-ref-assignment">Invalid REF= assignment</a></h1>
<p><code>REF=</code> assignments are considered valid if the left-hand side of the assignment is a pointer variable
and the right-hand side is a variable of the type that is being referenced.</p>
<p>For example assignments such as the following are invalid</p>
<pre><code class="language-iecst">VAR
    foo     : DINT;
    bar     : DINT;
    qux     : SINT;
    refFoo  : REFERENCE TO DINT;
END_VAR

refFoo  REF= 5;         // `5` is not a variable
foo     REF= bar;       // `foo` is not a pointer
refFoo  REF= qux;       // `refFoo` and `qux` have different types, DINT vs SINT
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-reference-to-declaration"><a class="header" href="#invalid-reference-to-declaration">Invalid <code>REFERENCE TO</code> declaration</a></h1>
<p><code>REFERENCE TO</code> variable declarations are considered valid if the referenced type is not of the following form</p>
<ul>
<li><code>foo : REFERENCE TO REFERENCE TO (* ... *)</code></li>
<li><code>foo : ARRAY[...] OF REFERENCE TO (* ... *)</code></li>
<li><code>foo : REF_TO REFERENCE TO (* ... *)</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="immutable-variable-address"><a class="header" href="#immutable-variable-address">Immutable Variable Address</a></h1>
<p>Alias variables are immutable with regards to their pointer address, thus re-assigning an address will return an error. For example the following code will not compile</p>
<pre><code class="language-iecst">FUNCTION main
    VAR
        foo AT bar : DINT;
        bar : DINT;
        baz : DINT;
    END_VAR

    foo := baz;     // Valid, because we are changing the pointers dereferenced value
    foo REF= baz;   // Invalid, `foo` is immutable with regards to it's pointer address
END_FUNCTION
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="template-variable-does-not-exist"><a class="header" href="#template-variable-does-not-exist">Template variable does not exist</a></h1>
<p>A variable was configured in a <code>VAR_CONFIG</code> block, but the variable can not be found in the code.</p>
<p>Erroneous code example:</p>
<pre><code class="language-iecst">VAR_CONFIG
    main.foo.bar AT %IX1.0 : BOOL;
END_VAR

PROGRAM main
    VAR
        foo : foo_fb;
    END_VAR
END_PROGRAM

FUNCTION_BLOCK foo_fb
    VAR
        qux AT %I* : BOOL;
    END_VAR
END_FUNCTION_BLOCK
</code></pre>
<p>In this example a variable named <code>bar</code> is configured, however the function block <code>foo_fb</code> does not contain
a <code>bar</code> variable. The could should have been <code>main.foo.qux AT %IX1.0 : BOOL</code> instead for it to be valid.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="template-variable-without-hardware-binding"><a class="header" href="#template-variable-without-hardware-binding">Template variable without hardware binding</a></h1>
<p>A template variable must contain a hardware binding.</p>
<p>Erroneous code example:</p>
<pre><code class="language-iecst">VAR_CONFIG
    main.foo.bar AT %IX1.0 : BOOL;
END_VAR

PROGRAM main
    VAR
        foo : foo_fb;
    END_VAR
END_PROGRAM

FUNCTION_BLOCK foo_fb
    VAR
        bar : BOOL;
    END_VAR
END_FUNCTION_BLOCK
</code></pre>
<p>In this example the <code>VAR_CONFIG</code> block declares the <code>bar</code> variable inside <code>foo_fb</code> as a
template variable. However <code>bar</code> does not have a hardware binding. For the example to be
considered valid, <code>bar</code> should have been declared as e.g. <code>bar AT %I* : BOOL</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="immutable-hardware-binding"><a class="header" href="#immutable-hardware-binding">Immutable Hardware Binding</a></h1>
<p>Variables configured in a <code>VAR_CONFIG</code> block can not override their hardware binding.</p>
<p>Erroneous code example:</p>
<pre><code class="language-iecst">VAR_CONFIG
    main.foo.bar AT %IX1.0 : BOOL;
END_VAR

PROGRAM main
    VAR
        foo : foo_fb;
    END_VAR
END_PROGRAM

FUNCTION_BLOCK foo_fb
    VAR
        bar AT IX1.5: BOOL;
    END_VAR
END_FUNCTION_BLOCK
</code></pre>
<p>In this example the <code>VAR_CONFIG</code> block configures <code>bar</code> to have a hardware adress <code>IX1.0</code>.
However, at the same time the <code>bar</code> inside the POU <code>foo_fb</code> assigns a hardware address <code>IX1.5</code>.</p>
<p>For the code to be considered valid, <code>bar</code> should have been declared as <code>bar AT %I* : BOOL</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="config-variable-with-incomplete-address"><a class="header" href="#config-variable-with-incomplete-address">Config Variable With Incomplete Address</a></h1>
<p>Variables defined in a <code>VAR_CONFIG</code> block, i.e. config variables, must specify a complete address.</p>
<p>Erroneous code example:</p>
<pre><code class="language-iecst">VAR_CONFIG
    main.foo.bar AT %I* : BOOL;
END_VAR
</code></pre>
<p>In this example <code>main.foo.bar</code> has specified a placeholder hardware address.
For the example to be considered valid, a specific address such as <code>%IX1.0</code> should have been declared.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="constant-keyword-in-pou"><a class="header" href="#constant-keyword-in-pou">CONSTANT keyword in POU</a></h1>
<p>The <code>CONSTANT</code> keyword is not allowed for POU declarations, only variables can be <code>CONSTANT</code></p>
<p>Erroneous code example:</p>
<pre><code class="language-iecst">FUNCTION FOO : BOOL CONSTANT 
VAR_INPUT
END_VAR
    // ...
END_FUNCTION
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="var_external-blocks-have-no-effect"><a class="header" href="#var_external-blocks-have-no-effect">VAR_EXTERNAL blocks have no effect</a></h1>
<p>Variables declared in a <code>VAR_EXTERNAL</code> block are currently ignored and the referenced globals will be used instead.</p>
<p>Example:</p>
<pre><code class="language-iecst">VAR_GLOBAL
    myArray : ARRAY [0..10] OF INT;
    myString: STRING;
END_VAR

FUNCTION main
VAR_EXTERNAL CONSTANT
    myArray : ARRAY [0..10] OF INT;
END_VAR
    myArray[5] := 42;
    myString := 'Hello, world!';
END_FUNCTION
</code></pre>
<p>In this example, even though <code>arr</code> is declared as <code>VAR_EXTERNAL CONSTANT</code>, the <code>CONSTANT</code> constraint will be ignored and
the global <code>myArray</code> will be mutated. The global <code>myString</code> can be read from and written to from within <code>main</code> even though it
is not declared in a <code>VAR_EXTERNAL</code> block.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="missing-configuration-for-template-variable"><a class="header" href="#missing-configuration-for-template-variable">Missing configuration for template variable</a></h1>
<p>A template variable was left unconfigured.</p>
<p>Erroneous code example:</p>
<pre><code class="language-iecst">VAR_CONFIG
    main.foo.bar AT %IX1.0 : BOOL;
END_VAR

PROGRAM main
    VAR
        foo : foo_fb;
    END_VAR
END_PROGRAM

FUNCTION_BLOCK foo_fb
    VAR
        bar AT %I* : BOOL;
        qux AT %I* : BOOL;
    END_VAR
END_FUNCTION_BLOCK
</code></pre>
<p>In this example a variable named <code>main.foo.qux</code> is declared as a template, however the <code>VAR_CONFIG</code>-block does not contain
an address-configuration for it. Each template variable needs to be configured, otherwise it could lead to segmentation faults at runtime.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="template-variable-is-configured-multiple-times"><a class="header" href="#template-variable-is-configured-multiple-times">Template variable is configured multiple times</a></h1>
<p>A template variable is configured more than once, leading to ambiguity.</p>
<p>Erroneous code example:</p>
<pre><code class="language-iecst">VAR_CONFIG
    main.foo.bar AT %IX1.0 : BOOL;
    main.foo.bar AT %IX1.1 : BOOL;
END_VAR

PROGRAM main
    VAR
        foo : foo_fb;
    END_VAR
END_PROGRAM

FUNCTION_BLOCK foo_fb
    VAR
        bar AT %I* : BOOL;
    END_VAR
END_FUNCTION_BLOCK
</code></pre>
<p>In this example a variable named <code>main.foo.bar</code> has multiple configurations in the <code>VAR_CONFIG</code>-block. It is not clear which address this variable should map to - only a single configuration entry per instance-variable is allowed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stateful-member-variable-initialized-with-temporary-reference"><a class="header" href="#stateful-member-variable-initialized-with-temporary-reference">Stateful member variable initialized with temporary reference</a></h1>
<p>Stack-local variables do not yet exist at the time of initialization. Additionally, pointing to a temporary variable will lead to a dangling pointer
as soon as it goes out of scope - potential use after free.</p>
<p>Erroneous code example:</p>
<pre><code class="language-iecst">FUNCTION_BLOCK foo
    VAR
        a : REF_TO BOOL := REF(b);
    END_VAR
    VAR_TEMP
        b : BOOL;
    END_VAR
END_FUNCTION_BLOCK
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-pou-type-for-inheritance"><a class="header" href="#invalid-pou-type-for-inheritance">Invalid POU Type for Inheritance</a></h1>
<p>Base Classes and Interfaces can only be used on <code>CLASS</code>es and <code>FUNCTION_BLOCK</code>s, any other POU type is invalid and will
result in this error.</p>
<p>Errouneus code example:</p>
<pre><code class="language-iecst">INTERFACE interfaceA
    /* ... */
END_INTERFACE

FUNCTION_BLOCK fb
END_FUNCTION_BLOCK

FUNCTION foo EXTENDS fb IMPLEMENTS interfaceA
    /* ... */
END_FUNCTION_BLOCK
</code></pre>
<p>In the example above, the POU type of <code>foo</code> should have been <code>CLASS</code> or <code>FUNCTION_BLOCK</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="duplicate-interface-methods-with-different-signatures"><a class="header" href="#duplicate-interface-methods-with-different-signatures">Duplicate interface methods with different signatures</a></h1>
<p>POUs implementing multiple interfaces where both interfaces define a method with the same name are required
to have the same signature for the method. A method signature is thereby defined by its name, return type and
parameter list.</p>
<p>Errouneus code example:</p>
<pre><code class="language-iecst">INTERFACE interfaceA
    METHOD foo : INT
        VAR_INPUT
            a : INT;
        END_VAR
    END_METHOD
END_INTERFACE

INTERFACE interfaceB
    METHOD foo : DINT
        VAR_OUTPUT
            a : INT;
        END_VAR
    END_METHOD
END_INTERFACE

FUNCTION_BLOCK fb IMPLEMENTS interfaceA, interfaceB
    // Signatures for foo differs, do we implement foo as defined in interfaceA or interfaceB?
END_FUNCTION_BLOCK

</code></pre>
<p>In the example above, the method <code>foo</code> is defined in both interfaces <code>interfaceA</code> and <code>interfaceB</code>.
However, the return type of <code>foo</code> in <code>interfaceA</code> is <code>INT</code> whereas in <code>interfaceB</code> it is <code>DINT</code>. Futhermore,
the parameter <code>a</code> in <code>interfaceA</code> is an input parameter whereas in <code>interfaceB</code> it is an output parameter.
As a result both you and the compiler are left in doubt as to which method signature to implement in the
function block <code>fb</code> and as a result the compiler will raise this error.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="incomplete-interface-implementation"><a class="header" href="#incomplete-interface-implementation">Incomplete interface implementation</a></h1>
<p>Any class or function block implementing an interface must implement all methods as defined in the interface.
Generally speaking this error is raised when any of the following conditions are met:</p>
<ol>
<li>The method is not implemented in the class or function block at all</li>
<li>The return type of the method is different from the return type defined in the interface</li>
<li>The order of the parameters in the method is different from the order of the parameters in the interface</li>
<li>The size of the parameter list does not match the size of the parameter list in the interface</li>
<li>The parameter at any given position in the method is different from the parameter at the same position in
the interface (name, data type, or variable block type i.e. INPUT, OUTPUT, IN_OUT)</li>
</ol>
<p>Errouneus code example:</p>
<pre><code class="language-iecst">INTERFACE interfaceA
    METHOD foo : INT
        VAR_INPUT
            a : INT;
            b : DINT;
        END_VAR
    END_METHOD
END_INTERFACE

FUNCTION_BLOCK fb IMPLEMENTS interfaceA
    METHOD foo : DINT   // Incorrect return type, should have been `INT`
        VAR_OUPUT       // Incorrect variable block type, should have been `VAR_INPUT`
            b : DINT;   // Incorrect order, should have been `a : INT`; as a result also an incorrect data type
            a : INT;    // Incorrect order, should have been `b : DINT`; as a result also an incorrect data type
            c : INT;    // Incorrect parameter list length, 3 &gt; 2
        END_VAR
    END_METHOD
END_FUNCTION_BLOCK
</code></pre>
<p><strong>Note</strong>: The third bullet point can be confusing, however for implicit calls the order of the parameters is
important. For example if a interface defines the order of the parameters as <code>a, b</code> and the function block
implements the method as <code>b, a</code> a method call such as <code>foo(1, 2)</code> should be interpreted as <code>foo(a := 1, b := 2)</code>
but instead will be interpreted as <code>foo(a := 2, b := 1)</code>. As a result consistency between any POU implementing
an interface can no longer be guaranteed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="interface-default-method-implementation"><a class="header" href="#interface-default-method-implementation">Interface default method implementation</a></h1>
<p>Methods defined in interfaces must not have an implementation. While the compiler parses them, they are not
used to validate and/or generate code and thus will have no effect. This may change in the future but as of
now is not supported.</p>
<p>Erreneous code example:</p>
<pre><code class="language-iecst">INTERFACE interfaceA
    METHOD methodA : INT
        methodA := 5; // This counts as a default implementation and hence will return a warning
    END_METHOD
END_INTERFACE
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cannot-extend-a-pou-multiple-times"><a class="header" href="#cannot-extend-a-pou-multiple-times">Cannot extend a POU multiple times</a></h1>
<p>Multiple <code>EXTENDS</code> keywords are not allowed</p>
<p>Erreneous code example:</p>
<pre><code class="language-iecst">FUNCTION_BLOCK foo EXTENDS bar EXTENDS baz
    // ...
END_FUNCTION_BLOCK
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="property-defined-in-non-stateful-pou-type"><a class="header" href="#property-defined-in-non-stateful-pou-type">Property defined in non-stateful POU type</a></h1>
<p>Properties may only be defined in stateful POUs such as a <code>PROGRAM</code>,<code>CLASS</code> or <code>FUNCTION_BLOCK</code>.</p>
<p>Errouneus code example:</p>
<pre><code>FUNCTION foo
    // Invalid definition
    PROPERTY bar : DINT
        GET
            bar := 42;
        END_GET
    END_PROPERTY
END_FUNCTION</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="property-defined-in-unsupported-variable-block"><a class="header" href="#property-defined-in-unsupported-variable-block">Property defined in unsupported variable block</a></h1>
<p>Properties only allow for variable blocks of type <code>VAR</code>.</p>
<p>Errouneus code example:</p>
<pre><code>FUNCTION foo
    PROPERTY bar : DINT 
        GET
            VAR         /* ... */   END_VAR
            VAR_INPUT   /* ... */   END_VAR // Invalid
        END_GET
    END_PROPERTY
END_FUNCTION
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="property-with-invalid-number-of-get-andor-set-blocks"><a class="header" href="#property-with-invalid-number-of-get-andor-set-blocks">Property with invalid number of GET and/or SET blocks</a></h1>
<p>Properties must be non empty and <em>at most</em> contain one block of type GET or SET.</p>
<p>Errouneus code example:</p>
<pre><code>FUNCTION foo
    PROPERTY bar : DINT 
        // Invalid, empty (no GET or SET block)
    END_PROPERTY

    PROPERTY baz : DINT 
        // Invalid, two GET blocks
        GET END_GET
        GET END_GET
    END_PROPERTY

    PROPERTY qux : DINT 
        // Invalid, two SET blocks
        SET END_SET
        SET END_SET
    END_PROPERTY
END_FUNCTION
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="signature-mismatch"><a class="header" href="#signature-mismatch">Signature mismatch</a></h1>
<p>This error is generally a follow-up error to "E112" to give more detailed information about why the error occured. Please use <code>plc explain E112</code> get more information about the general causes of these errors.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-use-of-the-super-keyword"><a class="header" href="#invalid-use-of-the-super-keyword">Invalid use of the <code>SUPER</code> keyword</a></h1>
<p>The <code>SUPER</code> keyword provides access to members of a parent POU (Program Organization Unit) in an inheritance hierarchy. However, there are several rules governing its proper use:</p>
<h2 id="common-errors"><a class="header" href="#common-errors">Common errors</a></h2>
<ol>
<li>
<p><strong>Using <code>SUPER</code> in a POU that doesn't extend another POU</strong>:<br />
The <code>SUPER</code> keyword can only be used inside a POU that directly extends another POU through the <code>EXTENDS</code> keyword.</p>
</li>
<li>
<p><strong>Not dereferencing <code>SUPER</code> to access members</strong>:<br />
When accessing members of a superclass, <code>SUPER</code> must be dereferenced using the <code>^</code> operator: <code>SUPER^.member</code>.</p>
</li>
<li>
<p><strong>Chaining <code>SUPER</code> references</strong>:<br />
<code>SUPER</code> cannot be accessed as a member of another object. Expressions like <code>SUPER^.SUPER^</code> are invalid.</p>
</li>
<li>
<p><strong>Global access position</strong>:<br />
<code>SUPER</code> cannot be used with the global access operator (<code>.SUPER^.member</code>).</p>
</li>
<li>
<p><strong>Using <code>SUPER</code> with type cast operators</strong>:<br />
The type cast operator (<code>&lt;type&gt;#</code>) cannot be used with <code>SUPER</code>.</p>
</li>
</ol>
<h2 id="examples-of-invalid-use"><a class="header" href="#examples-of-invalid-use">Examples of invalid use</a></h2>
<pre><code class="language-iecst">// Error: Using SUPER in a POU that doesn't extend another POU
FUNCTION_BLOCK fb
    SUPER^.x := 2;  // Error: Invalid use of `SUPER`
END_FUNCTION_BLOCK

// Error: Not dereferencing SUPER when accessing members
FUNCTION_BLOCK child EXTENDS parent
    SUPER.x := 20;  // Error: `SUPER` must be dereferenced to access its members
END_FUNCTION_BLOCK

// Error: Chaining SUPER references/SUPER in member access
FUNCTION_BLOCK child EXTENDS parent
    x.SUPER^.y := 20;    
    SUPER^.SUPER^.x := 20;  
    // Error: `SUPER` is not allowed in member-access position
END_FUNCTION_BLOCK

// Error: Global access position
FUNCTION_BLOCK child EXTENDS parent
    .SUPER^.x := 20;  // Error: `SUPER` is not allowed in global-access position
END_FUNCTION_BLOCK

// Error: Using SUPER with type cast
FUNCTION_BLOCK child EXTENDS parent
    p := parent#SUPER;  // Error: The `&lt;type&gt;#` operator cannot be used with `SUPER`
END_FUNCTION_BLOCK</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="invalid-use-of-the-this-keyword"><a class="header" href="#invalid-use-of-the-this-keyword">Invalid use of the <code>THIS</code> keyword</a></h1>
<p>The <code>THIS</code> keyword provides access to the current instance of a <code>FUNCTION_BLOCK</code>. However, there are several rules governing its proper use:</p>
<h2 id="common-errors-1"><a class="header" href="#common-errors-1">Common errors</a></h2>
<ol>
<li>
<p><strong>Using <code>THIS</code> outside of a <code>FUNCTION_BLOCK</code> context</strong>:
The <code>THIS</code> keyword can only be used inside a <code>FUNCTION_BLOCK</code> or its <code>METHOD</code>s or <code>ACTION</code>s. It cannot be used in <code>FUNCTION</code>s, <code>PROGRAM</code>s, or .</p>
</li>
<li>
<p><strong>Not dereferencing <code>THIS</code> to access members</strong>:
When accessing members using <code>THIS</code>, it must be dereferenced using the <code>^</code> operator: <code>THIS^.member</code>.</p>
</li>
<li>
<p><strong>Member access position</strong>:
<code>THIS</code> cannot be accessed as a member of another object. Expressions like <code>x.THIS^</code> are invalid.</p>
</li>
<li>
<p><strong>Global access position</strong>:
<code>THIS</code> cannot be used with the global access operator (<code>.THIS^.member</code>).</p>
</li>
<li>
<p><strong>Using <code>THIS</code> with type cast operators</strong>:
The type cast operator (<code>&lt;type&gt;#</code>) cannot be used with <code>THIS</code>.</p>
</li>
</ol>
<h2 id="examples-of-invalid-use-1"><a class="header" href="#examples-of-invalid-use-1">Examples of invalid use</a></h2>
<pre><code class="language-iecst">// Error: Using THIS outside `FUNCTION_BLOCK` context
FUNCTION func
    THIS^.x := 2;  // Error: Invalid use of `THIS`
END_FUNCTION

// Error: Not dereferencing THIS when accessing members
FUNCTION_BLOCK fb
    THIS.x := 20;  // Error: `THIS` must be dereferenced to access its members
END_FUNCTION_BLOCK

// Error: THIS in member access position
FUNCTION_BLOCK fb
    x.THIS^.y := 20;  // Error: `THIS` is not allowed in member-access position
END_FUNCTION_BLOCK

// Error: Global access position
FUNCTION_BLOCK fb
    .THIS^.x := 20;  // Error: `THIS` is not allowed in global-access position
END_FUNCTION_BLOCK

// Error: Using THIS with type cast
FUNCTION_BLOCK fb
    p := fb#THIS;  // Error: The `&lt;type&gt;#` operator cannot be used with `THIS`
END_FUNCTION_BLOCK
</code></pre>
<h2 id="examples-of-valid-use"><a class="header" href="#examples-of-valid-use">Examples of valid use</a></h2>
<pre><code class="language-iecst">FUNCTION_BLOCK Counter
    VAR
        count : INT;
        enabled : BOOL;
    END_VAR

    // Valid: Direct use in FUNCTION_BLOCK implementation
    METHOD increment
        IF THIS^.enabled THEN
            THIS^.count := THIS^.count + 1;
        END_IF
    END_METHOD

    // Valid: Using THIS to pass the instance to another FB
    METHOD send_to_logger : BOOL
        VAR_IN_OUT
            logger : Logger;
        END_VAR
        logger.log_counter(THIS);
    END_METHOD

    // Valid: Using THIS to compare with another instance
    METHOD equals : BOOL
        VAR_IN_OUT
            other : Counter;
        END_VAR
        equals := THIS^.count = other.count;
    END_METHOD

    ACTION my_action
        IF THIS^.enabled THEN
            THIS^.count := THIS^.count + 1;
        END_IF
    END_ACTION
END_FUNCTION_BLOCK
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="e121-recursive-type-alias"><a class="header" href="#e121-recursive-type-alias">E121: Recursive type alias</a></h1>
<p>This error occurs when type aliases reference each other in a cycle, creating an infinite recursion.</p>
<h2 id="example-3"><a class="header" href="#example-3">Example</a></h2>
<pre><code class="language-st">TYPE type1 : type2; END_TYPE
TYPE type2 : type1; END_TYPE
</code></pre>
<p>In this example, <code>type1</code> is defined as <code>type2</code>, which is in turn defined as <code>type1</code>, creating a circular dependency.</p>
<h2 id="another-example"><a class="header" href="#another-example">Another example</a></h2>
<pre><code class="language-st">TYPE self_type : self_type; END_TYPE
</code></pre>
<p>This shows a type alias that directly references itself.</p>
<h2 id="how-to-fix-1"><a class="header" href="#how-to-fix-1">How to fix</a></h2>
<p><strong>Break the chain by resolving to concrete types</strong></p>
<p>Break the circular dependency by ensuring that type aliases eventually resolve to concrete types:</p>
<pre><code class="language-st">TYPE typeA : DINT; END_TYPE      (* Points to concrete type *)
TYPE typeB : typeA; END_TYPE     (* Points to another alias, but ultimately resolves to DINT *)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="libraries-1"><a class="header" href="#libraries-1">Libraries</a></h1>
<p>RuSTy does not currently have support for importing <em>source based libraries</em>.</p>
<p>Source based libraries can, however, be compiled together with the application as normal files.</p>
<p>Precompiled libraries or system functions can be added using compilation flags or an entry in the <code>plc.json</code> file.</p>
<p>System functions can also be added using <a href="libraries/external_functions.html">External Function</a> for each POU in that library.</p>
<h2 id="library-structure"><a class="header" href="#library-structure">Library Structure</a></h2>
<p>A library is defined by:</p>
<ul>
<li>A set of <code>st</code> interfaces, each interface represents a function that has been precompiled.</li>
</ul>
<blockquote>
<p>In a POU, the interface is the definition and variable section e.g:</p>
<pre><code class="language-iecst">(*Interface for program example *)
PROGRAM example
VAR_INPUT
 a,b,c : DINT
END_VAR
(* End of interface *)

(* Implementation *)
END_PROGRAM
</code></pre>
</blockquote>
<ul>
<li>A binary file for each architecture the library has been built for (<code>x86_64-linux-gnu</code>, <code>aarch64-linux-gnu</code>, ..)</li>
</ul>
<h2 id="linking-libraries-using-the-plc-command-line"><a class="header" href="#linking-libraries-using-the-plc-command-line">Linking libraries using the <code>plc</code> command line</a></h2>
<p>To include a library when using the <code>plc</code> command line interface, the include files can be added using the <code>-i</code> flag.</p>
<p>Each <a href="pous.html">POU</a>, <a href="variables.html">Global Variable</a>, or <a href="datatypes.html">Datatype</a> defined in the included files will be added to the project.
POUs and Global variables included with the <code>-i</code> are marked as external, the implementation part of a POU is ignored.</p>
<p>To link the library, two options are then available: <a href="libraries.html#shared-libraries">Shared</a> and <a href="libraries.html#static-libraries">Static</a> libraries.</p>
<h3 id="shared-libraries"><a class="header" href="#shared-libraries">Shared Libraries</a></h3>
<p>A shared library (i.e. extension <code>.so</code>) can be linked using the <code>-l</code> flag. </br>
For a library called <code>mylib</code>, when the flag <code>-lmylib</code> is passed, the linker will search for a file called <code>libmylib.so</code>.</p>
<blockquote>
<p>Note that the <code>lib&lt;LibName&gt;.so</code> format is required by the linker for unix like systems.</p>
</blockquote>
<p>The library locations used by the linker are the default search locations of the linker (i.e. <code>/usr/lib</code>, <code>/lib</code>), additional paths can be provided using the <code>-L</code> flag (e.g <code>-L/opt/lib</code> will make the linker also search for files in /opt/lib).</br>
Additional library locations can be provided by supplying additional <code>-L</code> entries.</br>
Additionally, the environment variable <code>LD_LIBRARY_PATH</code> can be defined to append entries to the linker's search location. More information can be found <a href="https://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html">here</a>.</p>
<h3 id="static-libraries"><a class="header" href="#static-libraries">Static Libraries</a></h3>
<p>Static libraries compiled as object files can be linked by simply passing the object file (i.e. extension <code>.o</code>) as an input (simlar to other <code>.st</code> files).</p>
<p>Archive files (i.e. extension <code>.a</code>) can be linked similarly to <a href="libraries.html#shared-libraries">Shared Libraries</a> using the <code>-l</code> flag.
If the application is being compiled with the <code>--static</code> flag (or no shared library (<code>.so</code>) is found), the linker will use the archive file.</br></p>
<blockquote>
<p>If neither a shared object (<code>.so</code>) or an archive file (<code>.a</code>) is found, compilation will fail.</p>
</blockquote>
<h3 id="command-line-example"><a class="header" href="#command-line-example">Command line example</a></h3>
<p>To compile a file called <code>input.st</code> including a header and linking a library called <code>libiec.so</code> from <code>/lib</code> :</p>
<pre><code class="language-sh">plc input.st -i iec/header.st -L/lib/ -liec
</code></pre>
<h2 id="linking-libraries-using-the-build-description-file-plcjson"><a class="header" href="#linking-libraries-using-the-build-description-file-plcjson">Linking libraries using the Build Description File <code>plc.json</code></a></h2>
<p>Libraries can be added to a project managed with a <a href="using_rusty/build_description_file.html#build-description-file-plcjson">Build Description File</a>. </br>
To add a library to the project, the <code>"libraries"</code> section can be used.
A library entry requires a <code>name</code>, a <code>path</code>, the <code>package</code> behaviour, and a set of files to include (<code>include_path</code>).</p>
<h3 id="name"><a class="header" href="#name"><code>name</code></a></h3>
<p>The name of the library to be linked. This will be used by the linker to find the library. </br>
A library with the name <code>mylib</code> must have an equivalant compiled file called <code>libmylib.so</code>.</p>
<blockquote>
<p>Note, archive files (ending with <code>.a</code>) are currently not supported.</p>
</blockquote>
<h3 id="path"><a class="header" href="#path"><code>path</code></a></h3>
<p>The location of the library to be linked. The path can be either absolute or relative to the project. </br></p>
<h3 id="package"><a class="header" href="#package"><code>package</code></a></h3>
<p>The packaging option for the library, i.e wether the library should be copied or is already available on the system.</br>
The value <a name="copy"><code>"Copy"</code></a> indicates that the given library should be copied to the <a href="libraries.html#library-location">Library Location</a>. </br>
The value <a name="system"><code>"System"</code></a> indicates that the given library exists on the system and does not need to be copied.</p>
<h3 id="include_path"><a class="header" href="#include_path"><code>include_path</code></a></h3>
<p>A list of files (can include globs) that should be included with the project.</br>
Each <a href="pous.html">POU</a>, <a href="variables.html">Global Variable</a>, or <a href="datatypes.html">Datatype</a> defined in the included files will be added to the project.
POUs and Global variables included in the list are marked as external, the implementation part of a POU is ignored.</p>
<h3 id="library-location"><a class="header" href="#library-location">Library Location</a></h3>
<p>Libraries marked as <code>Copy</code> will be copied during the compilation to the defined <a href="using_rusty/build_description_file.html#--lib-location">Library Location</a>.
By default this is the same as the <a href="using_rusty/build_description_file.html#--build-location">Build Location</a> unless overridden by the <code>--lib-location</code> parameter.</p>
<h3 id="using-environment-variables"><a class="header" href="#using-environment-variables">Using environment variables</a></h3>
<p>Since libraries can be compiled for multiple targets, the lib path can contain environment variables to disambiguate the compile location.
<code>$ARCH</code> can be used as placeholder in the path to indicate the the currently compiled target.
</br></br></br></p>
<blockquote>
<p>During linking, if no <code>.so</code> file with name <a href="libraries.html#name"><code>lib&lt;name&gt;.so</code></a> is found, the compilation will fail.</p>
</blockquote>
<h3 id="configuration-example-plcjson"><a class="header" href="#configuration-example-plcjson">Configuration Example (<code>plc.json</code>)</a></h3>
<p>A configuration example for a <code>Copy</code> library called <em>mylib</em> and a <code>System</code> library called <em>std</em>:</p>
<pre><code class="language-json">"libraries" : [
    {
        "name" : "mylib",
        "path" : "libs/$ARCH/",
        "package" : "Copy",
        "include_path" : [
            "simple_program.st"
        ]
    },
    {
        "name" : "std",
        "path" : "libs/$ARCH/",
        "package" : "System",
        "include_path" : [
            "include/*.st"
        ]
    }
]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="external-functions"><a class="header" href="#external-functions">External Functions</a></h1>
<p>A <code>POU</code> (<code>PROGRAM</code>, <code>FUNCTION</code>, <code>FUNCTION_BLOCK</code>) can be marked as external,
which will cause the compiler to ignore its implementation.</p>
<pre><code class="language-iecst">{external}
FUNCTION log : DINT
VAR_IN_OUT
  message : STRING[1024];
END_VAR
VAR_INPUT
  type : (Err,Warn,Info) := Info;
END_VAR
END_FUNCTION
</code></pre>
<p>At compilation time, the function <code>log</code> will be defined as an externally available function, and can be called from <code>ST</code> code.</p>
<blockquote>
<p>Note: At linking time, a <code>log</code> function with a compatible signature must be available on the system.</p>
</blockquote>
<h2 id="calling-c-functions"><a class="header" href="#calling-c-functions">Calling C functions</a></h2>
<p><code>ST</code> code can call into foreign functions natively.
To achieve this, the called function must be defined in a <code>C</code> compatible API, e.g. <code>extern "C"</code> blocks.</p>
<p>The interface of the function has to:</p>
<ul>
<li>either be included with the <code>-i</code> flag</li>
<li>or be declared in <code>ST</code> using the <code>{external}</code> keyword</li>
</ul>
<p>When including multiple header files/function interfaces, the <code>-i</code> flag must precede each individual file, e.g. <code>-i file1.st -i file2.st -i file3.st</code>. Alternatively, when including an entire folder with <code>-i '/liblocation/*.st'</code>, the path must be put in quotes, otherwise the command-line might parse the arguments in a way that is incompatible (i.e. does not precede each file with <code>-i</code>).</p>
<h3 id="example-4"><a class="header" href="#example-4">Example</a></h3>
<p>Given a <code>min</code> function defined in <code>C</code> as follows:</p>
<pre><code class="language-C">int min(int a, int b) {
//...
}
</code></pre>
<p>an interface of that function in <code>ST</code> can be defined as:</p>
<pre><code class="language-iecst">{external}
FUNCTION min : DINT
VAR_INPUT
  a : DINT;
  b : DINT;
END_VAR
END_FUNCTION
</code></pre>
<h3 id="variadic-arguments"><a class="header" href="#variadic-arguments">Variadic arguments</a></h3>
<p>Some foreign functions, especially ones defined in <code>C</code>, could be <a href="https://en.cppreference.com/w/c/variadic">variadic functions</a>.</p>
<p>These functions are usually defined with the last parameter <code>...</code>, and signify that a function can be called with unlimited parameters.</p>
<p>An example of a variadic function is <code>printf</code>.</p>
<p>Calling a variadic function is supported in <code>ST</code>. To mark an external function as variadic, you can add a parameter of type <code>...</code> to the <code>VAR_INPUT</code> block.</p>
<h4 id="variadic-function-example"><a class="header" href="#variadic-function-example">Variadic function example</a></h4>
<p>Given the <code>printf</code> function defined as:</p>
<pre><code class="language-C">int printf( const char *restrict format, ... );
</code></pre>
<p>the <code>ST</code> interface can be defined as:</p>
<pre><code class="language-iecst">{external}
FUNCTION printf : DINT
VAR_INPUT {ref}
  format : STRING;
END_VAR
VAR_INPUT
  args : ...;
END_VAR
END_FUNCTION
</code></pre>
<h4 id="runnable-example"><a class="header" href="#runnable-example">Runnable example</a></h4>
<p>With the <code>printf</code> function available on the system, there is no need to declare
the C function.</p>
<p>An <code>ST</code> program called <code>ExternalFunctions.st</code> with the following code can be declared:</p>
<pre><code class="language-iecst">(*ExternalFunctions.st*)

(**
 * The printf function's interface, marked as external since
 * it is defined directly along other ST functions
 *)
{external}
FUNCTION printf : DINT
VAR_INPUT {ref}
    format : STRING;
END_VAR
VAR_INPUT
    args: ...;
END_VAR
END_FUNCTION


(**
* The main function of the program prints a demo to the standard out
* The function main is implemented at this location and thus not marked
* as {external}
*)
FUNCTION main : DINT
VAR
    tmp : DINT;
END_VAR
  tmp := 1;
  printf('Value %d, %d, %d$N', tmp, tmp * 10, tmp * 100);
  main := tmp;
END_FUNCTION
</code></pre>
<p>Compiling the previous code with the following command:</p>
<pre><code class="language-sh">plc ExternalFunctions.st -o ExternalFunctions --linker=clang
</code></pre>
<p>will yield an executable called <code>ExternalFunctions</code>.</p>
<blockquote>
<p>We use clang to link the generated object file and generate an executable
since the embedded linker cannot generate executable files.</p>
</blockquote>
<p>The executable can then be started with <code>./ExternalFunctions</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="api-guidelines"><a class="header" href="#api-guidelines">API guidelines</a></h1>
<h2 id="1-introduction"><a class="header" href="#1-introduction">1. Introduction</a></h2>
<ul>
<li><strong>Purpose</strong>: Provide plc library developers with information how an interface for an application written in <code>IEC61131-3</code> should be designed and why.</li>
<li><strong>Scope</strong>: This guideline applies to all developers writing libraries for
use in IEC61131-3 applications.</li>
</ul>
<h2 id="2-api-guidelines"><a class="header" href="#2-api-guidelines">2. API Guidelines</a></h2>
<h3 id="21-var_in_out-instead-of-pointers"><a class="header" href="#21-var_in_out-instead-of-pointers">2.1 <code>VAR_IN_OUT</code> instead of pointers</a></h3>
<p>If a function takes a parameter for the purpose of reading and writing to it
a <code>VAR_IN_OUT</code> can be used instead of a pointer in the <code>VAR_INPUT</code>.</p>
<h3 id="22-function-and-function_block"><a class="header" href="#22-function-and-function_block">2.2 <code>FUNCTION</code> and <code>FUNCTION_BLOCK</code></a></h3>
<p><code>FUNCTION</code> and <code>FUNCTION_BLOCK</code> have similar properties, but they have fundamentally different representation in the compiler.
A <code>FUNCTION</code> is defined in a similar manner to a <code>C</code> function:</p>
<ul>
<li>It has no backing struct</li>
<li>values defined inside it will only persist for the duration of the function call</li>
</ul>
<p>Example:</p>
<pre><code class="language-iecst">FUNCTION myFunc : DINT
VAR_INPUT
  x  : DINT;
END_VAR
END_FUNCTION
</code></pre>
<pre><code class="language-c">int32_t myFunc(int32_t);
</code></pre>
<p>In contrast, a <code>FUNCTION_BLOCK</code> is backed by a struct and is globally accessible by a defined instance.
To declare a <code>FUNCTION_BLOCK</code>, a backing struct has to be declared and passed as a reference to the function block implementation.</p>
<blockquote>
<p><strong><em>NOTE:</em></strong> Due to OOP polymorphism features, all function blocks <strong>must</strong> include a <code>__vtable</code> parameter as the first field in their C struct representation. This vtable (virtual table) pointer enables dynamic method dispatch and polymorphic behavior. Since structured text does not support a <code>virtual</code> keyword, all function blocks have this vtable parameter regardless of whether they use inheritance or polymorphism. When interfacing with C code, this parameter must be included in the struct definition.</p>
</blockquote>
<pre><code class="language-iecst">FUNCTION_BLOCK myFb
VAR_INPUT
  x  : DINT;
END_VAR
END_FUNCTION_BLOCK
</code></pre>
<pre><code class="language-c">typedef struct {
  void* __vtable;
  int32_t x;
} myFunctStr;

void myFb(myFunctStr*);
</code></pre>
<h4 id="221-parameters"><a class="header" href="#221-parameters">2.2.1 Parameters</a></h4>
<p><code>FUNCTION</code> and <code>FUNCTION_BLOCK</code> may define input parameters. These are passed using the <code>VAR_INPUT</code> or <code>VAR_IN_OUT</code> blocks.
The difference between the two blocks is how the values are passed.
A <code>VAR_INPUT</code> variable is passed <em>by value</em>, while a <code>VAR_IN_OUT</code> variable is passed <em>by reference</em>.
In general, it is recommended to use a <code>VAR_IN_OUT</code> for data that needs to be both read and written, while <code>VAR_INPUT</code> should be reserved to read only values.</p>
<blockquote>
<p><strong><em>NOTE:</em></strong> In <code>FUNCTION</code>s complex datatypes are handled as pointers. They are however copied and changes in the function will have no effect on the actual variable.</p>
</blockquote>
<p>Examples:</p>
<p><code>FUNCTION</code>:</p>
<pre><code class="language-iecst">FUNCTION myFunc : DINT
VAR_INPUT
  myInt  : DINT;
  myString : STRING[255];
END_VAR

VAR_INPUT
  myRefStr : STRING;
END_VAR

VAR_IN_OUT
  myInOutInt : DINT;
END_VAR
END_FUNCTION
</code></pre>
<pre><code class="language-c">int32_t myFunc(int32_t myInt, char* myString, char* myRefStr, int32_t* myInOutInt);
</code></pre>
<p><code>FUNCTION_BLOCK</code>:</p>
<pre><code class="language-iecst">FUNCTION_BLOCK myFb
VAR_INPUT
  myInt  : DINT;
  myString : STRING[255];
END_VAR

VAR_IN_OUT
  myInOutInt : DINT;
END_VAR
END_FUNCTION_BLOCK
</code></pre>
<pre><code class="language-c">
typedef struct {
  void* __vtable;
  int32_t myInt;
  char myString[256];
  int32_t* myInOutInt;
} myFbStruct

void myFb(myFbStruct* myFbInstance);
</code></pre>
<h4 id="222-private-members"><a class="header" href="#222-private-members">2.2.2 Private members</a></h4>
<p>A <code>FUNCTION_BLOCK</code> often requires local (private) members to hold data across executions. These members have to be declared in the struct.
As a side effect, these variables are visible to the users.</p>
<p>For example:</p>
<pre><code>FUNCTION_BLOCK Count
VAR
  current : DINT;
END_VAR
END_FUNCTION_BLOCK
</code></pre>
<pre><code class="language-c">
typedef struct {
  void* __vtable;
  int32_t current;
} CountStruct;

void Count(CountStruct* countInst) {
  countInst-&gt;current = countInst-&gt;current + 1;
}
</code></pre>
<h4 id="223-return-values"><a class="header" href="#223-return-values">2.2.3 Return values</a></h4>
<p>A <code>FUNCTION</code> defines a return value in the signature, while a <code>FUNCTION_BLOCK</code> relies on <code>VAR_OUTPUT</code> definitions.</p>
<p>Example:</p>
<pre><code class="language-iecst">FUNCTION myFunc : DINT
  VAR_INPUT
    x : DINT;
  END_VAR
  VAR_IN_OUT
    y : DINT;
  END_VAR
END_FUNCTION
</code></pre>
<p>The C interface would look like:</p>
<pre><code class="language-c">int32_t myFunc(int32_t x, int32_t* y);
</code></pre>
<p>The return type for a function can also include complex datatypes, such as strings, arrays and structs.
Internally, complex return types are treated as reference parameters (pointers).</p>
<p>For complex return types, the function signature expects the return value as the first parameter.</p>
<p>Example:</p>
<pre><code class="language-iecst">FUNCTION myFunc : STRING
  VAR_INPUT
    x : DINT;
  END_VAR
  VAR_IN_OUT
    y : DINT;
  END_VAR
END_FUNCTION
</code></pre>
<p>The C interface would look like:</p>
<pre><code class="language-c">void myFunc(char* out, int32_t x, int32_t* y);
</code></pre>
<p>A <code>FUNCTION_BLOCK</code> should use <code>VAR_OUTPUT</code> for return values. Avoid using a
pointer in the <code>VAR_INPUT</code> as a return value.</p>
<p>Example:</p>
<pre><code class="language-iecst">FUNCTION_BLOCK myFb
  VAR_INPUT
    x : DINT;
  END_VAR
  VAR_IN_OUT
    y : DINT;
  END_VAR
  VAR_OUTPUT
    myOut: DINT;
    myOut2: STRING[255];
  END_VAR
END_FUNCTION
</code></pre>
<p>The C interface would look like:</p>
<pre><code class="language-c">typedef struct {
  void* __vtable;
  int32_t x;
  int32_t* y;
  int32_t myOut;
  char myOut2[256];

} myFbStruct;

void myFb(myFbStruct* myFbInst);
</code></pre>
<h3 id="224-when-to-use-a-function-vs-function_block"><a class="header" href="#224-when-to-use-a-function-vs-function_block">2.2.4 When to use a <code>FUNCTION</code> vs. <code>FUNCTION_BLOCK</code></a></h3>
<p>A <code>FUNCTION</code> can be well integrated into the API because of its return value which
can be nested into expressions. They however don't keep data over subsequent
executions. If you need to store static data use a <code>FUNCTION_BLOCK</code> or use
<code>VAR_IN_OUT</code>.</p>
<blockquote>
<p><strong><em>NOTE:</em></strong> Do not use <code>PROGRAM</code>s in your libraries
<code>PROGRAM</code>s have static instances. These are reserved for applications and should
not be used in libraries.</p>
</blockquote>
<h3 id="23-datatypes"><a class="header" href="#23-datatypes">2.3 Datatypes</a></h3>
<p>The IEC61131-3 Standard defines several datatypes with their intended uses.
To stay standard compliant, an API/Library should try and follow these guidelines.</p>
<h3 id="231-type-sizes"><a class="header" href="#231-type-sizes">2.3.1 Type sizes</a></h3>
<p>Datatypes are generally convertable to <code>C</code> equivalent. With the compiler defaulting to 64bit, some sizes were also fixed to 64bit.</p>
<p>Below is a table of types and how they can be used from <code>C</code></p>
<div class="table-wrapper"><table><thead><tr><th>type</th><th>c equivalent</th><th>size</th><th>comment</th></tr></thead><tbody>
<tr><td>BOOL</td><td>bool</td><td>8</td><td></td></tr>
<tr><td>BYTE</td><td>uint8_t</td><td>8</td><td>intended to be used as bit sequence and not as a number</td></tr>
<tr><td>SINT</td><td>int8_t</td><td>8</td><td></td></tr>
<tr><td>USINT</td><td>uint8_t</td><td>8</td><td></td></tr>
<tr><td>WORD</td><td>uint16_t</td><td>16</td><td></td></tr>
<tr><td>INT</td><td>int16_t</td><td>16</td><td></td></tr>
<tr><td>UINT</td><td>uint16_t</td><td>16</td><td></td></tr>
<tr><td>DINT</td><td>int32_t</td><td>32</td><td></td></tr>
<tr><td>DWORD</td><td>uint32_t</td><td>32</td><td></td></tr>
<tr><td>UDINT</td><td>uint32_t</td><td>32</td><td></td></tr>
<tr><td>LINT</td><td>int64_t</td><td>64</td><td></td></tr>
<tr><td>LWORD</td><td>uint64_t</td><td>64</td><td></td></tr>
<tr><td>ULINT</td><td>uint64_t</td><td>64</td><td></td></tr>
<tr><td>REAL</td><td>float_t</td><td>32</td><td></td></tr>
<tr><td>LREAL</td><td>double_t</td><td>64</td><td></td></tr>
<tr><td>TIME</td><td>time_t</td><td>64</td><td>Note that all time and date types are 64 bit</td></tr>
<tr><td>LTIME</td><td>time_t</td><td>64</td><td></td></tr>
<tr><td>DATE</td><td>time_t</td><td>64</td><td></td></tr>
<tr><td>LDATE</td><td>time_t</td><td>64</td><td></td></tr>
<tr><td>DATE_AND_TIME</td><td>time_t</td><td>64</td><td></td></tr>
<tr><td>LDATE_AND_TIME</td><td>time_t</td><td>64</td><td></td></tr>
<tr><td>DT</td><td>time_t</td><td>64</td><td></td></tr>
<tr><td>LDT</td><td>time_t</td><td>64</td><td></td></tr>
<tr><td>TIME_OF_DAY</td><td>time_t</td><td>64</td><td></td></tr>
<tr><td>LTIME_OF_DAY</td><td>time_t</td><td>64</td><td></td></tr>
<tr><td>TOD</td><td>time_t</td><td>64</td><td></td></tr>
<tr><td>LTOD</td><td>time_t</td><td>64</td><td></td></tr>
<tr><td>POINTER TO type</td><td>*type</td><td>64</td><td>The Pointer size is equivalent to <code>LWORD</code> and not <code>DWORD</code></td></tr>
<tr><td>REF_TO type</td><td>*type</td><td>64</td><td>Prefer this type to <code>POINTER TO</code> for standard compliance</td></tr>
<tr><td>STRING</td><td>uint8_t[]</td><td>var</td><td>UTF-8 String, null terminated. Default is 80 chars + 1 termination byte</td></tr>
<tr><td>WSTRING</td><td>uint16_t[]</td><td>var</td><td>UTF-16 (wide) String, null terminated. Default is 80 chars + 1 termination byte</td></tr>
</tbody></table>
</div>
<h3 id="232-using-types-in-interfaces"><a class="header" href="#232-using-types-in-interfaces">2.3.2 Using Types in interfaces</a></h3>
<p>When deciding on a type to use for a <code>FUNCTION</code>, <code>FUNCTION_BLOCK</code>, or <code>STRUCT</code> use a type that reflects the intention of the API:</p>
<ul>
<li>A bit sequence should be in a BIT type like <code>WORD</code> and not in a numeric type like <code>INT</code>.</li>
<li>A variable representing a time should be stored in the appropriate time type and not an <code>LINT</code> or <code>LWORD</code></li>
<li>A pointer should be stored as a <code>REF_TO</code> and not as an <code>LWORD</code> where possible.</li>
<li><code>(W)STRING</code>s and <code>ARRAY</code>s stored in <code>VAR</code>, <code>VAR_INPUT</code>, and <code>VAR_OUTPUT</code> sections of <code>FUNCTION_BLOCK</code>s are stored in the <code>FUNCTION_BLOCK</code>, and are passed by value.
<ul>
<li>A <code>VAR_IN_OUT</code> block can be used to force a type to be passed as a pointer. Note that <code>VAR_IN_OUT</code> is a read-write variable and changes to the parameter will change it for the caller.</li>
<li><code>FUNCTION</code>s expecting an <code>ARRAY</code> parameter can use the <code>ARRAY[*]</code> syntax (Variable sized array). The same functionality will be available for <code>STRING</code>. It is however not yet implemented.</li>
</ul>
</li>
</ul>
<h3 id="24-struct-alignment"><a class="header" href="#24-struct-alignment">2.4 Struct alignment</a></h3>
<p>Struct alignment in plc follows the default behaviour of <code>C</code>.
When developing a library in <code>C</code> a normal struct can be declared.
In langugages other than <code>C</code> the struct has to be <code>C</code> compatible. For example in <code>rust</code> the <code>#[repr(C)]</code> can be used to make the struct <code>C</code> compatible.</p>
<blockquote>
<p><strong><em>IMPORTANT:</em></strong> All <code>FUNCTION_BLOCK</code> structs must include a <code>__vtable</code> parameter as the first field. This is required for the OOP polymorphism implementation. The vtable is a <code>void*</code> pointer that points to the virtual function table for the function block instance. This affects struct layout and alignment when interfacing with external code.</p>
</blockquote>
<p>Example:</p>
<pre><code class="language-iecst">TYPE myStruct:
STRUCT
    x      : DINT;
    y      : REF_TO DINT;
    z      : ARRAY[0..255] OF BYTE;
END_STRUCT
END_TYPE
</code></pre>
<p>The <code>C</code> struct would look like:</p>
<pre><code class="language-c">
typedef struct {
  void* __vtable;
  int32_t x;
  int32_t* y;
  char z[256];

} myStruct;

</code></pre>
<p>The <code>rust</code> struct would look like</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::ffi::{c_void, c_char};

#[repr(C)]
pub struct myStruct {
    __vtable: *mut c_void,
    x: i32,
    y: *mut i32,
    z: [c_char; 256],
}
<span class="boring">}</span></code></pre></pre>
<h3 id="25-function_block-initialization"><a class="header" href="#25-function_block-initialization">2.5 <code>FUNCTION_BLOCK</code> initialization</a></h3>
<p>When creating a library with <code>FUNCTION_BLOCK</code>s, you can implement initialization logic that runs when an instance is created.</p>
<p>For more details on <code>FB_INIT</code> in IEC61131-3, refer to the <a href="libraries/../pous.html#function_block-initialization">Program Organization Units (POUs)</a> documentation.</p>
<h4 id="interoperability-with-libraries-written-in-other-languages"><a class="header" href="#interoperability-with-libraries-written-in-other-languages">Interoperability with libraries written in other languages</a></h4>
<p>When implementing a <code>FUNCTION_BLOCK</code> with initialization in C or other languages, you need to follow a specific naming convention for the initialization function.</p>
<p>For a C implementation:</p>
<ol>
<li>Define a struct that matches your <code>FUNCTION_BLOCK</code> variables:</li>
</ol>
<pre><code class="language-c">typedef struct {
    void* __vtable;
    int a;
    int b;
    // Other members as needed
} myFunctionBlock;
</code></pre>
<ol start="2">
<li>ruSTy expects a default-initializer to be present to initialize instances on the stack
(<code>VAR_TEMP</code> blocks or <code>VAR</code> blocks in functions or methods)</li>
</ol>
<p>This global instance follows the naming scheme of <code>__&lt;FunctionBlockName&gt;__init</code>, below is an example of a zero-initializer:</p>
<pre><code class="language-c">myFunctionBlock __myFunctionBlock__init = { 0 };
</code></pre>
<ol start="3">
<li>Optionally create an initialization function following the naming pattern <code>&lt;FunctionBlockName&gt;__FB_INIT</code>:</li>
</ol>
<pre><code class="language-c">void myFunctionBlock__FB_INIT(myFunctionBlock* fb_instance) {
    // Initialize members here
    fb_instance-&gt;a = 1;
    fb_instance-&gt;b = 2;
    
    // ...perform any other needed initialization
}
</code></pre>
<ol start="4">
<li>In your IEC61131-3 declaration (e.g., in a header file [<code>*.pli</code>]), ensure your <code>FUNCTION_BLOCK</code> includes the <code>FB_INIT</code> method (if present):</li>
</ol>
<pre><code>{external}
FUNCTION_BLOCK myFunctionBlock
VAR
    a : DINT;
    b : DINT;
END_VAR
    METHOD FB_INIT
    END_METHOD
END_FUNCTION_BLOCK
</code></pre>
<p>Note that the <code>FB_INIT</code> method doesn't need implementation details in the IEC61131-3 declaration when using an external implementation - the declaration just signals that initialization is available.</p>
<h4 id="project-wide-initialization-1"><a class="header" href="#project-wide-initialization-1">Project-wide initialization</a></h4>
<p>See <a href="libraries/../using_rusty.html#project-wide-initialization">Project-wide initialization</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="program-organization-unit-pou"><a class="header" href="#program-organization-unit-pou">Program Organization Unit (POU)</a></h1>
<h2 id="definition"><a class="header" href="#definition">Definition</a></h2>
<p>A POU is a executable unit available in an IEC61131-3 application.
It can be defined as either a Program, a Function, a Function Block, or an Action.</p>
<blockquote>
<p>Methods on classes are also considered POUs but are not covered by this document</p>
</blockquote>
<p>A POU is defined as:</p>
<pre><code class="language-iecst">&lt;POU Type&gt; name
(* parameters *)

(* code *)
END_&lt;POU Type&gt;
</code></pre>
<h3 id="parameters"><a class="header" href="#parameters">Parameters</a></h3>
<p>POUs can use input, output, or in/out parameters to pass data to the outside.
Such parameters are defined in a <em>variable block</em>  delimeted by <code>VAR_&lt;TYPE&gt;</code> and <code>END_VAR</code>
Supported parameter types are <code>VAR_INPUT</code>, <code>VAR_INPUT {ref}</code>, <code>VAR_OUTPUT</code> and <code>VAR_IN_OUT</code></p>
<h4 id="input"><a class="header" href="#input">Input</a></h4>
<p>Input parameters are typically copied into the target POU to be stored and read for later references.</p>
<p>A definition for input parameters is as follows:</p>
<pre><code class="language-iecst">VAR_INPUT
    a : INT;
END_VAR
</code></pre>
<p>In some cases, especially when passing large strings or arrays, or when interacting with foreign code (see <a href="libraries/external_functions.html">External Functions</a>) it is more efficient to avoid copying the variable values and just use a pointer to the required input.
This can be done either using the in/out variables or by specifying a special property <code>ref</code> on the input block.</p>
<p>Example:</p>
<pre><code class="language-iecst">VAR_INPUT {ref}
    a : STRING;
END_VAR
</code></pre>
<p>Note that passing the ref property will convert all variables in that block to pointers, and should only be used in Functions.</p>
<h4 id="in-out"><a class="header" href="#in-out">In Out</a></h4>
<p>In/Out parameters are required parameters that are always passed by reference.
They can be modified by the POU the call, and the changes are applied directly to the passed variable.
An In/Out parameter must always be passed in a POU call and cannot be stored.</p>
<h4 id="output-1"><a class="header" href="#output-1">Output</a></h4>
<p>Output parameters are used to return the result(s) of the POU call.
They are passed by reference, but are optional.
If an output parameter is not passed in a call, its value is not persisted.</p>
<h3 id="variables"><a class="header" href="#variables">Variables</a></h3>
<p>In addition to parameters, a POU contains local variables, these can either be stored in the POU for later reference (<code>VAR</code>) or only created for a single call (<code>VAR_TEMP</code>)
In a function, all local variables are temporary.</p>
<h2 id="specialization"><a class="header" href="#specialization">Specialization</a></h2>
<p>In addition to the default behavior, each type of POU has some special cases.</p>
<h3 id="function"><a class="header" href="#function">Function</a></h3>
<p>Functions are <em>stateless</em> sequences of callable code. They are not backed by any structs, and cannot hold any state accross multiple calls.
A function's input parameter can be passed by value, or by reference.</p>
<p>Functions also support a return type, the resulting definition is:</p>
<pre><code class="language-iecst">    FUNCTION fnName : &lt;TYPE&gt;
    (* parameters *)
    VAR_INPUT (* by value *)
        x : INT;
    END_VAR
    VAR_INPUT {ref} (* by reference *)
        x : INT;
    END_VAR
    (* temporary variables *)
    VAR
        y : INT;
    END_VAR
    VAR_TEMP
        z : INT;
    END_VAR

    (* code *)
    END_FUNCTION
</code></pre>
<h3 id="program"><a class="header" href="#program">Program</a></h3>
<p>Programs are a static (i.e. <code>GLOBAL</code>) <code>STRUCT</code> that holds its state accross multiple calls.
A Program exists once, and only once in an application, and subsequent calls to a program will change and store the passed parameters as well as internal variables.
A program does not support passing input parameters by reference.</p>
<p>Example:</p>
<pre><code class="language-iecst">PROGRAM prg
(* parameters *)
VAR_INPUT
    x : INT;
END_VAR
(* persisted variables *)
VAR
    y : INT;
END_VAR
(* temporary variables *)
VAR_TEMP
    z : INT;
END_VAR
(* code *)
END_PROGRAM
</code></pre>
<h3 id="function-block"><a class="header" href="#function-block">Function Block</a></h3>
<p>A function block is a <code>STRUCT</code> that can be initialized multiple times using different variables (i.e <code>instance</code>s).
A function block instance can hold its state (including input parameters) across multiple calls, but does not share any state with different instances.
A function block does not support passing input parameters by reference.</p>
<pre><code class="language-iecst">FUNCTION_BLOCK fb
(* parameters *)
VAR_INPUT
    x : INT;
END_VAR
(* persisted variables *)
VAR
    y : INT;
END_VAR
(* temporary variables *)
VAR_TEMP
    z : INT;
END_VAR
(* code *)
END_FUNCTION_BLOCK
</code></pre>
<h4 id="function_block-initialization"><a class="header" href="#function_block-initialization"><code>FUNCTION_BLOCK</code> initialization</a></h4>
<p>Function blocks can define a special method called <code>FB_INIT</code> that is automatically called when an instance is created. This is analogous to a constructor in object-oriented programming.</p>
<p>The <code>FB_INIT</code> method allows you to initialize the function block's variables to specific values. It is called during program initialization before any other code runs.</p>
<p><code>FB_INIT</code> methods can neither have parameters nor a return type in their current implementation - violating this contract will lead to undefined behaviour at runtime.</p>
<pre><code class="language-iecst">FUNCTION_BLOCK MyFB
VAR
    x : INT;
    y : INT;
END_VAR
    METHOD FB_INIT
        x := 1;
        y := 2;
    END_METHOD

    // Other methods and code...
END_FUNCTION_BLOCK
</code></pre>
<h3 id="action"><a class="header" href="#action">Action</a></h3>
<p>An action is represented by a parent struct, and does not define its own interface (VAR blocks).
An action can only be defined for Programs and Function Blocks.</p>
<p>An action is defined in 3 different ways, either in a container (<code>ACTIONS</code>) directly below the POU, in a named <code>ACTIONS</code> container, or using a qualified name on the action.</p>
<p>Example:</p>
<pre><code class="language-iecst">FUNCTION_BLOCK fb
(* parameters *)
VAR_INPUT
    x : INT;
END_VAR
(* persisted variables *)
VAR
    y : INT;
END_VAR
(* temporary variables *)
VAR_TEMP
    z : INT;
END_VAR
(* code *)
END_FUNCTION_BLOCK

ACTIONS (* implicitly belongs to FB *)
    ACTION act
    (* code *)
    END_ACTION
END_ACTIONS

ACTIONS fb (* explicitly belongs to FB *)
    ACTION act2
    (* code *)
    END_ACTION
END_ACTIONS

ACTION fb.act3 (* linked to FB with name definition *)
(* code *)
END_ACTION
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="variables-1"><a class="header" href="#variables-1">Variables</a></h1>
<h1 id="constants"><a class="header" href="#constants">Constants</a></h1>
<p>Variable declaration blocks can be delcared as CONSTANT.
All variables of a constant declaration block become constants.
Constant variables can not be changed and need to be initialized.</p>
<h2 id="example-5"><a class="header" href="#example-5">Example</a></h2>
<pre><code class="language-iecst">TYPE OneInt : INT := 1; END_TYPE

VAR_GLOBAL CONSTANT
    MAX_SIZE : INT := 99;
    MIN_LEN : INT := 1;
    counter : OneInt;  (* 1 *)
END_VAR

PROGRAM PLC_PRG
    VAR CONSTANT
        DEFAULT_INPUT : BOOL := FALSE;
    END_VAR
END_PROGRAM
</code></pre>
<h2 id="variable-initialization"><a class="header" href="#variable-initialization">Variable Initialization</a></h2>
<p>Initializers of variables are evaluated at compile time.
Therefore they can only consist of literals, other constants or expressions consisting of a combination of them.
Note that initializers must not contain recursive definitions.</p>
<p>If a variable has no initializer, the variable may be initialized with it's datatype's default value or else with <code>0</code>.</p>
<h3 id="array-initialization"><a class="header" href="#array-initialization">Array Initialization</a></h3>
<p>Arrays can be initialized using array literals.
If the array-initial value does not contain all required elements, the array's inner type's default value will be used to fill the missing values.</p>
<h2 id="example-6"><a class="header" href="#example-6">Example</a></h2>
<pre><code class="language-iecst">TYPE SignalValue : INT := -1; END_TYPE

VAR_GLOBAL CONSTANT
    MIN_LEN : INT := 1;
    MAX_LEN : INT := 100;

    SIZE : INT := MAX_LEN - MIN_LEN;
END_VAR

PROGRAM PLC_PRG
    VAR_INPUT
        signals: ARRAY[0..SIZE] OF SignalValue := [99, 99]; (* rest is -1 *)
    END_VAR

    ...
END_PROGRAM
</code></pre>
<h3 id="pointer-initialization"><a class="header" href="#pointer-initialization">Pointer Initialization</a></h3>
<p>A pointer variable can be initialized with the address of a global reference or an IEC-address using the <code>AT</code> or <code>REFERENCE TO</code> syntax. <code>REF_TO</code> pointers can be initialized using the built-in <code>REF</code> function in its initializer.</p>
<p>This initialization, however, does not take place during compile time. Instead, each pointer initialized with an address will be zero-initialized to a null pointer by default. The compiler collects all pointer initializations during compilation and creates internal initializer functions for each POU. These functions are then called in a single overarching project-initialization function, which can be called either manually in your main function or by a runtime. Additionally, global variables — whether they are initialized pointers or POU instances containing pointer initializers — are also assigned within this overarching function.</p>
<p>This function follows a naming scheme (<code>__init___&lt;project name&gt;</code>) that varies slightly depending on whether a build config (<code>plc.json</code>) was used.</p>
<ul>
<li>
<p><strong>When using a build config (<code>plc.json</code>)</strong>, the project name is used:</p>
<p><em>Build config snippet:</em></p>
<pre><code class="language-json">{
    "name": "myProject",
    "files": []
}
</code></pre>
<p><em>Resulting symbol:</em></p>
<pre><code class="language-iecst">    __init___myProject()
</code></pre>
</li>
<li>
<p><strong>When compiling without a build config</strong>, the name of the first file passed via CLI is used as the base for the name.</p>
<p><em>CLI command:</em></p>
<pre><code class="language-bash">    # build command
    plc myFile1.st myFile2.st
</code></pre>
<p><em>Resulting symbol:</em></p>
<pre><code class="language-iecst">    __init___myFile1_st()
</code></pre>
</li>
</ul>
<p>It is important to note that if there are pointer initializations present in your project, failing to call the initialization function in your runtime or in <code>main</code> will result in <strong>null pointer dereferences</strong> at runtime.</p>
<h3 id="example-7"><a class="header" href="#example-7">Example</a></h3>
<p><em>myProject.st</em>:</p>
<pre><code class="language-iecst">VAR_GLOBAL
    myGlobal : STRING;
END_VAR

PROGRAM prog
VAR
    myString : REF_TO STRING := REF(myGlobal);
    myOtherString : REFERENCE TO STRING REF= myGlobal;
    myAlias AT myGlobal: STRING;
    myAnalogSignal AT %IX1.0 : REAL;
END_VAR
    // ...
END_PROGRAM

FUNCTION main: DINT
    __init___myProject_st();
    prog();
END_FUNCTION
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="datatypes-1"><a class="header" href="#datatypes-1">Datatypes</a></h1>
<h2 id="numeric-types"><a class="header" href="#numeric-types">Numeric types</a></h2>
<p>A variety of numeric types exist with different sizes and properties complying with IEC61131.</p>
<h3 id="overview"><a class="header" href="#overview">Overview</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Type name</th><th>Size</th><th>Properties</th></tr></thead><tbody>
<tr><td>SINT</td><td>8 bit</td><td>signed</td></tr>
<tr><td>USINT</td><td>8 bit</td><td>unsigned</td></tr>
<tr><td>INT</td><td>16 bit</td><td>signed</td></tr>
<tr><td>UINT</td><td>16 bit</td><td>unsigned</td></tr>
<tr><td>DINT</td><td>32 bit</td><td>signed</td></tr>
<tr><td>UDINT</td><td>32 bit</td><td>unsigned</td></tr>
<tr><td>LINT</td><td>64 bit</td><td>signed</td></tr>
<tr><td>ULINT</td><td>64 bit</td><td>unsigned</td></tr>
<tr><td>REAL</td><td>32 bit</td><td>float</td></tr>
<tr><td>LREAL</td><td>64 bit</td><td>float</td></tr>
</tbody></table>
</div>
<p>When such a variable is declared without being initialized, it will
be default-initialized with a value of <code>0</code> or <code>0.0</code> respectively.</p>
<h3 id="a-word-on-integer-literals"><a class="header" href="#a-word-on-integer-literals">A word on integer literals</a></h3>
<p>Integer literals can be prefixed with either <code>2#</code> (binary), <code>8#</code> (octal) or <code>16#</code> (hexadecimal).
They will then be treated with regard to the respective number system.</p>
<p>Examples:</p>
<ul>
<li><code>i1 : DINT := 42;</code> - declares and initializes a 32bit signed integer with value 42.</li>
<li><code>i1 : DINT := 2#101010;</code> - declares and initializes a 32bit signed integer with value 42.</li>
<li><code>i1 : DINT := 8#52;</code> - declares and initializes a 32bit signed integer with value 42.</li>
<li><code>i1 : DINT := 16#2A;</code> - declares and initializes a 32bit signed integer with value 42.</li>
</ul>
<h2 id="strings"><a class="header" href="#strings">Strings</a></h2>
<h3 id="overview-1"><a class="header" href="#overview-1">Overview</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Type name</th><th>Size</th><th>Encoding</th></tr></thead><tbody>
<tr><td>STRING</td><td>n+1</td><td>UTF-8</td></tr>
<tr><td>WSTRING</td><td>2n+2</td><td>UTF-16</td></tr>
</tbody></table>
</div>
<p>When such a variable is declared without being initialized, it will
be default-initialized with a value of '' or "" respectively (empty strings).</p>
<h3 id="string"><a class="header" href="#string">STRING</a></h3>
<p>RuSTy treats <code>STRING</code>s as byte-arrays storing UTF-8 character bytes with a Null-terminator (0-byte) at the end.
So a String of size n requres n+1 bytes to account for the Null-terminator.
A <code>STRING</code> literal is surrounded by single-ticks <code>'</code>.</p>
<p>A String has a well defined length which can be defined similar to the array-syntax.
A String-variable <code>myVariable: STRING[20]</code> declares a byte array of length 21, to store 20 utf8 character bytes.
When declaring a <code>STRING</code>, the length-attribute is optional. The default length is 80.</p>
<p>Examples:</p>
<ul>
<li><code>s1 : STRING;</code> - declares a String of length 80.</li>
<li><code>s2 : STRING[20];</code> - declares a String of length 20.</li>
<li><code>s3 : STRING := 'Hello World';</code> - declares and initializes a String of length 80, and initializes it with the utf8 characters and a null-terminator at the end.</li>
<li><code>s4 : STRING[55] := 'Foo Baz';</code> - declares and initializes a String of length 55 and initializes it with the utf8 characters and a null-terminator at the end.</li>
</ul>
<h3 id="wstring-wide-strings"><a class="header" href="#wstring-wide-strings">WSTRING (Wide Strings)</a></h3>
<p>RuSTy treats <code>WSTRING</code>s as byte-arrays storing UTF-16 character bytes with two Null-terminator bytes at the end.
The bytes are stored in Little Endian encoding.
A Wide-String of size n requres 2 * (n+1) bytes to account for the 2 byes per utf16 character and the Null-terminators.
A <code>WSTRING</code> literal is surrounded by doubly-ticks <code>"</code>.</p>
<p>A <code>WSTRING</code> has a well defined length which can be defined similar to the array-syntax.
A <code>WSTRING</code>-variable <code>myVariable: WSTRING[20]</code> declares a byte array of length 42, to store 20 utf16 character bytes.
When declaring a <code>WSTRING</code>, the length-attribute is optional. The default length is 80.</p>
<p>Examples:</p>
<ul>
<li><code>ws1 : WSTRING;</code> - declares a Wide-String of length 80.</li>
<li><code>ws2 : WSTRING[20];</code> - declares a Wide-String of length 20.</li>
<li><code>ws3 : WSTRING := "Hello World";</code> - declares and initializes a Wide-String of length 80, and initializes it with the utf16 characters and a utf16-null-terminator at the end.</li>
<li><code>ws4 : WSTRING[55] := "Foo Baz";</code> - declares and initializes a Wide-String of length 55 and initializes it with the utf8 characters and a utf16-null-terminator at the end.</li>
</ul>
<h2 id="date-and-time"><a class="header" href="#date-and-time">Date and Time</a></h2>
<h3 id="overview-2"><a class="header" href="#overview-2">Overview</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Type name</th><th>Size</th><th>Internally stored as</th></tr></thead><tbody>
<tr><td>TIME</td><td>64 bit</td><td>Timespan in nanoseconds</td></tr>
<tr><td>TIME_OF_DAY</td><td>64 bit</td><td>Nanoseconds since Jan 1, 1970 UTC</td></tr>
<tr><td>DATE</td><td>64 bit</td><td>Nanoseconds since Jan 1, 1970 UTC</td></tr>
<tr><td>DATE_AND_TIME</td><td>64 bit</td><td>Nanoseconds since Jan 1, 1970 UTC</td></tr>
</tbody></table>
</div>
<p>Note that RuSTy already treats <code>TIME</code>, <code>TIME_OF_DAY</code>, <code>DATE</code> and <code>DATE_AND_TIME</code> as 64 bit numbers.
Therefore the long pendants <code>LTIME</code>, <code>LTOD</code>, <code>LDATE</code> and <code>LDT</code> are mere aliases to the original types.</p>
<h3 id="date"><a class="header" href="#date">DATE</a></h3>
<p>The <code>DATE</code> datatype is used to represent a Date in the Gregorian Calendar.
Such a value is stored as an i64 with a precision in nanoseconds and denotes the number of nanoseconds
that have elapsed since January 1, 1970 UTC not counting leap seconds.
DATE literals start with <code>DATE#</code> or <code>D#</code> followed by a date in the format of <code>yyyy-mm-dd</code>.</p>
<p>Examples:</p>
<ul>
<li><code>d1 : DATE := DATE#2021-05-02;</code></li>
<li><code>d2 : DATE := DATE#1-12-24;</code></li>
<li><code>d3 : DATE := D#2000-1-1;</code></li>
</ul>
<h3 id="date_and_time"><a class="header" href="#date_and_time">DATE_AND_TIME</a></h3>
<p>The <code>DATE_AND_TIME</code> datatype is used to represent a certain point in time in the Gregorian Calendar.
Such a value is stored as an <code>i64</code> with a precision in nanoseconds and denotes the
number of nanoseconds that have elapsed since January 1, 1970 UTC not counting leap seconds.
DATE_AND_TIME literals start with <code>DATE_AND_TIME#</code> or <code>DT#</code> followed by a date and time in the
format of <code>yyyy-mm-dd-hh:mm:ss</code>.</p>
<p>Note that only the seconds-segment can have a fraction denoting the milliseconds.</p>
<p>Examples:</p>
<ul>
<li><code>d1 : DATE_AND_TIME := DATE_AND_TIME#2021-05-02-14:20:10.25;</code></li>
<li><code>d2 : DATE_AND_TIME := DATE_AND_TIME#1-12-24-00:00:1;</code></li>
<li><code>d3 : DATE_AND_TIME := DT#1999-12-31-23:59:59.999;</code></li>
</ul>
<h3 id="time_of_day"><a class="header" href="#time_of_day">TIME_OF_DAY</a></h3>
<p>The <code>TIME_OF_DAY</code> datatype is used to represent a specific moment in time in a day.
Such a value is stored as an <code>i64</code> value with a precision in nanoseconds and denotes the
number of nanoseconds that have elapsed since January 1, 1970 UTC not counting leap seconds.
Hence this value is stored as a <code>DATE_AND_TIME</code> with the day fixed to 1970-01-01.
<code>TIME_OF_DAY</code> literals start with <code>TIME_OF_DAY#</code> or <code>TOD#</code> followed by a time in the
format of <code>hh:mm:ss</code>.</p>
<p>Note that only the seconeds-segment can have a fraction denoting the milliseconds.</p>
<p>Examples:</p>
<ul>
<li><code>t1 : TIME_OF_DAY := TIME_OF_DAY#14:20:10.25;</code></li>
<li><code>t2 : TIME_OF_DAY := TIME_OF_DY#0:00:1;</code></li>
<li><code>t3 : TIME_OF_DAY := TOD#23:59:59.999;</code></li>
</ul>
<h3 id="time"><a class="header" href="#time">TIME</a></h3>
<p>The <code>TIME</code> datatype is used to represent a time-span.
A <code>TIME</code> value is stored as an <code>i64</code> value with a precision in nanoseconds.
TIME literals start with <code>TIME#</code> or <code>T#</code> followed by the <code>TIME</code> segements.</p>
<p>Supported segements are:</p>
<ul>
<li><code>d</code> ... <code>f64</code> days</li>
<li><code>h</code> ... <code>f64</code> hours</li>
<li><code>m</code> ... <code>f64</code>minutes</li>
<li><code>s</code> ... <code>f64</code> seconds</li>
<li><code>ms</code> ... <code>f64</code> milliseconds</li>
<li><code>us</code> ... <code>f64</code> microseconds</li>
<li><code>ns</code> ... <code>u32</code> nanaoseconds</li>
</ul>
<p>Note that only the last segment of a <code>TIME</code> literal can have a fraction.</p>
<p>Examples:</p>
<ul>
<li><code>t1 : TIME := TIME#2d4h6m8s10ms;</code></li>
<li><code>t2 : TIME := T#2d4.2h;</code></li>
<li><code>t3 : TIME := T#-10s4ms16ns;</code></li>
</ul>
<h2 id="other-types"><a class="header" href="#other-types">Other types</a></h2>
<p>The <code>BOOL</code> type can either be assigned <code>TRUE</code> or <code>FALSE</code>.
The type <code>__VOID</code> is the empty type and has an undefined size.</p>
<div class="table-wrapper"><table><thead><tr><th>Type name</th><th>Size</th><th>Properties</th></tr></thead><tbody>
<tr><td>BOOL</td><td>8 bit</td><td>signed</td></tr>
<tr><td>__VOID</td><td>undefined</td><td></td></tr>
</tbody></table>
</div>
<p>Bit datatypes are defined as follows:</p>
<div class="table-wrapper"><table><thead><tr><th>Type name</th><th>Size</th><th>Properties</th></tr></thead><tbody>
<tr><td>BYTE</td><td>8 bit</td><td>unsigned</td></tr>
<tr><td>WORD</td><td>16 bit</td><td>unsigned</td></tr>
<tr><td>DWORD</td><td>32 bit</td><td>unsigned</td></tr>
<tr><td>LWORD</td><td>64 bit</td><td>unsigned</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="direct-bit-access-on-variables"><a class="header" href="#direct-bit-access-on-variables">Direct (Bit) Access on Variables</a></h1>
<p>The IEC61131-3 Standard allows reading specific <code>Bits</code>, <code>Bytes</code>, <code>Words</code> or <code>DWords</code> from an <code>ANY_BIT</code> type.
RuSTy supports this functionalty and extends it to support all <code>INT</code> types.</p>
<h2 id="constant-based-direct-access"><a class="header" href="#constant-based-direct-access">Constant based Direct Access</a></h2>
<p>To access a bit sequence in a variable, a direct access instruction <code>%&lt;Type&gt;&lt;Value&gt;</code> is used.</p>
<p><code>Type</code> is the bit sequence size required and is described as follows:</p>
<div class="table-wrapper"><table><thead><tr><th>Type</th><th>Size</th><th>Example</th></tr></thead><tbody>
<tr><td>X</td><td>1</td><td>`%X1</td></tr>
<tr><td>B</td><td>8</td><td>`%B1</td></tr>
<tr><td>W</td><td>16</td><td>`%W1</td></tr>
<tr><td>D</td><td>32</td><td>`%D1</td></tr>
</tbody></table>
</div>
<blockquote>
<p><em>For <code>Bit</code> access, the <code>%X</code> is optional.</em></p>
</blockquote>
<h3 id="example-8"><a class="header" href="#example-8">Example</a></h3>
<pre><code class="language-st">FUNCTION main : DINT
VAR
    variable    : LWORD;
    bitTarget   : BOOL;
    bitTarget2  : BOOL;
    byteTarget  : BYTE;
    wordTarget  : WORD;
    dwordTarget : DWORD;
END_VAR

variable    := 16#AB_CD_EF_12_34_56_78_90;
bitTarget   := variable.%X63; (*Access last bit*)
byteTarget  := variable.%B7; (*Access last byte*)
wordTarget  := variable.%W3; (*Access last word*)
dwordTarget := variable.%D1; (*Access last dword*)
(*Chaining an access is also allowed *)
bitTarget2  := variable.%D1.%W1.%B1.%X1;

END_FUNCTION
</code></pre>
<h2 id="varirable-based-direct-access"><a class="header" href="#varirable-based-direct-access">Varirable based Direct Access</a></h2>
<p>While the IEC61131-3 Standard only defines variable access using constant int literals,
RuSTy additionally supports access using Variables.
The Syntax for a variable based access is <code>%&lt;Type&gt;&lt;Variable&gt;</code>.
The provided varibale has to be a direct Reference variable (non Qualified).</p>
<blockquote>
<p><em>Short hand access for Bit (Without the <code>%X</code> modifier) is not allowed.</em></p>
</blockquote>
<h3 id="example-9"><a class="header" href="#example-9">Example</a></h3>
<pre><code class="language-st">FUNCTION main : DINT
VAR
    variable    : LWORD;
    access_var  : INT;
    bitTarget   : BOOL;
    bitTarget2  : BOOL;
    byteTarget  : BYTE;
    wordTarget  : WORD;
    dwordTarget : DWORD;
END_VAR
variable    := 16#AB_CD_EF_12_34_56_78_90;
access_var := 63;
bitTarget   := variable.%Xaccess_var; (*Access last bit*)
access_var := 7;
byteTarget  := variable.%Baccess_var; (*Access last byte*)
access_var := 3;
wordTarget  := variable.%Waccess_var; (*Access last word*)
access_var := 1;
dwordTarget := variable.%Daccess_var; (*Access last dword*)
(*Chaining an access is also allowed *)
bitTarget2  := variable.%Daccess_var.%Waccess_var.%Baccess_var.%Xaccess_var;
END_FUNCTION
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="architecture"><a class="header" href="#architecture">Architecture</a></h1>
<h2 id="overview-3"><a class="header" href="#overview-3">Overview</a></h2>
<p>RuSTy is a compiler for IEC61131-3 languages. At the moment, ST and CFC ("FBD") are supported.
It utilizes the LLVM compiler infrastructurue and contributes a <a href="https://en.wikipedia.org/wiki/Structured_text">Structured Text</a> frontend that translates Structured Text into LLVM's language independent intermediate representation (IR).
<a href="arch/../cfc/cfc.html">CFC</a> uses a M2M-transformation and reuses most of the ST frontend for compilation.
The further optimization and native code generation is performed by the existing LLVM infrastructure, namely LLVM's common optimizer and the platform specific backend (see <a href="https://www.aosabook.org/en/llvm.html">here</a>).</p>
<pre><code class="language-ignore">    ┌──────────────────┐    ┌───────────────┐    ┌────────────────┐
    │                  │    │               │    │                │
    │      RuSTy       │    │  LLVM Common  │    │  LLVM Backend  │
    │                  ├───►│               ├───►│                │
    │  LLVM Frontend   │    │   Optimizer   │    │   (e.g Clang)  │
    │                  │    │               │    │                │
    └──────────────────┘    └───────────────┘    └────────────────┘
</code></pre>
<p>So RuSTy consists of the frontend part of the llvm compiler-infrastructure.
This means that this compiler can benefit from llvm's existing compiler-optimizations, as well as all backend target platforms available.</p>
<h2 id="rusty-frontend-architecture"><a class="header" href="#rusty-frontend-architecture">Rusty Frontend Architecture</a></h2>
<p>Ultimately the goal of a compiler frontend is to translate the original source code into the infrastructure's intermediate representation  (in this case we're talking about <a href="https://llvm.org/docs/LangRef.html">LLVM IR</a>).
RuSTy treats this task as a compilation step of its own.
While a fully fledged compiler generates machine code as a last step, RuSTy generates LLVM IR assembly code.</p>
<h2 id="structured-text"><a class="header" href="#structured-text">Structured Text</a></h2>
<pre><code class="language-ignore">      ┌────────┐                                                          ┌────────┐
      │ Source │                                                          │  LLVM  │
      │        │                                                          │   IR   │
      │ Files  │                                                          │        │
      └───┬────┘                                                          └────────┘
          │                                                                    ▲
          ▼                                                                    │
    ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌──────┴─────┐
    │            │   │            │   │            │   │            │   │            │
    │            │   │            │   │            │   │            │   │            │
    │   Parser   ├──►│   Indexer  ├──►│   Linker   ├──►│ Validation ├──►│   Codegen  │
    │            │   │            │   │            │   │            │   │            │
    │            │   │            │   │            │   │            │   │            │
    └────────────┘   └────────────┘   └────────────┘   └────────────┘   └────────────┘
</code></pre>
<h2 id="cfcfbd"><a class="header" href="#cfcfbd">CFC/FBD</a></h2>
<pre><code class="language-ignore">         ┌────────┐                                                            ┌────────┐
         │ Source │                                                            │  LLVM  │
         │        │                                                            │   IR   │
         │ Files  │                                                            │        │
         └───┬────┘                                                            └────────┘
             │                                                                      ▲
             ▼                                                                      │
    ┌────────────────┐    ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌──────┴─────┐
    │                │    │            │   │            │   │            │   │            │
    │ Model-to-Model │    │            │   │            │   │            │   │            │
    │ Transformation ├───►│   Indexer  ├──►│   Linker   ├──►│ Validation ├──►│   Codegen  │
    │                │    │            │   │            │   │            │   │            │
    │                │    │            │   │            │   │            │   │            │
    └────────────────┘    └────────────┘   └────────────┘   └────────────┘   └────────────┘
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="parser"><a class="header" href="#parser">Parser</a></h1>
<p>The role of the parser is to turn source-code which is fed as a string (in the form of files) into a tree-representation of that source-code.
This tree is typically called the <em>Abstract Syntax Tree (AST)</em>.
The step of parsing consists of two distinct stages.
The first one is the <em>lexical analysis (Lexer)</em> which is performed by a lexer.
After lexing we perform the <em>syntactical analysis (Parser)</em> to construct the syntax tree.</p>
<pre><code class="language-ignore">                                                                   ┌──┐
       ┌──────────────┐                                            │  │
       │              │                                            └──┘
       │  Source Code │                                            /  \
       │              │   ┌─────────┐        ┌──────────┐         /    \
       │  ──────────  │   │         │        │          │     ┌──┐      ┌──┐
       │              ├───►  Lexer  │        │  Parser  ├────►│  │      │  │
       │  ─────────   │   │         │        │          │     └──┘      └──┘
       │              │   └────┬────┘        └──────────┘      /\        /\
       │  ────        │        │                  ▲           /  \      /  \
       │              │        │                  │        ┌──┐ ┌──┐ ┌──┐ ┌──┐
       │  ────────    │        ▼                  │        │  │ │  │ │  │ │  │
       │              │   ┌───────────────────────┴──┐     └──┘ └──┘ └──┘ └──┘
       │              │   │                          │
       └──────────────┘   │  ┌───┐ ┌───┐ ┌───┐ ┌───┐ │       Abstract Syntax
                          │  │ T │ │ T │ │ T │ │...│ │            Tree
                          │  └───┘ └───┘ └───┘ └───┘ │
                          │                          │
                          └──────────────────────────┘
                                 Token-Stream
</code></pre>
<h2 id="lexer"><a class="header" href="#lexer">Lexer</a></h2>
<p>The lexer performs the lexical analysis.
This step turns the source-string into a sequence of well known tokens.
The Lexer (or sometimes also called <em>tokenizer</em>) splits the source-string into <em>tokens</em> (or <em>words</em>).
Each token has a distinct type which corresponds to a grammar's element.
Typical token-types are keywords, numbers, identifiers, brackets, dots, etc.
So with the help of this token-stream it is much easier for the parser to spot certain patterns.
E.g. a floating-point number consists of the token-sequence: <em>number</em>, <em>dot</em>, <em>number</em>.</p>
<p>The lexer is implemented in the <code>lexer</code>-module.
It uses the <a href="https://github.com/maciejhirsz/logos">logos</a> crate to create a lexer that is able to identify all different terminal-symbols.
Compared to other languages, Structured Text has a quite high number of keywords and other tokens, so RuSTy's lexer identifies a quite large number of different tokens.</p>
<h2 id="parser-1"><a class="header" href="#parser-1">Parser</a></h2>
<p>The parser takes the token stream and creates the corresponding AST that represents the source code in a structured, hierarchical way.
The parser is implemented in the <code>parser</code> module whereas the model for the AST is implemented in the <code>ast</code> module.</p>
<h3 id="ast---abstract-syntax-tree"><a class="header" href="#ast---abstract-syntax-tree">AST - Abstract Syntax Tree</a></h3>
<p>The abstract syntax tree is a tree representation of the source code.
Some parser implementations use a generic tree-data-structure consisting of <code>Nodes</code> which can have an arbitrary number of children.
These nodes usually have dynamic properties like a type and an optional value and sometimes they even have dynamic properties stored in a map to make this representation even more flexible.</p>
<p>While this approach needs very little source code we decided to favour a less flexible approach.
The RuSTy-AST models every single ast-node as its own <em>struct</em> with all necessary fields including the possible child-nodes.
While this approach needs much more code and hand-written changes, its benefits lie in the clearness and simplicity of the data-structure.
Every element of the AST is easily identified, debugged and understood.
E.g. while in a generic node based AST it is easily possible to have a binary-statement with no, one, or seven child-nodes, the RuSTy-AST enforces the structure of every node. So the RuSTy-Binary-Statement has exactly two children.
It is impossible to construct it differently.</p>
<h4 id="example-10"><a class="header" href="#example-10">Example</a></h4>
<p>So an assignment <code>a := 3;</code> will be parsed with the help of the following Structures:</p>
<pre><code class="language-rs">struct Reference {
   name: string
}

struct LiteralInteger {
   value: i128
}

struct Assignment {
   left: Box&lt;AstStatement&gt;,
   right: Box&lt;AstStatement&gt;
}
</code></pre>
<h3 id="recursive-descent-parser"><a class="header" href="#recursive-descent-parser">Recursive Descent Parser</a></h3>
<p>There are a lot of different frameworks to generate parsers from formal grammars.
While they generate highly optimized parsers we felt we wanted more control and more understanding of the parsing process and the resulting AST.
The fact that at that point in time we were pretty new to rust itself, writing the parser by hand also gave us more practice and a stronger feeling of control and understanding.
Using a parser-generator framework will definitely be an option for future improvements.</p>
<p>As for now, the parser is a hand-written <a href="https://en.wikipedia.org/wiki/Recursive_descent_parser">recursive descent parser</a> inside the <code>parser</code>-module.</p>
<p>As the parser reads the token stream <code>Reference</code>, <code>KeywordEquals</code>, <code>Number</code>, <code>Semicolon</code> it instantiates the corresponding syntax tree:</p>
<pre><code class="language-ignore">                      ┌─────────────────┐
                      │   Assignment    │
                      └──────┬──┬───────┘
                   left      │  │     right
                 ┌───────────┘  └──────────┐
                 ▼                         ▼
        ┌──────────────────┐     ┌──────────────────┐
        │    Reference     │     │  LiteralInteger  │
        ├──────────────────┤     ├──────────────────┤
        │    name: 'a'     │     │    value: '3'    │
        └──────────────────┘     └──────────────────┘
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="indexer"><a class="header" href="#indexer">Indexer</a></h1>
<p>The indexing step is responsible of building and maintaining the Symbol-Table (also called <em>Index</em>).
The <em>Index</em> contains all known referable objects such as <em>variables</em>, <em>data-types</em>, <em>POUs</em>, <em>Functions</em>, etc.
The Symbol-Table also maintains additional information about every referable object such as: the object's type, the objects' datatype, etc.</p>
<p>Indexing is performed by the <em>index</em> module.
It contains the index itself (a.k.a. Symbol Table), the <em>visitor</em> which collects all global names and their additional information as well as a data structure that handles compile time constant expressions (<em>constant_expressions</em>).</p>
<h2 id="the-index-symbol-table"><a class="header" href="#the-index-symbol-table">The Index (Symbol Table)</a></h2>
<p>The index stores information about all referable elements of the program.
Depending on the type of element, we store different meta-information alongside the name of the element.</p>
<div class="table-wrapper"><table><thead><tr><th>Index Field</th><th>Description</th></tr></thead><tbody>
<tr><td>global_variables</td><td>All global variables accessible via their name.</td></tr>
<tr><td>enum_global_variables</td><td>All enum elements accessible via their name (as if they were global variables, e.g. 'RED')</td></tr>
<tr><td>member_variables</td><td>Member variables of structured types (Structs,Functionblocks, etc. This map allows to query all members of a container by name.)</td></tr>
<tr><td>implementations</td><td>All callable implementations (Programs, Functions, Actions, Functionblocks) accessible by their name.</td></tr>
<tr><td>pous</td><td>All pous (Programs, Functions, Functionblocks) with additional information.</td></tr>
<tr><td>type_index</td><td>All data-types (intrinsic and complex) accessible via their name</td></tr>
<tr><td>constant_expressions</td><td>The results of constant expressions that can be evaluated at compile time (e.g. the initializer of a constant: <code>VAR_GLOBAL CONST TAU := 3.1415 * 2; END_VAR</code>)</td></tr>
</tbody></table>
</div>
<p>There are 3 different type of entries in the index:</p>
<ul>
<li><strong>VariableIndexEntry</strong>
The VariableIndexEntry holds information about every <em>Variable</em> in the source code and offers additional information relevant for linking, validation and code-generation.</li>
</ul>
<pre><code class="language-ignore">        ┌─────────────────────────────┐              ┌─────────────────┐
        │  VariableIndexEntry         │              │     &lt;enum&gt;      │
        │                             │              │   VariableType  │
        ├─────────────────────────────┤   var_type   ├─────────────────┤
        │                             │              │  - Local        │
        │  - name: String             ├─────────────►│  - Temp         │
        │  - qualified_name: String   │              │  - Input        │
        │  - is_constant: bool        │              │  - Output       │
        │  - location_in_parent: u32  │              │  - InOut        │
        │  - data_type_name: String   │              │  - Global       │
        │                             │              │  - Return       │
        └───────────┬─────────────────┘              └─────────────────┘
                    │
                    │initial_value
                    │
                    │
                    │            ┌──────────────────┐
                    │            │ ConstExpression  │
                    │       0..1 ├──────────────────┤
                    └───────────►│                  │
                                 │ ...              │
                                 │                  │
                                 └──────────────────┘
</code></pre>
<ul>
<li><strong>PouIndexEntry</strong>
The PouIndexEntry offers information about all Program-Organization-Units.
The index entry offers information like the name of an instance-struct, the name of the registered implementation, etc.</li>
</ul>
<pre><code class="language-ignore">┌──────────────────────────┐
│       &lt;abstract&gt;         │
│       POUIndexEntry      │
├──────────────────────────┤
│                          │
└──────────────────────────┘
             ▲
             │
             │
             │     ┌──────────────────────────┐      ┌──────────────────────────┐
             │     │    ProgramIndexEntry     │      │    GenericParameter      │
             │     ├──────────────────────────┤      ├──────────────────────────┤
             │     │ - name: String           │      │ - name: String           │
             ├─────┤ - instanceStruct: String ├──┬──►│ - typeNature: TypeNature │
             │     │                          │  │   │                          │
             │     │                          │  │   │                          │
             │     └──────────────────────────┘  │   └──────────────────────────┘
             │                                   │
             │                                   │
             │                                   │
             │     ┌──────────────────────────┐  │
             │     │    FunctionIndexEntry    │  │ generics
             │     ├──────────────────────────┤  │
             │     │ - name: String           │  │
             ├─────┤                          ├──┤
             │     │                          │  │
             │     │                          │  │
             │     └──────────────────────────┘  │
             │                                   │
             │                                   │
             │                                   │
             │     ┌──────────────────────────┐  │
             │     │ FunctionBlockIndexEntry  │  │
             │     ├──────────────────────────┤  │
             │     │ - name: String           ├──┤
             ├─────┤ - instanceStruct: String │  │
             │     │                          │  │
             │     │                          │  │
             │     └──────────────────────────┘  │
             │                                   │
             │                                   │
             │                                   │
             │     ┌──────────────────────────┐  │
             │     │    ClassIndexEntry       │  │
             │     ├──────────────────────────┤  │
             │     │ - name: String           │  │
             └─────┤ - instanceStruct: String ├──┘
                   │                          │
                   │                          │
                   └──────────────────────────┘
</code></pre>
<ul>
<li><strong>ImplementationIndexEntry</strong>
The ImplementationIndexEntry offers information about any callable implementation (Program, Functionblock, Function, etc.).
It also offers metadata about the implementation type, the name of the method to call and the name of the parameter-struct (this-struct) to pass to the function.</li>
</ul>
<pre><code class="language-ignore">                                                  ┌───────────────────────┐
        ┌──────────────────────────┐              │       &lt;enum&gt;          │
        │ ImplementationIndexEntry │              │   ImplementationType  │
        ├──────────────────────────┤     type     │                       │
        │                          ├─────────────►├───────────────────────┤
        │ - call_name: String      │              │   - Program           │
        │ - type_name: String      │              │   - Function          │
        │                          │              │   - FunctionBlock     │
        └──────────────────────────┘              │   - Action            │
                                                  │   - Class             │
                                                  │   - Method            │
                                                  │                       │
                                                  └───────────────────────┘
</code></pre>
<ul>
<li><strong>DataType</strong>
The entry for a DataType offers information about any data-type supported by the program to be compiled (internal data types as well as user defined data types).
For each data-type we offer additional information such as it's initial value, its type-nature (in terms of generic functions - e.g: ANY_INT) and some additional information about the type's internal structure and size (e.g. is it a number/array/struct/etc).</li>
</ul>
<pre><code class="language-ignore">                      ┌─────────────┐                   ┌────────────────────┐
                      │  DataType   │                   │ ConstantExpression │
                      ├─────────────┤   initial_value   ├────────────────────┤
                      │             ├──────────────────►│                    │
                      │ - name      │                   │  ...               │
                      │             ├─────────┐         │                    │
                      └──────┬──────┘         │         └────────────────────┘
                             │                │
                             │                │         ┌────────────────────┐
                             │                │         │ TypeNature         │
                             │                │         ├────────────────────┤
                             │ information    │         │ - Any              │
                             │                └────────►│ - Derived          │
                             │                nature    │ - Elementary       │
                             │                          │ - Num              │
                             ▼                          │ - Int              │
                      ┌───────────────────────┐         │ - Signed           │
                      │    &lt;abstract&gt;         │         │ - ...              │
                      │  DataTypeInformation  │         └────────────────────┘
                      ├───────────────────────┤
                      │                       │
                      └───────────────────────┘
                                  ▲
                                  │
                                  │
                                  │
         ┌────────────────┬───────┴───────┬──────────────┬──────────────┐
         │                │               │              │              │
┌────────┴───────┐ ┌──────┴──────┐ ┌──────┴─────┐  ┌─────┴──────┐  ┌────┴─────┐
│ Struct         │ │  Array      │ │ Integer    │  │  String    │  │ ...      │
├────────────────┤ ├─────────────┤ ├────────────┤  ├────────────┤  ├──────────┤
│ - name         │ │- name       │ │ - name     │  │ - size     │  │ ...      │
│ - members      │ │- inner_type │ │ - signed   │  │ - encoding │  │          │
│                │ │- dimensions │ │ - size     │  │            │  │          │
└────────────────┘ └─────────────┘ └────────────┘  └────────────┘  └──────────┘
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linker"><a class="header" href="#linker">Linker</a></h1>
<p>The linker's task is to decide where all references in the source code point to.
There are different references in Structured Text:</p>
<ul>
<li>variable references
<code>x := 4</code> where <em>x</em> is a reference to the variable x.</li>
<li>type references
<code>i : MyFunctionBlock</code> where <em>MyFunctionBlock</em> is a reference to the declared FunctionBlock.</li>
<li>Program references
<code>PLC_PRG.x := 4</code> where <em>PLC_PRG</em> is a reference to a Program-POU called <em>PLC_PRG</em>.</li>
<li>Function references
<code>max(a, b)</code> where <em>max</em> is a reference to a Function-POU called <em>max</em>.</li>
</ul>
<p>So the linker decides where a reference points to. A reference has a corresponding declaration that matches the reference's name:</p>
<pre><code class="language-iecst">        PROGRAM PLC_PRG
             VAR

        ┌──────► x : INT;
        │
        │    END_VAR
        │
        └────┐
             │
             x := 3;
        END_PROGRAM
</code></pre>
<p>The linker's results will be used by the semantic validation step and by the code-generation.</p>
<p>The validator decides whether the name you put at a certain location is valid or not.
In order to decide whether a certain reference is valid or not, we need to know where it is pointing to, so whether we expect a variable, a datatype or something different.</p>
<p>The code-generation needs to know what certain names mean, in order to successfully generate the IR-code that reflects the behavior of your program.</p>
<h2 id="annotated-syntax-tree"><a class="header" href="#annotated-syntax-tree">Annotated Syntax Tree</a></h2>
<p>The AST generated by the parser is a pretty static data-structure.
So where should we store the linking information for a reference?
Even if we would add fields for potential linking-information to the AST, the ownership concepts of Rust would give us a hard time to fill this information piece by piece during linking.
So what we end up doing, is to use the <a href="https://en.wikipedia.org/wiki/Region-based_memory_management">arena-pattern</a> to handle the different lifetimes of the parts of an AST (the AST itself is constructed very early in the compilation process, where the linking information is allocated later).
We don't store the linking information directly in the AST, but we store it inside the mentioned arena-data-structure and link it with certain AST-elements.</p>
<p>The RuSTy linker stores the linking information in an arena called AnnotationMap.
The AnnotationMap can store two type of annotations for any AST-element.
So the first step is that we need a way to uniquely identify every single AST-node so we can use this ID as a key for the annotations stored in the AnnotationMap to automatically associate it with the given AST-Node.
The parser assigns a unique ID to every Statement-Tree-Node (Note that we only assign IDs to Statements, not every AST-Node).</p>
<p>So the expression <code>a + 3</code> now looks like this:</p>
<pre><code class="language-ignore">                      ┌─────────────────┐
                      │ BinaryOperation │
                      ├─────────────────┤
                      │  operator: Plus │
                      │  ID: 1          │
                      └──────┬──┬───────┘
                             │  │
                   left      │  │     right
                 ┌───────────┘  └──────────┐
                 │                         │
                 │                         │
                 ▼                         ▼
        ┌──────────────────┐     ┌──────────────────┐
        │    Reference     │     │  LiteralInteger  │
        ├──────────────────┤     ├──────────────────┤
        │    name: 'a'     │     │    value: '3'    │
        │    ID: 2         │     │    ID: 3         │
        └──────────────────┘     └──────────────────┘
</code></pre>
<p>The AnnotationMap stores 5 different types of annotation:</p>
<ul>
<li><code>Value</code>
The Value-annotation indicates that this AST-Element resolves to a value with the given resulting datatype.
So for Example the LiteralInteger(3) node gets a Value-Annotation with a resulting type of <code>DINT</code>.</li>
</ul>
<pre><code class="language-ignore">        ┌─────────────────────────┐
        │   Value                 │
        ├─────────────────────────┤
        │                         │
        │  resulting_type: String │
        │                         │
        └─────────────────────────┘
</code></pre>
<ul>
<li><code>Variable</code>
The Variable-annotation indicates that this AST-Element resolves to a variable with the given qualified name (and some comfort-information like whether it is a constant and whether it is an auto-deref pointer).
Similar to the value-Annotation it also saves the resulting datatype.</li>
</ul>
<pre><code class="language-ignore">        ┌─────────────────────────┐
        │   Variable              │
        ├─────────────────────────┤
        │                         │
        │  resulting_type: String │
        │  qualified_name: String │
        │  constant: bool         │
        │  is_auto_deref: bool    │
        │                         │
        └─────────────────────────┘
</code></pre>
<ul>
<li><code>Function</code>
The Function-annotation indicates that this AST-Element resolves to a Function-POU (a call-statement) with the given qualified name.
Similar to the value-Annotation it also saves the resulting datatype but this time as the function's return type (<em>return_type</em>).</li>
</ul>
<pre><code class="language-ignore">        ┌─────────────────────────┐
        │   Function              │
        ├─────────────────────────┤
        │                         │
        │  return_type: String    │
        │  qualified_name: String │
        │                         │
        └─────────────────────────┘
</code></pre>
<ul>
<li><code>Type</code>
The Type-annotation indicates that this AST-Element resolves to a DataType (e.g. a Declaration: <code>x: INT</code>) with the given name.</li>
</ul>
<pre><code class="language-ignore">        ┌─────────────────────────┐
        │   Type                  │
        ├─────────────────────────┤
        │                         │
        │  type_name: String      │
        │                         │
        └─────────────────────────┘
</code></pre>
<ul>
<li><code>Program</code>
The Program-annotation is very similar to the Function-annotation.
Since a Program has no return-value it also offers no return-type information.</li>
</ul>
<pre><code class="language-ignore">        ┌─────────────────────────┐
        │   Program               │
        ├─────────────────────────┤
        │                         │
        │  qualified_name: String │
        │                         │
        └─────────────────────────┘
</code></pre>
<p>So the example expression from above <code>a + 3</code> will be annotated like this:
(Note that the resulting type of the Binary-Operation must be calculated by the linker by determining the bigger of both types.)</p>
<pre><code class="language-ignore">                  ┌─────────────────┐
                  │ BinaryOperation │
                  ├─────────────────┤
                  │  operator: Plus │
                  │  ID: 1          │
                  └──────┬──┬───────┘
                         │  │
               left      │  │     right
             ┌───────────┘  └──────────┐
             │                         │
             │                         │
             ▼                         ▼
    ┌──────────────────┐     ┌──────────────────┐
    │    Reference     │     │  LiteralInteger  │
    ├──────────────────┤     ├──────────────────┤
    │    name: 'a'     │     │    value: '3'    │
    │    ID: 2         │     │    ID: 3         │
    └──────────────────┘     └──────────────────┘



                             ┌────────────────────────────┐
                             │        Value               │
┌───────────────────┐        ├────────────────────────────┤
│    AnnotationMap  │   ┌───►│  resulting_type: DINT      │
│                   │   │    │                            │
├───────┬───────────┤   │    └────────────────────────────┘
│ ID: 1 │ Value     ├───┘
├───────┼───────────┤        ┌────────────────────────────┐
│ ID: 2 │ Variable  ├────┐   │        Variable            │
├───────┼───────────┤    │   ├────────────────────────────┤
│ ID: 3 │ Value     ├──┐ │   │  resulting_type: SINT      │
└───────┴───────────┘  │ └──►│  qualified_name: PLC_PRG.a │
                       │     │        constant: false     │
                       │     │   is_auto_deref: false     │
                       │     └────────────────────────────┘
                       │
                       │     ┌────────────────────────────┐
                       │     │        Value               │
                       │     ├────────────────────────────┤
                       └────►│  resulting_type: DINT      │
                             │                            │
                             └────────────────────────────┘
</code></pre>
<p>Another example where the annotated AST carries a lot of useful information is with complex expressions like array-expressions or qualified references.
Lets consider the following statement:</p>
<pre><code class="language-iecst">PLC_PRG.a.b[2]
</code></pre>
<p>It is annotated in the following way:</p>
<pre><code class="language-ignore">                ┌────────────────────┐
                │ QualifiedReference │
                ├────────────────────┤
                │ ID: 1              │
                └─────────┬──────────┘
                          │          elements: Vec&lt;AstStatement&gt;
                ┌─────────┴──────────┬─────────────────────┐
                │                    │                     │
                ▼                    ▼                     ▼
        ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
        │    Reference     │  │    Reference     │  │   ArrayAccess    │
        ├──────────────────┤  ├──────────────────┤  ├──────────────────┤
        │  name: 'PLC_PRG' │  │  name: 'a'       │  │                  │
        │  ID: 2           │  │  ID: 3           │  │    ID: 4         │
        └──────────────────┘  └──────────────────┘  └─────┬──────┬─────┘
                                                          │      │
                                             reference    │      │       access
                                                 ┌────────┘      └─────────┐
                                                 ▼                         ▼
                                        ┌──────────────────┐   ┌──────────────────┐
                                        │    Reference     │   │  LiteralInteger  │
                                        ├──────────────────┤   ├──────────────────┤
                                        │  name: 'b'       │   │    value: '2'    │
                                        │  ID: 5           │   │    ID: 6         │
                                        └──────────────────┘   └──────────────────┘


                                     ┌────────────────────────────┐
                                     │        Value               │
                                ┌───►├────────────────────────────┤
                                │    │  resulting_type: INT       │
                                │    │                            │
                                │    └────────────────────────────┘
                                │
                                │    ┌────────────────────────────┐
        ┌───────────────────┐   │    │       Program              │
        │    AnnotationMap  │   │ ┌─►├────────────────────────────┤
        │                   │   │ │  │  qualified_name: PLC_PRG   │
        ├───────┬───────────┤   │ │  │                            │
        │ ID: 1 │ Value     ├───┘ │  └────────────────────────────┘
        ├───────┼───────────┤     │
        │ ID: 2 │ Program   ├─────┘  ┌────────────────────────────┐
        ├───────┼───────────┤        │        Variable            │
        │ ID: 3 │ Variable  ├───────►├────────────────────────────┤
        ├───────┼───────────┤        │ resulting_type: MyStruct   │
        │ ID: 4 │ Value     ├─────┐  │ qualified_name: PLC_PRG.a  │
        ├───────┼───────────┤     │  └────────────────────────────┘
        │ ID: 5 │ Variable  ├───┐ │
        ├───────┼───────────┤   │ │  ┌────────────────────────────┐
        │ ID: 6 │ Value     ├─┐ │ │  │        Value               │
        └───────┴───────────┘ │ │ └─►├────────────────────────────┤
                              │ │    │ resulting_type: INT        │
                              │ │    │                            │
                              │ │    └────────────────────────────┘
                              │ │
                              │ │    ┌─────────────────────────────────┐
                              │ │    │        Variable                 │
                              │ └───►├─────────────────────────────────┤
                              │      │ resulting_type : ARRAY[] OF INT │
                              │      │ qualified_name : MyStruct.b     │
                              │      └─────────────────────────────────┘
                              │
                              │      ┌────────────────────────────┐
                              │      │        Value               │
                              │      ├────────────────────────────┤
                              └─────►│ resulting_type: DINT       │
                                     │                            │
                                     └────────────────────────────┘
</code></pre>
<h2 id="type-vs-type-hint"><a class="header" href="#type-vs-type-hint">Type vs. Type-Hint</a></h2>
<p>The AnnotationMap not only offers annotations regarding the AST-node's type, but it also offers a second type of annotation.</p>
<p>Consider the following snippet:</p>
<pre><code class="language-iecst">PROGRAM PLC_PRG
   VAR
      x : SINT;
      y : INT;
      z : BYTE;
   END_VAR

   z := x + y;

END_PROGRAM
</code></pre>
<p>The assignment <code>z := x + y</code> is loaded with different types:</p>
<ul>
<li><code>x</code> is annotated as <em>Variable</em> of type <em>SINT</em> and will be auto-upgraded to <em>DINT</em>.</li>
<li><code>y</code> is annotated as <em>Variable</em> of type <em>INT</em> and will be auto-upgraded to <em>DINT</em>.</li>
<li><code>z</code> is annotated as <em>Variable</em> of type <em>BYTE</em>.</li>
<li><code>x + y</code> is annotated as <em>Value</em> of type <em>DINT</em> (the bigger of both).</li>
</ul>
<p>In order to make life easier for validation and code-generation we add an additional annotation to <code>x + y</code> to indicate, that while it technically results in a <em>DINT</em>, it should rather be treated as a <em>BYTE</em> since it is going to be assigned to <code>z</code>.
This second annotation is called the <em>type-hint</em>. It indicates that while it technically is not the real type of this expression, the program's semantic wants the compiler to treat it as this type.</p>
<p>The expression <code>z := x + y</code> is annotated like this:</p>
<div class="table-wrapper"><table><thead><tr><th>expression</th><th>type annotation</th><th>type-hint annotation</th><th>explanation</th></tr></thead><tbody>
<tr><td><code>x</code></td><td>SINT</td><td>DINT</td><td>auto-upgraded to DINT</td></tr>
<tr><td><code>y</code></td><td>INT</td><td>DINT</td><td>auto-upgraded to DINT</td></tr>
<tr><td><code>z</code></td><td>BYTE</td><td>-</td><td></td></tr>
<tr><td><code>x + y</code></td><td>DINT</td><td>BYTE</td><td>type-hint indicates that the resulting DINT needs to be cast to BYTE</td></tr>
</tbody></table>
</div>
<p>With the help of the type-hint annotations the validation can decide whether certain type-cast operations are valid very easily.
The code-generation steps can easily decide when to generate casts, by simply comparing a node's type annotation and it's type-hint annotation.</p>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<p>When generating multiple units, the Linker will keep track of a dependency-tree for the unit.
This means that every datatype or global variable referenced directly or indirectly by the module will be marked as a dependency.
This information can then be used during the <a href="arch/./codegen.html">codegen</a> period to only generated types and variables that are relevant to the unit.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="validation-1"><a class="header" href="#validation-1">Validation</a></h1>
<p>The validation module implements the semantic validation step of the compiler.
The validator is a hand-written visitor that offers a callback when visiting the single AST-nodes to then perform the different validation tasks.</p>
<p>The validation rules are implemented in dedicated validator-structs:</p>
<div class="table-wrapper"><table><thead><tr><th>Validator</th><th>Responsibilities</th></tr></thead><tbody>
<tr><td>global_validator</td><td>Semantic rules on the level of declarations as a whole (e.g. name-conflicts)</td></tr>
<tr><td>pou_validator</td><td>Semantic rules on the level of programs, function- and function-blocks.</td></tr>
<tr><td>recursive_validator</td><td>Semantic rules on the level of recursion (e.g. struct referencing itself)</td></tr>
<tr><td>stmt_validator</td><td>Semantic rules on the level of statements (e.g. invalid type-casts).</td></tr>
<tr><td>variable_validator</td><td>Semantic rules on the level of variable declarations (e.g. empty var-blocks, empty structs, etc.).</td></tr>
</tbody></table>
</div>
<h2 id="diagnostics"><a class="header" href="#diagnostics">Diagnostics</a></h2>
<p>Problems (semantic or syntactic) are represented as <em>Diagnostics</em> <sup class="footnote-reference" id="fr-1-1"><a href="#footnote-1">1</a></sup>.
Diagnostics carry information on the exact location inside the source-string (start- &amp; end-offset), a custom message and a unique error-number to identify the problem.</p>
<p>There are 3 types of <em>Diagnostics</em>:</p>
<div class="table-wrapper"><table><thead><tr><th>Diagnostic</th><th>Description</th></tr></thead><tbody>
<tr><td>SyntaxError</td><td>A syntax error is a diagnostic that is created by the parser if it discovers a token-stream that does not match the language's grammar.</td></tr>
<tr><td>GeneralError</td><td>General errors are problems that occured during the compilation process, that cannot be linked to a malformed input (e.g. file-I/O problems, internal LLVM errors, etc.).</td></tr>
<tr><td>Improvement</td><td>Problems that may not prevent successful compilation but are still considered a flaw in the source-code. (e.g. use proprietary <em>POINTER TO</em> instead of the norm-compliant <em>REF_TO</em>).</td></tr>
</tbody></table>
</div><hr>
<ol class="footnote-definition"><li id="footnote-1">
<p>:(i): The diagnostics are subject to change since they don't elegantly represent the different types of problems (e.g. semantic problems). <a href="#fr-1-1">↩</a></p>
</li>
</ol><div style="break-before: page; page-break-before: always;"></div><h1 id="code-generation"><a class="header" href="#code-generation">Code-Generation</a></h1>
<p>The codegen module contains all code that turns the parsed and verified code represented as an AST into <a href="https://llvm.org/docs/LangRef.html">llvm-ir</a> code.
To generate the <em>IR</em> we use a crate that wraps the native llvm <a href="https://github.com/TheDan64/inkwell">C-API</a>.</p>
<p>The code-generator is basically a transformation from the ST-AST into an IR-Tree representation.
Therefore the AST is traversed in a visitor-like way and transformed simultaneously.</p>
<p>The code generation is split into specialized sub-generators for different tasks:</p>
<div class="table-wrapper"><table><thead><tr><th>Generator</th><th>Responsibilities</th></tr></thead><tbody>
<tr><td>pou_generator</td><td>The pou-generator takes care of generating the programming organization units (Programs, FunctionBlocks, Functions) including their signature and body. More specialized tasks are delegated to other generators.</td></tr>
<tr><td>data_type_generator</td><td>Generates complex datatypes like Structs, Arrays, Enums, Strings, etc.</td></tr>
<tr><td>variable_generator</td><td>Generates global variables and their initialization.</td></tr>
<tr><td>statement_generator</td><td>Generates everything of the body of a POU except expressions. Non-expressions include: IFs, Loops, Assignments, etc.</td></tr>
<tr><td>expression_generator</td><td>Generates expressions (everything that <em>possibly</em> resolves to a value) including: call-statements, references, array-access, etc.</td></tr>
</tbody></table>
</div>
<h2 id="generating-pous"><a class="header" href="#generating-pous">Generating POUs</a></h2>
<p>Generating POUs (Programs, Function-Blocks, Functions) must generate the POU's body itself, as well as the POU's interface (or state) variables.
In this segment we focus on generating the interface for a POU.
Further information about generating a POU's body can be found [here].</p>
<h3 id="programs"><a class="header" href="#programs">Programs</a></h3>
<p>A program is <em>static</em> POU with some code attached.
This means that there is exactly one instance. So wherever from it is called, every caller uses the exact same instance which means that you may see the residuals of the laster caller in the program's variables when you call it yourself.</p>
<pre><code class="language-iecst">PROGRAM prg
    VAR
        x : DINT;
        y : DINT;
    END_VAR

END_PROGRAM
</code></pre>
<p>The program's interface is persistent across calls, so we store it in a global variable.
Therefore the code-generator creates a dedicated struct-type called <code>prg_interface</code>.
A global variable called <code>prg_instance</code> is generated to store the program's state across calls.
This global instance variable is passed as a <code>this</code> pointer to calls to the <code>prg</code> function.</p>
<pre><code class="language-llvm">%prg_interface = type { i32, i32 }

@prg_instance = global %prg_interface zeroinitializer

define void @prg(%prg_interface* %this) {
entry:
  ret void
}
</code></pre>
<h3 id="functionblocks"><a class="header" href="#functionblocks">FunctionBlocks</a></h3>
<p>A FunctionBlock is an POU that is instantiated in a declaration.
So in contrast to Programs, a FunctionBlock can have multiple instances.
Nevertheless the code-generator uses a very similar strategy.
A struct-type for the FunctionBlock's interface is created but no global instance-variable is allocated.
Instead the function block can be used as a DataType to declare instances like in the following example:</p>
<pre><code class="language-iecst">FUNCTION_BLOCK foo
  VAR_INPUT
    x, y : INT;
  END_VAR
END_FUNCTION_BLOCK

PROGRAM prg
  VAR
    f : foo;
  END_VAR
END_PROGRAM
</code></pre>
<p>So for the given example, we see the code-generator creating a type for the FunctionBlock's state (<code>foo_interface</code>).
The declared instance of foo, in <code>prg's</code> interface is seen in the program's generated interface struct-type (<code>prg_interface</code>).</p>
<pre><code class="language-llvm">; ModuleID = 'main'
source_filename = "main"

%prg_interface = type { %foo_interface }
%foo_interface = type { i16, i16 }

@prg_instance = global %prg_interface zeroinitializer

define void @foo(%foo_interface* %0) {
entry:
  ret void
}

define void @prg(%prg_interface* %0) {
entry:
  ret void
}
</code></pre>
<h3 id="functions"><a class="header" href="#functions">Functions</a></h3>
<p>Functions generate very similar to programs and function_blocks.
The main difference is, that no instance-global is allocated and the function's interface-type cannot be used as a datatype to declare your own instances.
Instances of the program's interface-type are allocated whenever the function is called for the lifetime of a single call.
Otherwise the code generated for functions is comparable to the code presented above for programs and function-blocks.</p>
<h2 id="generating-data-types"><a class="header" href="#generating-data-types">Generating Data Types</a></h2>
<p>IEC61131-3 languages offer a wide range of data types.
Next to the built-in intrinsic data types, we support following user defined data types:</p>
<h3 id="range-types"><a class="header" href="#range-types">Range Types</a></h3>
<p>For range types we don't generate special code.
Internally the new data type just becomes an alias for the derived type.</p>
<h3 id="pointer-types"><a class="header" href="#pointer-types">Pointer Types</a></h3>
<p>For pointer types we don't generate special code.
Internally the new data type just becomes an alias for the pointer-type.</p>
<h3 id="struct-types"><a class="header" href="#struct-types">Struct Types</a></h3>
<p>Struct types translate direclty to llvm struct datatypes.
We generate a new datatype with the user-type's name for the struct.</p>
<pre><code class="language-iecst">TYPE MyStruct:
  STRUCT
    a: DINT;
    b: INT;
  END_STRUCT
END_TYPE
</code></pre>
<p>This struct simply generates a llvm struct type:</p>
<pre><code class="language-llvm">%MyStruct = type { i32, i16 }
</code></pre>
<h3 id="enum-types"><a class="header" href="#enum-types">Enum Types</a></h3>
<p>Enumerations are represented as <code>DINT</code>.</p>
<pre><code class="language-iecst">TYPE MyEnum: (red, yellow, green);
END_TYPE
</code></pre>
<p>For every enum's element we generate a global variable with the element's value.</p>
<pre><code class="language-llvm">@red = global i32 0
@yellow = global i32 1
@green = global i32 2
</code></pre>
<h3 id="array-types"><a class="header" href="#array-types">Array Types</a></h3>
<p>Array types are generated as fixed sized llvm vector types - note that Array types must be fixed sized in <em>ST</em> :</p>
<pre><code class="language-iecst">TYPE MyArray: ARRAY[0..9] OF INT;
END_TYPE

VAR_GLOBAL
  x : MyArray;
  y : ARRAY[0..5] OF REAL;
END_VAR
</code></pre>
<p>Custom array data types are not reflected as dedicated types on the llvm-level.</p>
<pre><code class="language-llvm">@x = global [10 x i16] zeroinitializer
@y = global [6 x float] zeroinitializer
</code></pre>
<h4 id="multi-dimensional-arrays"><a class="header" href="#multi-dimensional-arrays">Multi dimensional arrays</a></h4>
<p>Arrays can be declared as multi-dimensional:</p>
<pre><code class="language-iecst">VAR_GLOBAL
  x : ARRAY[0..5, 2..5, 0..1] OF INT;
END_VAR
</code></pre>
<p>The compiler will flatten these type of arrays to a single-dimension. To accomplish that, it calculates the total
length by mulitplying the sizes of all dimensions:</p>
<pre><code class="language-ignore">    0..5 x 2..5 x 0..1
      6  x   4  x   2  = 64
</code></pre>
<p>So the array <code>x : ARRAY[0..5, 2..5, 0..1] OF INT;</code> will be generated as:</p>
<pre><code class="language-llvm">@x = global [64 x i16] zeroinitializer
</code></pre>
<p>This means that such a multidimensional array must be initialized like a single-dimensional array:</p>
<ul>
<li><em>wrong</em></li>
</ul>
<pre><code class="language-iecst">VAR_GLOBAL
  wrong_array : ARRAY[1..2, 0..3] OF INT := [ [10, 11, 12],
                                              [20, 21, 22],
                                              [30, 31, 32]];
END_VAR
</code></pre>
<ul>
<li><em>correct</em></li>
</ul>
<pre><code class="language-iecst">VAR_GLOBAL
  correct_array : ARRAY[1..2, 0..3] OF INT := [ 10, 11, 12,
                                                20, 21, 22,
                                                30, 31, 32];
END_VAR
</code></pre>
<blockquote>
<p><em>Nested Arrays</em></p>
<p>Note that arrays declared as <code>x : ARRAY[0..2] OF ARRAY[0..2] OF INT</code> are different from mutli-dimensional
arrays discussed in this section. Nested arrays are represented as multi-dimensional arrays on the LLVM-IR
level and must also be initialized using nested array-literals!</p>
</blockquote>
<h3 id="string-types"><a class="header" href="#string-types">String Types</a></h3>
<p>String types are generated as fixed sized vector types.</p>
<pre><code class="language-iecst">VAR_GLOBAL
    str  : STRING[20];
    wstr : WSTRING[20];
END_VAR
</code></pre>
<p>Strings can be represented in two different encodings: <em>UTF-8 (STRING)</em> or <em>UTF-16 (WSTRING)</em>.</p>
<pre><code class="language-llvm">@str = global [21 x i8] zeroinitializer
@wstr = global [21 x i16] zeroinitializer
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cfc-continous-function-chart"><a class="header" href="#cfc-continous-function-chart">CFC (Continous Function Chart)</a></h1>
<p>RuSTy is compatible with CFC, as per the FBD part detailed in the <a href="https://www.plcopen.org/system/files/downloads/tc6_xml_v201_technical_doc.pdf">IEC61131-3 XML-exchange format</a>.
The CFC implementation borrows extensively from the <a href="cfc/../arch/architecture.html">ST compiler-pipeline</a>, with the exception that the lexical analysis and parsing phases are replaced by a model-to-model conversion process.
This involves converting the XML into a structured model, which is then converted into ST AST statements.</p>
<p>The next chapter will walk you through the CFC implementation, giving you a better understanding of underlying <a href="https://github.com/PLC-lang/rusty/tree/master/compiler/plc_xml">code</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="model-to-model-conversion"><a class="header" href="#model-to-model-conversion">Model-to-Model Conversion</a></h1>
<p>As previously mentioned, the lexical and parsing phases are replaced by a model-to-model conversion process which consists of two steps:</p>
<ol>
<li>Transform the input file (XML) into a data-model</li>
<li>Transform the data-model into an AST</li>
</ol>
<h2 id="xml-to-data-model"><a class="header" href="#xml-to-data-model">XML to Data-Model</a></h2>
<p>Consider the heavily minified CFC file <a href="cfc/m2m.html#myprogramcfc"><code>MyProgram.cfc</code></a>, which translates to the CFC chart below.</p>
<pre><code class="language-ignore">                   x                      MyAdd
            ┌─────────────┐        ┌─────────────────┐
            │             │        │    exec_id:0    │
            │             ├───────►│ a               │                 z
            │ local_id: 0 │        │ ref_local_id: 0 │          ┌──────────────┐
            └─────────────┘        │                 │          │  exec_id: 1  │
                   y               │                 ├─────────►│              │
            ┌─────────────┐        │                 │          │ref_local_id:2│
            │             │        │                 │          └──────────────┘
            │             ├───────►│ b               │             local_id: 3
            │ local_id:1  │        │ ref_local_id: 1 │
            └─────────────┘        └─────────────────┘
                                       local_id: 2
</code></pre>
<p>The initial phase of the transformation process involves streaming the entire input file.
During the streaming process, whenever important keywords such as <code>block</code> are encountered, they are directly mapped into a corresponding model structure.
For example, when reaching the line <code>&lt;block localId="3" ...&gt;</code> within the XML file, we generate a model that can be represented as follows:</p>
<pre><code class="language-rust ignore">struct Block {
    localId: 2,
    type_name: "MyAdd",
    instance_name: None,
    execution_order_id: 0,
    variables: [
        InputVariable  { ... }, // x, with localId = 0
        InputVariable  { ... }, // y, with localId = 1
        OutputVariable { ... }, // MyAdd eventually becoming `z := MyAdd`, with z having a localId = 2
    ]
}</code></pre>
<p>This process is repeated for every element in the input file which has a corresponding model implementation. For more information on implementation details, see the <a href="https://github.com/PLC-lang/rusty/tree/master/compiler/plc_xml/src/model">model</a> folder.</p>
<p>Since the CFC programming language utilizes blocks and their interconnections to establish the program's logic flow,
with the sequencing of block execution and inter-block links represented through corresponding <code>localId</code>, <code>refLocalId</code> and <code>excutionOrderId</code>,
we have to order each element by their execution ID before proceeding to the next phase.
Otherwise the generated AST statements would be out of order and hence semantically incorrect.</p>
<h2 id="data-model-to-ast"><a class="header" href="#data-model-to-ast">Data-Model to AST</a></h2>
<p>The final part of the model-to-model transformation takes the input from the previous step and transforms it into an AST which the compiler pipeline understands and can generate code from.
Consider the previous <code>block</code> example - the transformer first encounters the element with the <code>executionOrderId</code> of 0, which is a call to <code>myAdd</code>.
We then check and transform each parameter, input <code>a</code> and <code>b</code> corresponding to the variables <code>x</code> and <code>y</code> respectively. The result of this transformation looks as follows:</p>
<pre><code class="language-rust ignore">CallStatement {
    operator: myAdd,
    parameters: [x, y]
}</code></pre>
<p>Next, we process the element with an <code>executionOrderId</code> of 1, which corresponds to an assignment of the previous call's result to z. This update modifies the generated AST as follows:</p>
<pre><code class="language-rust ignore">AssignmentStatement {
    left: z,
    right: CallStatement {
        operator: myAdd,
        parameters: [x, y]
    }
}</code></pre>
<p>While this explanation covers the handling of blocks and variables, there are other elements (e.g. control-flow), that are not discussed here. For more information on implementation details, see <a href="https://github.com/PLC-lang/rusty/tree/master/compiler/plc_xml/src/xml_parser"><code>plc_xml/src/xml_parser</code></a>.</p>
<p>Finally, after transforming all elements into their respective AST statements, the result is passed to the indexer and subsequently enters the next stages of the compiler pipeline, as described in the <a href="cfc/../arch/architecture.html#rusty-frontend-architecture">architecture documentation</a>).</p>
<h2 id="appendix"><a class="header" href="#appendix">Appendix</a></h2>
<h3 id="myaddst"><a class="header" href="#myaddst">MyAdd.st</a></h3>
<pre><code class="language-st ignore">FUNCTION MyAdd : DINT
    VAR_INPUT
        x, y : DINT;
    END_VAR

    MyAdd := x + y;
END_FUNCTION
</code></pre>
<h3 id="myprogramcfc"><a class="header" href="#myprogramcfc">MyProgram.cfc</a></h3>
<pre><code class="language-xml ignore">&lt;pou xmlns="http://www.plcopen.org/xml/tc6_0201" name="myProgram" pouType="program"&gt;
    &lt;content&gt;
        PROGRAM myProgram
            VAR
                x, y, z : DINT;
            END_VAR
    &lt;/content&gt;
    &lt;body&gt;
        &lt;FBD&gt;
            &lt;inVariable localId="1" height="20" width="80" negated="false"&gt;
                &lt;expression&gt;x&lt;/expression&gt;
            &lt;/inVariable&gt;
            &lt;inVariable localId="2" height="20" width="80" negated="false"&gt;
                &lt;expression&gt;y&lt;/expression&gt;
            &lt;/inVariable&gt;
            &lt;block localId="3" width="74" height="60" typeName="MyAdd" executionOrderId="0"&gt;
                &lt;inputVariables&gt;
                    &lt;variable formalParameter="x" negated="false"&gt;
                        &lt;connectionPointIn&gt;
                            &lt;connection refLocalId="1"/&gt;
                        &lt;/connectionPointIn&gt;
                    &lt;/variable&gt;
                    &lt;variable formalParameter="y" negated="false"&gt;
                        &lt;connectionPointIn&gt;
                            &lt;connection refLocalId="2"/&gt;
                        &lt;/connectionPointIn&gt;
                    &lt;/variable&gt;
                &lt;/inputVariables&gt;
                &lt;outputVariables&gt;
                    &lt;/variable formalParameter="MyAdd" negated="false"&gt;
                &lt;/outputVariables&gt;
            &lt;/block&gt;
            &lt;outVariable localId="4" height="20" width="80" executionOrderId="1" negated="false" storage="none"&gt;
                &lt;position x="680" y="160"/&gt;
                &lt;connectionPointIn&gt;
                    &lt;connection refLocalId="3" formalParameter="MyAdd"/&gt;
                &lt;/connectionPointIn&gt;
                &lt;expression&gt;z&lt;/expression&gt;
            &lt;/outVariable&gt;
        &lt;/FBD&gt;
    &lt;/body&gt;
&lt;/pou&gt;
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="iecst.min.js"></script>
        <script src="llvm.min.js"></script>
        <script src="custom.js"></script>
        <script src="highlight.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
