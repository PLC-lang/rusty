(* ****************************************************************************
 * Copyright (c) 2025 Bachmann electronic GmbH *
 **************************************************************************** *)
(**
 * @defgroup file-async-etrig Edge triggered file function blocks
 * @brief Edge triggered file function blocks according to the PLCopen specification.
 *
 * These function blocks implement a wrapper over the synchronous file interface.
 * The function blocks behave like the edge triggered function blocks described by the PLCopen specification.
 * @{
*)
(**
 * @brief Open or create a file (async edge triggered)
 *
 * Open or create a file asynchronously. The behavior is defined by the @p Mode parameter (#FILE_AccessMode).
 * If the @p Mode parameter is omitted, the file is opened read only.
 * This function block is edge triggered and extends ETrig base class.
 *
 * @param[in] File Specifies the file name. File name can be specified absolute or relative. The current working directory is the home directory of the app located in `/data/app/home/<instanceName>`.
 * @param[in] Mode Requested access mode.
 * @param[out] FileHandle File handle returned when operation completes successfully.
 * @see FILE_CloseAsync
 *)
FUNCTION_BLOCK FILE_OpenAsync EXTENDS ETrig
VAR_INPUT
    File: STRING[1023];
    Mode: FILE_AccessMode := FILE_AccessMode_Read;
END_VAR
VAR_OUTPUT
    FileHandle: FILE_Handle;
END_VAR
VAR
    FileAsyncFB: FILE_Async;
    OpenParams: FILE_OpenParams;
    JobState: ASYNC_JobState;
END_VAR
METHOD StartAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD CyclicAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD ResetAction
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
END_FUNCTION_BLOCK
(**
 * @brief Close a file (async edge triggered)
 *
 * Close a file asynchronously. This function block is edge triggered and extends ETrig base class.
 *
 * @param[in] FileHandle File handle to close.
 *)
FUNCTION_BLOCK FILE_CloseAsync EXTENDS ETrig
VAR_INPUT
    FileHandle: FILE_Handle;
END_VAR
VAR
    FileAsyncFB: FILE_Async;
    CloseParams: FILE_CloseParams;
    JobState: ASYNC_JobState;
END_VAR
METHOD StartAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD CyclicAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD ResetAction
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
END_FUNCTION_BLOCK
(**
 * @brief Read data from a file (async edge triggered)
 *
 * Reads up to Size bytes from a file into the buffer asynchronously. The actual number of bytes read is returned in @p BytesRead.
 * This function block is edge triggered and extends ETrig base class.
 *
 * @param[in] FileHandle File handle.
 * @param[in] Buffer Pointer to the buffer where the read data will be stored.
 * @param[in] Size Maximum number of bytes to read.
 * @param[out] BytesRead Number of bytes actually read.
 * @note The function may return fewer bytes than requested if the end of the file is reached.
 *)
FUNCTION_BLOCK FILE_ReadAsync EXTENDS ETrig
VAR_INPUT
    FileHandle: FILE_Handle;
    Buffer: UDINT;
    Size: UDINT;
END_VAR
VAR_OUTPUT
    BytesRead: UDINT;
END_VAR
VAR
    FileAsyncFB: FILE_Async;
    ReadParams: FILE_ReadParams;
    JobState: ASYNC_JobState;
END_VAR
METHOD StartAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD CyclicAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD ResetAction
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
END_FUNCTION_BLOCK
(**
 * @brief Write data to a file (async edge triggered)
 *
 * This function writes the specified number of bytes from the provided buffer to the given file asynchronously.
 * This function block is edge triggered and extends ETrig base class.
 *
 * @param[in] FileHandle File handle.
 * @param[in] Buffer Pointer to the data buffer to be written.
 * @param[in] Size Number of bytes to write from the buffer.
 * @param[out] BytesWritten Number of bytes successfully written.
 *)
FUNCTION_BLOCK FILE_WriteAsync EXTENDS ETrig
VAR_INPUT
    FileHandle: FILE_Handle;
    Buffer: POINTER TO BYTE;
    Size: ULINT;
END_VAR
VAR_OUTPUT
    BytesWritten: ULINT;
END_VAR
VAR
    FileAsyncFB: FILE_Async;
    WriteParams: FILE_WriteParams;
    JobState: ASYNC_JobState;
END_VAR
METHOD StartAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD CyclicAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD ResetAction
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
END_FUNCTION_BLOCK
(**
 * @brief Copy a file (async edge triggered)
 *
 * Copies the file specified by Source to the file specified by Destination asynchronously.
 * This function block is edge triggered and extends ETrig base class.
 *
 * @param[in] Source Path to the source file.
 * @param[in] Destination Path to the destination file.
 * @param[out] BytesCopied Number of bytes copied.
 *)
FUNCTION_BLOCK FILE_CopyAsync EXTENDS ETrig
VAR_INPUT
    Source: STRING[1023];
    Destination: STRING[1023];
END_VAR
VAR_OUTPUT
    BytesCopied: ULINT;
END_VAR
VAR
    FileAsyncFB: FILE_Async;
    CopyParams: FILE_CopyParams;
    JobState: ASYNC_JobState;
END_VAR
METHOD StartAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD CyclicAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD ResetAction
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
END_FUNCTION_BLOCK
(**
 * @brief Remove a file (async edge triggered)
 *
 * Deletes the file specified by FileName asynchronously.
 * This function block is edge triggered and extends ETrig base class.
 *
 * @param[in] FileName Name of the file to remove.
 *)
FUNCTION_BLOCK FILE_RemoveAsync EXTENDS ETrig
VAR_INPUT
    FileName: STRING[1023];
END_VAR
VAR
    FileAsyncFB: FILE_Async;
    RemoveParams: FILE_RemoveParams;
    JobState: ASYNC_JobState;
END_VAR
METHOD StartAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD CyclicAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD ResetAction
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
END_FUNCTION_BLOCK
(**
 * @brief Rename a file (async edge triggered)
 *
 * Renames the file specified by OldName to NewName asynchronously.
 * This function block is edge triggered and extends ETrig base class.
 *
 * @param[in] OldName Current file name.
 * @param[in] NewName New file name.
 *)
FUNCTION_BLOCK FILE_RenameAsync EXTENDS ETrig
VAR_INPUT
    OldName: STRING[1023];
    NewName: STRING[1023];
END_VAR
VAR
    FileAsyncFB: FILE_Async;
    RenameParams: FILE_RenameParams;
    JobState: ASYNC_JobState;
END_VAR
METHOD StartAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD CyclicAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD ResetAction
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
END_FUNCTION_BLOCK
(**
 * @brief Flush file (async edge triggered)
 *
 * Writes any unwritten data from the stream's buffer to the associated output device asynchronously.
 * This function block is edge triggered and extends ETrig base class.
 *
 * @param[in] FileHandle File handle to flush.
 *)
FUNCTION_BLOCK FILE_FlushAsync EXTENDS ETrig
VAR_INPUT
    FileHandle: FILE_Handle;
END_VAR
VAR
    FileAsyncFB: FILE_Async;
    FlushParams: FILE_FlushParams;
    JobState: ASYNC_JobState;
END_VAR
METHOD StartAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD CyclicAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD ResetAction
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
END_FUNCTION_BLOCK
(**
 * @brief Set file position indicator (async edge triggered)
 *
 * This function moves the file position indicator to the specified offset
 * relative to the origin defined by the Origin parameter asynchronously. The origin can be
 * the beginning of the file, the current position, or the end of the file.
 * If Origin and Offset are omitted, the position is set to the beginning of the file.
 * This function block is edge triggered and extends ETrig base class.
 *
 * @param[in] FileHandle File handle.
 * @param[in] Offset Number of bytes to offset from the origin.
 * @param[in] Origin Position used as reference for the offset.
 *)
FUNCTION_BLOCK FILE_SeekAsync EXTENDS ETrig
VAR_INPUT
    FileHandle: FILE_Handle;
    Offset: LINT := 0;
    Origin: FILE_SeekOrigin := FILE_SeekOrigin_Begin;
END_VAR
VAR
    FileAsyncFB: FILE_Async;
    SeekParams: FILE_SeekParams;
    JobState: ASYNC_JobState;
END_VAR
METHOD StartAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD CyclicAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD ResetAction
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
END_FUNCTION_BLOCK
(**
 * @brief Get file position indicator (async edge triggered)
 *
 * Returns the file position indicator for the file asynchronously.
 * This function block is edge triggered and extends ETrig base class.
 *
 * @param[in] FileHandle File handle.
 * @param[out] Position Number of bytes from the beginning of the file or -1 in case of an error.
 *)
FUNCTION_BLOCK FILE_TellAsync EXTENDS ETrig
VAR_INPUT
    FileHandle: FILE_Handle;
END_VAR
VAR_OUTPUT
    Position: LINT;
END_VAR
VAR
    FileAsyncFB: FILE_Async;
    TellParams: FILE_TellParams;
    JobState: ASYNC_JobState;
END_VAR
METHOD StartAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD CyclicAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD ResetAction
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
END_FUNCTION_BLOCK
(**
 * @brief Get file status information (async edge triggered)
 *
 * Gets the file status information asynchronously.
 * This function block is edge triggered and extends ETrig base class.
 *
 * @param[in] FileHandle File handle.
 * @param[out] Status The file status information.
 *)
FUNCTION_BLOCK FILE_GetStatusAsync EXTENDS ETrig
VAR_INPUT
    FileHandle: FILE_Handle;
END_VAR
VAR_OUTPUT
    Status: FILE_Status;
END_VAR
VAR
    FileAsyncFB: FILE_Async;
    GetStatusParams: FILE_GetStatusParams;
    JobState: ASYNC_JobState;
END_VAR
METHOD StartAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD CyclicAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD ResetAction
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
END_FUNCTION_BLOCK
(**
 * @brief Read a line from a file into a string (async edge triggered)
 *
 * Reads a line from a newline delimited file asynchronously. The line length is limited to 1024 bytes.
 * This function block is edge triggered and extends ETrig base class.
 *
 * @param[in] FileHandle File handle.
 * @param[out] Output The next line until a newline character or the end of the file is reached.
 * @param[out] IsEOF Indicates whether the end of the file has been reached.
 *)
FUNCTION_BLOCK FILE_ReadStringAsync EXTENDS ETrig
VAR_INPUT
    FileHandle: FILE_Handle;
END_VAR
VAR_OUTPUT
    Output: STRING[1023];
    IsEOF: BOOL;
END_VAR
VAR
    FileAsyncFB: FILE_Async;
    ReadStringParams: FILE_ReadStringParams;
    JobState: ASYNC_JobState;
END_VAR
METHOD StartAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD CyclicAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD ResetAction
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
END_FUNCTION_BLOCK
(**
 * @brief Write a string to a file (async edge triggered)
 *
 * Writes a string to a file asynchronously.
 * This function block is edge triggered and extends ETrig base class.
 *
 * @param[in] FileHandle File handle.
 * @param[in] Str The string to be written.
 * @param[out] BytesWritten Number of bytes successfully written.
 *)
FUNCTION_BLOCK FILE_WriteStringAsync EXTENDS ETrig
VAR_INPUT
    FileHandle: FILE_Handle;
    Str: STRING[1023];
END_VAR
VAR
    FileAsyncFB: FILE_Async;
    WriteStringParams: FILE_WriteStringParams;
    JobState: ASYNC_JobState;
END_VAR
METHOD StartAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD CyclicAction: ErrorCode
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
METHOD ResetAction
VAR_OUTPUT
    Complete: BOOL;
END_VAR
END_METHOD
END_FUNCTION_BLOCK
(** @} **)
