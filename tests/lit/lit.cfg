import lit.formats, os, os.path, sys, subprocess, shutil
srcDir = os.path.dirname(__file__)
config.test_format = lit.formats.ShTest(True)
config.pipefail = False
rustyRootDirectory = subprocess.check_output("dirname `cargo locate-project --message-format plain`", shell=True).decode("utf-8").strip()

stdlibLocation = lit_config.params["LIB"]
compilerLocation = lit_config.params["COMPILER"]

# Detect available FileCheck command
filecheckCmd = None
for cmd in ['FileCheck', 'FileCheck-21', 'filecheck', 'filecheck-21']:
    if shutil.which(cmd):
        filecheckCmd = cmd
        break

if not filecheckCmd:
    lit_config.fatal("No FileCheck command found. Please install LLVM FileCheck.")

lit_config.note(f'Using FileCheck command: {filecheckCmd}')

# ...to make the compile command more reable we build it over multiple lines
compile = f'{compilerLocation}'
compile = f'{compile} -o %T/%basename_t.out'
compile = f'{compile} -liec61131std -L{stdlibLocation}/lib -i "{stdlibLocation}/include/*.st"'
compile = f'{compile} -i {rustyRootDirectory}/tests/lit/util/*.pli'
compile = f'{compile} --debug'
compile = f'{compile} --linker=cc'
print(f'Compile command: {compile}')

config.substitutions.append(('%COMPILE', f'{compile}'))
config.substitutions.append(('%RUN', f'LD_LIBRARY_PATH="{stdlibLocation}/lib" %T/%basename_t.out'))
config.substitutions.append(('%CHECK', f'{filecheckCmd} --check-prefixes CHECK --allow-unused-prefixes --match-full-lines'))
