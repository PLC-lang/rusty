import lit.formats, os, os.path, sys, subprocess, shutil
srcDir = os.path.dirname(__file__)

# Ensure the util/ directory is on PATH so that our fallback 'not' script is
# found when LLVM's own 'not' utility is not installed.  If the real 'not' is
# already on PATH it will shadow our script (PATH is searched left-to-right),
# so we append rather than prepend here.
_util_dir = os.path.join(srcDir, 'util')
config.environment['PATH'] = os.environ.get('PATH', '') + os.pathsep + _util_dir
config.test_format = lit.formats.ShTest(True)
config.pipefail = False
rustyRootDirectory = subprocess.check_output("dirname `cargo locate-project --message-format plain`", shell=True).decode("utf-8").strip()

stdlibLocation = lit_config.params["LIB"]
compilerLocation = lit_config.params["COMPILER"]

# Detect available FileCheck command
filecheckCmd = None
for cmd in ['FileCheck', 'FileCheck-21', 'filecheck', 'filecheck-21']:
    if shutil.which(cmd):
        filecheckCmd = cmd
        break

if not filecheckCmd:
    lit_config.fatal("No FileCheck command found. Please install LLVM FileCheck.")

lit_config.note(f'Using FileCheck command: {filecheckCmd}')

# ...to make the compile command more readable we build it over multiple lines
compile_base = f'{compilerLocation}'
compile_base = f'{compile_base} -liec61131std -L{stdlibLocation}/lib -i "{stdlibLocation}/include/*.st"'
compile_base = f'{compile_base} -i {rustyRootDirectory}/tests/lit/util/*.pli'
compile_base = f'{compile_base} --debug'
compile_base = f'{compile_base} --linker=cc'
compile_base = f'{compile_base} --error-config {rustyRootDirectory}/tests/lit/util/diagnostics.json'

compile = f'{compile_base} -o %T/%basename_t.out'
print(f'Compile command: {compile}')

# IR-only compile: no stdlib, no debug, no linker â€” just emit IR to stdout
ir_compile = f'{compilerLocation} --ir -o /dev/stdout'

config.substitutions.append(('%IR_COMPILE', ir_compile))
config.substitutions.append(('%COMPILE', f'{compile}'))
config.substitutions.append(('%RUN', f'LD_LIBRARY_PATH="{stdlibLocation}/lib" %T/%basename_t.out'))
config.substitutions.append(('%CHECK', f'{filecheckCmd} --check-prefixes CHECK --allow-unused-prefixes --match-full-lines'))
