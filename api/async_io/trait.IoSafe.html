<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Types whose I/O trait implementations do not drop the underlying I/O source."><title>IoSafe in async_io - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-5bc39a1768837dd0.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="async_io" data-themes="" data-resource-suffix="" data-rustdoc-version="1.77.0 (aedd173a2 2024-03-17)" data-channel="1.77.0" data-search-js="search-dd67cee4cfa65049.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../static.files/storage-4c98445ec4002617.js"></script><script defer src="sidebar-items.js"></script><script defer src="../static.files/main-48f368f3872407c8.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-04d5337699b92874.css"></noscript><link rel="icon" href="https://raw.githubusercontent.com/smol-rs/smol/master/assets/images/logo_fullsize_transparent.png"></head><body class="rustdoc trait"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button><a class="logo-container" href="../async_io/index.html"><img src="https://raw.githubusercontent.com/smol-rs/smol/master/assets/images/logo_fullsize_transparent.png" alt=""></a></nav><nav class="sidebar"><div class="sidebar-crate"><a class="logo-container" href="../async_io/index.html"><img src="https://raw.githubusercontent.com/smol-rs/smol/master/assets/images/logo_fullsize_transparent.png" alt="logo"></a><h2><a href="../async_io/index.html">async_io</a><span class="version">2.3.1</span></h2></div><h2 class="location"><a href="#">IoSafe</a></h2><div class="sidebar-elems"><section><h3><a href="#foreign-impls">Implementations on Foreign Types</a></h3><ul class="block"><li><a href="#impl-IoSafe-for-%26T">&amp;T</a></li><li><a href="#impl-IoSafe-for-%26mut+T">&amp;mut T</a></li><li><a href="#impl-IoSafe-for-Box%3CT%3E">Box&lt;T&gt;</a></li><li><a href="#impl-IoSafe-for-BufReader%3CT%3E">BufReader&lt;T&gt;</a></li><li><a href="#impl-IoSafe-for-BufWriter%3CT%3E">BufWriter&lt;T&gt;</a></li><li><a href="#impl-IoSafe-for-ChildStderr">ChildStderr</a></li><li><a href="#impl-IoSafe-for-ChildStdin">ChildStdin</a></li><li><a href="#impl-IoSafe-for-ChildStdout">ChildStdout</a></li><li><a href="#impl-IoSafe-for-Cow%3C'_,+T%3E">Cow&lt;&#x27;_, T&gt;</a></li><li><a href="#impl-IoSafe-for-File">File</a></li><li><a href="#impl-IoSafe-for-LineWriter%3CT%3E">LineWriter&lt;T&gt;</a></li><li><a href="#impl-IoSafe-for-Stderr">Stderr</a></li><li><a href="#impl-IoSafe-for-StderrLock%3C'_%3E">StderrLock&lt;&#x27;_&gt;</a></li><li><a href="#impl-IoSafe-for-Stdin">Stdin</a></li><li><a href="#impl-IoSafe-for-StdinLock%3C'_%3E">StdinLock&lt;&#x27;_&gt;</a></li><li><a href="#impl-IoSafe-for-Stdout">Stdout</a></li><li><a href="#impl-IoSafe-for-StdoutLock%3C'_%3E">StdoutLock&lt;&#x27;_&gt;</a></li><li><a href="#impl-IoSafe-for-TcpStream">TcpStream</a></li><li><a href="#impl-IoSafe-for-UnixStream">UnixStream</a></li></ul><h3><a href="#implementors">Implementors</a></h3></section><h2><a href="index.html">In crate async_io</a></h2></div></nav><div class="sidebar-resizer"></div>
    <main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><div id="sidebar-button" tabindex="-1"><a href="../async_io/all.html" title="show sidebar"></a></div><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" tabindex="-1"><a href="../help.html" title="help">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Trait <a href="index.html">async_io</a>::<wbr><a class="trait" href="#">IoSafe</a><button id="copy-path" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../src/async_io/lib.rs.html#1203">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><pre class="rust item-decl"><code>pub unsafe trait IoSafe { }</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Types whose I/O trait implementations do not drop the underlying I/O source.</p>
<p>The resource contained inside of the <a href="struct.Async.html" title="struct async_io::Async"><code>Async</code></a> cannot be invalidated. This invalidation can
happen if the inner resource (the <a href="https://doc.rust-lang.org/1.77.0/std/net/tcp/struct.TcpStream.html" title="struct std::net::tcp::TcpStream"><code>TcpStream</code></a>, <a href="https://doc.rust-lang.org/1.77.0/std/os/unix/net/listener/struct.UnixListener.html" title="struct std::os::unix::net::listener::UnixListener"><code>UnixListener</code></a> or other <code>T</code>) is moved out
and dropped before the <a href="struct.Async.html" title="struct async_io::Async"><code>Async</code></a>. Because of this, functions that grant mutable access to
the inner type are unsafe, as there is no way to guarantee that the source won’t be dropped
and a dangling handle won’t be left behind.</p>
<p>Unfortunately this extends to implementations of <a href="https://doc.rust-lang.org/std/io/trait.Read.html"><code>Read</code></a> and <a href="https://doc.rust-lang.org/std/io/trait.Write.html"><code>Write</code></a>. Since methods on those
traits take <code>&amp;mut</code>, there is no guarantee that the implementor of those traits won’t move the
source out while the method is being run.</p>
<p>This trait is an antidote to this predicament. By implementing this trait, the user pledges
that using any I/O traits won’t destroy the source. This way, <a href="struct.Async.html" title="struct async_io::Async"><code>Async</code></a> can implement the
<code>async</code> version of these I/O traits, like <a href="https://docs.rs/futures-io/latest/futures_io/trait.AsyncRead.html"><code>AsyncRead</code></a> and <a href="https://docs.rs/futures-io/latest/futures_io/trait.AsyncWrite.html"><code>AsyncWrite</code></a>.</p>
<h2 id="safety"><a class="doc-anchor" href="#safety">§</a>Safety</h2>
<p>Any I/O trait implementations for this type must not drop the underlying I/O source. Traits
affected by this trait include <a href="https://doc.rust-lang.org/std/io/trait.Read.html"><code>Read</code></a>, <a href="https://doc.rust-lang.org/std/io/trait.Write.html"><code>Write</code></a>, <a href="https://doc.rust-lang.org/std/io/trait.Seek.html"><code>Seek</code></a> and <a href="https://doc.rust-lang.org/std/io/trait.BufRead.html"><code>BufRead</code></a>.</p>
<p>This trait is implemented by default on top of <code>libstd</code> types. In addition, it is implemented
for immutable reference types, as it is impossible to invalidate any outstanding references
while holding an immutable reference, even with interior mutability. As Rust’s current pinning
system relies on similar guarantees, I believe that this approach is robust.</p>
</div></details><h2 id="foreign-impls" class="section-header">Implementations on Foreign Types<a href="#foreign-impls" class="anchor">§</a></h2><section id="impl-IoSafe-for-File" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1239">source</a><a href="#impl-IoSafe-for-File" class="anchor">§</a><h3 class="code-header">impl <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/fs/struct.File.html" title="struct std::fs::File">File</a></h3></section><section id="impl-IoSafe-for-Stderr" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1240">source</a><a href="#impl-IoSafe-for-Stderr" class="anchor">§</a><h3 class="code-header">impl <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/io/stdio/struct.Stderr.html" title="struct std::io::stdio::Stderr">Stderr</a></h3></section><section id="impl-IoSafe-for-StderrLock%3C'_%3E" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1243">source</a><a href="#impl-IoSafe-for-StderrLock%3C'_%3E" class="anchor">§</a><h3 class="code-header">impl <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/io/stdio/struct.StderrLock.html" title="struct std::io::stdio::StderrLock">StderrLock</a>&lt;'_&gt;</h3></section><section id="impl-IoSafe-for-Stdin" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1241">source</a><a href="#impl-IoSafe-for-Stdin" class="anchor">§</a><h3 class="code-header">impl <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/io/stdio/struct.Stdin.html" title="struct std::io::stdio::Stdin">Stdin</a></h3></section><section id="impl-IoSafe-for-StdinLock%3C'_%3E" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1244">source</a><a href="#impl-IoSafe-for-StdinLock%3C'_%3E" class="anchor">§</a><h3 class="code-header">impl <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/io/stdio/struct.StdinLock.html" title="struct std::io::stdio::StdinLock">StdinLock</a>&lt;'_&gt;</h3></section><section id="impl-IoSafe-for-Stdout" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1242">source</a><a href="#impl-IoSafe-for-Stdout" class="anchor">§</a><h3 class="code-header">impl <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/io/stdio/struct.Stdout.html" title="struct std::io::stdio::Stdout">Stdout</a></h3></section><section id="impl-IoSafe-for-StdoutLock%3C'_%3E" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1245">source</a><a href="#impl-IoSafe-for-StdoutLock%3C'_%3E" class="anchor">§</a><h3 class="code-header">impl <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/io/stdio/struct.StdoutLock.html" title="struct std::io::stdio::StdoutLock">StdoutLock</a>&lt;'_&gt;</h3></section><section id="impl-IoSafe-for-TcpStream" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1246">source</a><a href="#impl-IoSafe-for-TcpStream" class="anchor">§</a><h3 class="code-header">impl <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/net/tcp/struct.TcpStream.html" title="struct std::net::tcp::TcpStream">TcpStream</a></h3></section><section id="impl-IoSafe-for-UnixStream" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1252">source</a><a href="#impl-IoSafe-for-UnixStream" class="anchor">§</a><h3 class="code-header">impl <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/os/unix/net/stream/struct.UnixStream.html" title="struct std::os::unix::net::stream::UnixStream">UnixStream</a></h3></section><section id="impl-IoSafe-for-ChildStderr" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1249">source</a><a href="#impl-IoSafe-for-ChildStderr" class="anchor">§</a><h3 class="code-header">impl <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/process/struct.ChildStderr.html" title="struct std::process::ChildStderr">ChildStderr</a></h3></section><section id="impl-IoSafe-for-ChildStdin" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1247">source</a><a href="#impl-IoSafe-for-ChildStdin" class="anchor">§</a><h3 class="code-header">impl <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/process/struct.ChildStdin.html" title="struct std::process::ChildStdin">ChildStdin</a></h3></section><section id="impl-IoSafe-for-ChildStdout" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1248">source</a><a href="#impl-IoSafe-for-ChildStdout" class="anchor">§</a><h3 class="code-header">impl <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/process/struct.ChildStdout.html" title="struct std::process::ChildStdout">ChildStdout</a></h3></section><section id="impl-IoSafe-for-Cow%3C'_,+T%3E" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1259">source</a><a href="#impl-IoSafe-for-Cow%3C'_,+T%3E" class="anchor">§</a><h3 class="code-header">impl&lt;T: <a class="trait" href="https://doc.rust-lang.org/1.77.0/core/clone/trait.Clone.html" title="trait core::clone::Clone">Clone</a> + <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> + ?<a class="trait" href="https://doc.rust-lang.org/1.77.0/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a>&gt; <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="enum" href="https://doc.rust-lang.org/1.77.0/alloc/borrow/enum.Cow.html" title="enum alloc::borrow::Cow">Cow</a>&lt;'_, T&gt;</h3></section><section id="impl-IoSafe-for-BufReader%3CT%3E" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1254">source</a><a href="#impl-IoSafe-for-BufReader%3CT%3E" class="anchor">§</a><h3 class="code-header">impl&lt;T: <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> + <a class="trait" href="https://doc.rust-lang.org/1.77.0/std/io/trait.Read.html" title="trait std::io::Read">Read</a>&gt; <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/io/buffered/bufreader/struct.BufReader.html" title="struct std::io::buffered::bufreader::BufReader">BufReader</a>&lt;T&gt;</h3></section><section id="impl-IoSafe-for-BufWriter%3CT%3E" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1255">source</a><a href="#impl-IoSafe-for-BufWriter%3CT%3E" class="anchor">§</a><h3 class="code-header">impl&lt;T: <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> + <a class="trait" href="https://doc.rust-lang.org/1.77.0/std/io/trait.Write.html" title="trait std::io::Write">Write</a>&gt; <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/io/buffered/bufwriter/struct.BufWriter.html" title="struct std::io::buffered::bufwriter::BufWriter">BufWriter</a>&lt;T&gt;</h3></section><section id="impl-IoSafe-for-LineWriter%3CT%3E" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1256">source</a><a href="#impl-IoSafe-for-LineWriter%3CT%3E" class="anchor">§</a><h3 class="code-header">impl&lt;T: <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> + <a class="trait" href="https://doc.rust-lang.org/1.77.0/std/io/trait.Write.html" title="trait std::io::Write">Write</a>&gt; <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/std/io/buffered/linewriter/struct.LineWriter.html" title="struct std::io::buffered::linewriter::LineWriter">LineWriter</a>&lt;T&gt;</h3></section><section id="impl-IoSafe-for-%26mut+T" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1257">source</a><a href="#impl-IoSafe-for-%26mut+T" class="anchor">§</a><h3 class="code-header">impl&lt;T: <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> + ?<a class="trait" href="https://doc.rust-lang.org/1.77.0/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a>&gt; <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="primitive" href="https://doc.rust-lang.org/1.77.0/std/primitive.reference.html">&amp;mut T</a></h3></section><section id="impl-IoSafe-for-Box%3CT%3E" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1258">source</a><a href="#impl-IoSafe-for-Box%3CT%3E" class="anchor">§</a><h3 class="code-header">impl&lt;T: <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> + ?<a class="trait" href="https://doc.rust-lang.org/1.77.0/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a>&gt; <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="struct" href="https://doc.rust-lang.org/1.77.0/alloc/boxed/struct.Box.html" title="struct alloc::boxed::Box">Box</a>&lt;T&gt;</h3></section><section id="impl-IoSafe-for-%26T" class="impl"><a class="src rightside" href="../src/async_io/lib.rs.html#1236">source</a><a href="#impl-IoSafe-for-%26T" class="anchor">§</a><h3 class="code-header">impl&lt;T: ?<a class="trait" href="https://doc.rust-lang.org/1.77.0/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a>&gt; <a class="trait" href="trait.IoSafe.html" title="trait async_io::IoSafe">IoSafe</a> for <a class="primitive" href="https://doc.rust-lang.org/1.77.0/std/primitive.reference.html">&amp;T</a></h3></section><div class="docblock"><p>Reference types can’t be mutated.</p>
<p>The worst thing that can happen is that external state is used to change what kind of pointer
<code>as_fd()</code> returns. For instance:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>std::cell::Cell;
<span class="kw">use </span>std::net::TcpStream;
<span class="kw">use </span>std::os::unix::io::{AsFd, BorrowedFd};

<span class="kw">struct </span>Bar {
    flag: Cell&lt;bool&gt;,
    a: TcpStream,
    b: TcpStream
}

<span class="kw">impl </span>AsFd <span class="kw">for </span>Bar {
    <span class="kw">fn </span>as_fd(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; BorrowedFd&lt;<span class="lifetime">'_</span>&gt; {
        <span class="kw">if </span><span class="self">self</span>.flag.replace(!<span class="self">self</span>.flag.get()) {
            <span class="self">self</span>.a.as_fd()
        } <span class="kw">else </span>{
            <span class="self">self</span>.b.as_fd()
        }
    }
}</code></pre></div>
<p>We solve this problem by only calling <code>as_fd()</code> once to get the original source. Implementations
like this are considered buggy (but not unsound) and are thus not really supported by <code>async-io</code>.</p>
</div><h2 id="implementors" class="section-header">Implementors<a href="#implementors" class="anchor">§</a></h2><div id="implementors-list"></div><script src="../trait.impl/async_io/trait.IoSafe.js" data-ignore-extern-crates="std,alloc" async></script></section></div></main></body></html>