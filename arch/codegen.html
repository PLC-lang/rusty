<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Codegen - RuSTy User Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">RuSTy User Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="code-generation"><a class="header" href="#code-generation">Code-Generation</a></h1>
<p>The codegen module contains all code that turns the parsed and verified code represented as an AST into <a href="https://llvm.org/docs/LangRef.html">llvm-ir</a> code.
To generate the <em>IR</em> we use a crate that wraps the native llvm <a href="https://github.com/TheDan64/inkwell">C-API</a>.</p>
<p>The code-generator is basically a transformation from the ST-AST into an IR-Tree representation.
Therefore the AST is traversed in a visitor-like way and transformed simultaneously.</p>
<p>The code generation is split into specialized sub-generators for different tasks:</p>
<div class="table-wrapper"><table><thead><tr><th>Generator</th><th>Responsibilities</th></tr></thead><tbody>
<tr><td>pou_generator</td><td>The pou-generator takes care of generating the programming organization units (Programs, FunctionBlocks, Functions) including their signature and body. More specialized tasks are delegated to other generators.</td></tr>
<tr><td>data_type_generator</td><td>Generates complex datatypes like Structs, Arrays, Enums, Strings, etc.</td></tr>
<tr><td>variable_generator</td><td>Generates global variables and their initialization.</td></tr>
<tr><td>statement_generator</td><td>Generates everything of the body of a POU except expressions. Non-expressions include: IFs, Loops, Assignments, etc.</td></tr>
<tr><td>expression_generator</td><td>Generates expressions (everything that <em>possibly</em> resolves to a value) including: call-statements, references, array-access, etc.</td></tr>
</tbody></table>
</div>
<h2 id="generating-pous"><a class="header" href="#generating-pous">Generating POUs</a></h2>
<p>Generating POUs (Programs, Function-Blocks, Functions) must generate the POU's body itself, as well as the POU's interface (or state) variables.
In this segment we focus on generating the interface for a POU.
Further information about generating a POU's body can be found [here].</p>
<h3 id="programs"><a class="header" href="#programs">Programs</a></h3>
<p>A program is <em>static</em> POU with some code attached.
This means that there is exactly one instance. So wherever from it is called, every caller uses the exact same instance which means that you may see the residuals of the laster caller in the program's variables when you call it yourself.</p>
<pre><code class="language-iecst">PROGRAM prg
    VAR
        x : DINT;
        y : DINT;
    END_VAR

END_PROGRAM
</code></pre>
<p>The program's interface is persistent across calls, so we store it in a global variable.
Therefore the code-generator creates a dedicated struct-type called <code>prg_interface</code>.
A global variable called <code>prg_instance</code> is generated to store the program's state across calls.
This global instance variable is passed as a <code>this</code> pointer to calls to the <code>prg</code> function.</p>
<pre><code class="language-llvm">%prg_interface = type { i32, i32 }

@prg_instance = global %prg_interface zeroinitializer

define void @prg(%prg_interface* %this) {
entry:
  ret void
}
</code></pre>
<h3 id="functionblocks"><a class="header" href="#functionblocks">FunctionBlocks</a></h3>
<p>A FunctionBlock is an POU that is instantiated in a declaration.
So in contrast to Programs, a FunctionBlock can have multiple instances.
Nevertheless the code-generator uses a very similar strategy.
A struct-type for the FunctionBlock's interface is created but no global instance-variable is allocated.
Instead the function block can be used as a DataType to declare instances like in the following example:</p>
<pre><code class="language-iecst">FUNCTION_BLOCK foo
  VAR_INPUT
    x, y : INT;
  END_VAR
END_FUNCTION_BLOCK

PROGRAM prg
  VAR
    f : foo;
  END_VAR
END_PROGRAM
</code></pre>
<p>So for the given example, we see the code-generator creating a type for the FunctionBlock's state (<code>foo_interface</code>).
The declared instance of foo, in <code>prg's</code> interface is seen in the program's generated interface struct-type (<code>prg_interface</code>).</p>
<pre><code class="language-llvm">; ModuleID = 'main'
source_filename = "main"

%prg_interface = type { %foo_interface }
%foo_interface = type { i16, i16 }

@prg_instance = global %prg_interface zeroinitializer

define void @foo(%foo_interface* %0) {
entry:
  ret void
}

define void @prg(%prg_interface* %0) {
entry:
  ret void
}
</code></pre>
<h3 id="functions"><a class="header" href="#functions">Functions</a></h3>
<p>Functions generate very similar to programs and function_blocks.
The main difference is, that no instance-global is allocated and the function's interface-type cannot be used as a datatype to declare your own instances.
Instances of the program's interface-type are allocated whenever the function is called for the lifetime of a single call.
Otherwise the code generated for functions is comparable to the code presented above for programs and function-blocks.</p>
<h2 id="generating-data-types"><a class="header" href="#generating-data-types">Generating Data Types</a></h2>
<p>IEC61131-3 languages offer a wide range of data types.
Next to the built-in intrinsic data types, we support following user defined data types:</p>
<h3 id="range-types"><a class="header" href="#range-types">Range Types</a></h3>
<p>For range types we don't generate special code.
Internally the new data type just becomes an alias for the derived type.</p>
<h3 id="pointer-types"><a class="header" href="#pointer-types">Pointer Types</a></h3>
<p>For pointer types we don't generate special code.
Internally the new data type just becomes an alias for the pointer-type.</p>
<h3 id="struct-types"><a class="header" href="#struct-types">Struct Types</a></h3>
<p>Struct types translate direclty to llvm struct datatypes.
We generate a new datatype with the user-type's name for the struct.</p>
<pre><code class="language-iecst">TYPE MyStruct:
  STRUCT
    a: DINT;
    b: INT;
  END_STRUCT
END_TYPE
</code></pre>
<p>This struct simply generates a llvm struct type:</p>
<pre><code class="language-llvm">%MyStruct = type { i32, i16 }
</code></pre>
<h3 id="enum-types"><a class="header" href="#enum-types">Enum Types</a></h3>
<p>Enumerations are represented as <code>DINT</code>.</p>
<pre><code class="language-iecst">TYPE MyEnum: (red, yellow, green);
END_TYPE
</code></pre>
<p>For every enum's element we generate a global variable with the element's value.</p>
<pre><code class="language-llvm">@red = global i32 0
@yellow = global i32 1
@green = global i32 2
</code></pre>
<h3 id="array-types"><a class="header" href="#array-types">Array Types</a></h3>
<p>Array types are generated as fixed sized llvm vector types - note that Array types must be fixed sized in <em>ST</em> :</p>
<pre><code class="language-iecst">TYPE MyArray: ARRAY[0..9] OF INT;
END_TYPE

VAR_GLOBAL
  x : MyArray;
  y : ARRAY[0..5] OF REAL;
END_VAR
</code></pre>
<p>Custom array data types are not reflected as dedicated types on the llvm-level.</p>
<pre><code class="language-llvm">@x = global [10 x i16] zeroinitializer
@y = global [6 x float] zeroinitializer
</code></pre>
<h4 id="multi-dimensional-arrays"><a class="header" href="#multi-dimensional-arrays">Multi dimensional arrays</a></h4>
<p>Arrays can be declared as multi-dimensional:</p>
<pre><code class="language-iecst">VAR_GLOBAL
  x : ARRAY[0..5, 2..5, 0..1] OF INT;
END_VAR
</code></pre>
<p>The compiler will flatten these type of arrays to a single-dimension. To accomplish that, it calculates the total
length by mulitplying the sizes of all dimensions:</p>
<pre><code class="language-ignore">    0..5 x 2..5 x 0..1
      6  x   4  x   2  = 64
</code></pre>
<p>So the array <code>x : ARRAY[0..5, 2..5, 0..1] OF INT;</code> will be generated as:</p>
<pre><code class="language-llvm">@x = global [64 x i16] zeroinitializer
</code></pre>
<p>This means that such a multidimensional array must be initialized like a single-dimensional array:</p>
<ul>
<li><em>wrong</em></li>
</ul>
<pre><code class="language-iecst">VAR_GLOBAL
  wrong_array : ARRAY[1..2, 0..3] OF INT := [ [10, 11, 12],
                                              [20, 21, 22],
                                              [30, 31, 32]];
END_VAR
</code></pre>
<ul>
<li><em>correct</em></li>
</ul>
<pre><code class="language-iecst">VAR_GLOBAL
  correct_array : ARRAY[1..2, 0..3] OF INT := [ 10, 11, 12,
                                                20, 21, 22,
                                                30, 31, 32];
END_VAR
</code></pre>
<blockquote>
<p><em>Nested Arrays</em></p>
<p>Note that arrays declared as <code>x : ARRAY[0..2] OF ARRAY[0..2] OF INT</code> are different from mutli-dimensional
arrays discussed in this section. Nested arrays are represented as multi-dimensional arrays on the LLVM-IR
level and must also be initialized using nested array-literals!</p>
</blockquote>
<h3 id="string-types"><a class="header" href="#string-types">String Types</a></h3>
<p>String types are generated as fixed sized vector types.</p>
<pre><code class="language-iecst">VAR_GLOBAL
    str  : STRING[20];
    wstr : WSTRING[20];
END_VAR
</code></pre>
<p>Strings can be represented in two different encodings: <em>UTF-8 (STRING)</em> or <em>UTF-16 (WSTRING)</em>.</p>
<pre><code class="language-llvm">@str = global [21 x i8] zeroinitializer
@wstr = global [21 x i16] zeroinitializer
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../arch/validation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../cfc/cfc.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../arch/validation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../cfc/cfc.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../iecst.min.js"></script>
        <script src="../llvm.min.js"></script>
        <script src="../custom.js"></script>
        <script src="../highlight.js"></script>



    </div>
    </body>
</html>
